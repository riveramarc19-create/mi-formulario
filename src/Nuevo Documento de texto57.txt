import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Activity, ArrowRight, ArrowLeft, X, Plus, 
  LogOut, Database, Search, Trash2, FileSpreadsheet, Calendar, Edit, Download, Grid, Save, UserPlus, Users, Save as SaveIcon, FileText, AlertTriangle, Calculator, Siren, Baby, RefreshCw, CheckCircle, Droplets, Eye, EyeOff
} from 'lucide-react';

import NutritionalStatusModal from './NutritionalStatusModal';
import AnemiaCalculatorModal from './AnemiaCalculatorModal'; 

// --- IMPORTACIÓN DE DATOS ESTÁTICOS EXTERNOS ---
import { CIE10_LIST } from './Cie10Data';
import { PERSONAL_LIST } from './PersonalData';
// ------------------------------------------------------------------

import * as XLSXStyle from 'xlsx-js-style'; 
const XLSX = XLSXStyle.default || XLSXStyle; 
import { jsPDF } from "jspdf"; 

// --- PARCHE DE SEGURIDAD ---
if (typeof global === 'undefined') { window.global = window; }

// --- LISTA DE LOCALIDADES ---
const LOCALIDADES_ALTITUD = {
    "AGURAN": 1480, "ALFONSO UGARTE": 1708, "ALTAMIZA": 2684, "ALTO EL MILAGRO": 1900, "ALTO MILAGRO": 2413, 
    "ALTO SANTA ROSA": 2072, "ARANZA": 1332, "BELLAVISTA DE CACHIACO": 1758, "BELLAVISTA DE SAN PABLO": 2065, 
    "CALABOZO": 2390, "CAMINO REAL": 2386, "CASCAJAL": 1757, "CERRO PINTADO": 1735, "CHANGRA": 2796, 
    "CHULUCANITAS": 2690, "CORRAL DE PIEDRAS": 1865, "CUMBICUS ALTO": 2421, "CUMBICUS BAJO": 1602, 
    "CURILCAS": 1518, "CURIRCA": 2595, "EL ALGARROBO": 1830, "EL ALUMBRE": 1325, "EL CARMEN": 2098, 
    "EL CARMEN DE CURILCAS": 2070, "EL CEIBO": 1812, "EL HUABO (EL HUABO DE CURILCAS)": 1780, 
    "EL LIMO": 1826, "EL MOLINO": 1871, "EL PALMO": 2193, "EL PUERTO": 1455, "EL SAUCE": 2576, 
    "EL YAMBUR": 2414, "FRANCISCO BOLOGNESI": 2100, "HUACAMUYOS": 2632, "HUALANGA": 1948, 
    "HUARACAS DE MATALACAS": 3030, "LA COFRADIA": 2650, "LA COIPA DE CURILCAS": 1677, "LA CRIA SAN PABLO": 1684, 
    "LA FLORIDA": 2586, "LA HUACA": 2537, "LA LAGUNA": 2190, "LA LAGUNA (2)": 2607, "LA LOMA": 1861, 
    "LA PALMA": 2753, "LA RAMADA DE MALACHE": 2960, "LA UNION DE SAN PABLO": 2096, "LAGUNAS DE SAN PABLO": 2275, 
    "LAQUE MATALACAS": 1992, "LAS GREDAS": 1457, "LAS JUNTAS": 1853, "LAS LOMAS": 3135, "LAS MERCEDES": 3232, 
    "LAS PALMERAS": 1984, "LAS VEGAS DE CURIRCA": 2222, "LECHEROS": 3077, "LETREROS-TUCAQUE": 2512, 
    "LINDEROS CURILCAS": 1569, "LIRIO": 2459, "LIVIN DE CURILCAS (EL ROYO)": 1908, "LIVIN DE SAN PABLO": 1826, 
    "LOS ALISOS": 2541, "LOS CLAVELES DE MALACHE": 2250, "LUCUMO": 2640, "MALACHE": 2770, "MANGAS DE CACHIACO": 2701, 
    "MARAY DE CURILCAS": 1819, "MARAY DE MATALACAS": 2270, "MARAY DE SAN PABLO": 1997, "MEJICO": 2073, 
    "MEMBRILLO": 2768, "MIRAFLORES": 3104, "MORE": 3095, "MUSHCAPAN": 2255, "NANGAY DE MATALACAS": 2071, 
    "NANGAY PAMPA": 1672, "NARANJITO DE MATALACHE": 1180, "NARANJITO RAMADA DE VILCA": 2312, 
    "NARANJO DE CURILCAS": 1754, "NARANJO DE VILCAS": 1503, "NOTA": 2400, "NUEVA ALIANZA": 1686, 
    "NUEVA ESPERANZA": 3267, "NUEVO FLORECER": 3027, "NUEVO PORVENIR": 2100, "NUEVO PROGRESO": 2670, 
    "PACAIPAMPA": 1980, "PAGAY": 2306, "PALO BLANCO": 2806, "PALO BLANCO DE MATALACAS": 2230, 
    "PALOBLANQUITO": 2969, "PALOMAR": 3303, "PAMPAGRANDE": 2460, "PAPELILLO": 1753, "PAPELILLO (2)": 2051, 
    "PAREDONES": 1302, "PATA DE CACHIACO (PAJUL)": 2281, "PEDREGAL DE MATALACAS": 3092, "PEÑA BLANCA": 2350, 
    "PORTACHUELO DE MATALACAS": 2490, "PORVENIR DE MATALACAS": 3285, "PUEBLO NUEVO DE MATALACAS": 1964, 
    "PUMURCO": 2120, "PUR PUR": 2176, "RAMADAS VILCAS": 2270, "RAMON CASTILLA": 2057, "SAN ANDRES DEL FAIQUE": 2130, 
    "SAN FRANCISCO": 1761, "SAN FRANCISCO (2)": 2690, "SAN JOSE DE MATALACAS": 2275, "SAN JUAN DE CACHIACO": 2234, 
    "SAN LAZARO": 1620, "SAN LUIS": 1839, "SAN MARTIN": 2539, "SAN MIGUEL DE MATALACAS": 2838, 
    "SAN MIGUEL DE SAN PABLO": 2081, "SANTA CRUZ": 2840, "SANTA CRUZ DE LA VEGA": 1274, "SANTA FE": 3108, 
    "SANTA MARIA": 2433, "SANTA ROSA": 1218, "TAILIN": 2251, "TAUMA": 2264, "TASAJERAS": 1850, 
    "TIERRA COLORADA": 2517, "TINGOS": 2418, "TOJAS": 1966, "TOTORA": 2582, "TULMAN DE MATALACAS": 1817, 
    "TULMANCITO": 2096, "UNION DE LA CRUZ": 2194, "VEGA DEL PUNTO": 1105, "VILCAS": 1710, "YAMANGITO": 2237, 
    "YUMBE": 2434, "YUMBE DE CHANGRA": 2647, "CACHIACO": 1000 
};

// --- SERVICIO INDEXEDDB ---
const DB_NAME = 'HisDatabase_V1';
const STORE_PACIENTES = 'pacientes';

const idb = {
  open: () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_PACIENTES)) {
          db.createObjectStore(STORE_PACIENTES, { keyPath: 'id', autoIncrement: true });
        }
      };
      request.onsuccess = (event) => resolve(event.target.result);
      request.onerror = (event) => reject(event.target.error);
    });
  },
  savePatients: async (patients) => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readwrite');
      const store = transaction.objectStore(STORE_PACIENTES);
      store.clear(); 
      patients.forEach(p => store.add(p));
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => reject(false);
    });
  },
  getPatients: async () => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readonly');
      const store = transaction.objectStore(STORE_PACIENTES);
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject([]);
    });
  },
  clearPatients: async () => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readwrite');
      const store = transaction.objectStore(STORE_PACIENTES);
      const request = store.clear();
      request.onsuccess = () => resolve(true);
      request.onerror = () => reject(false);
    });
  }
};

const getAgeComponents = (birthDate, attnDate) => {
    if (!birthDate || !attnDate) return { y: '', m: '', d: '' };
    const birth = new Date(birthDate);
    const attn = new Date(attnDate);
    if (isNaN(birth.getTime()) || isNaN(attn.getTime()) || birth > attn) return { y: '-', m: '-', d: '-' };
    let years = attn.getFullYear() - birth.getFullYear();
    let months = attn.getMonth() - birth.getMonth();
    let days = attn.getDate() - birth.getDate();
    if (days < 0) { months--; const prevMonth = new Date(attn.getFullYear(), attn.getMonth(), 0); days += prevMonth.getDate(); }
    if (months < 0) { years--; months += 12; }
    return { y: years, m: months, d: days };
};

// --- COMPONENTE CALENDARIO ---
const SimpleCalendar = ({ selectedDate, onSelectDate, onClose, themeColor }) => {
  const today = new Date();
  const [currentMonth, setCurrentMonth] = useState(new Date(today.getFullYear(), today.getMonth(), 1));
  const year = currentMonth.getFullYear();
  const monthIndex = currentMonth.getMonth();
  const monthName = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][monthIndex];
  const firstDayOfMonth = new Date(year, monthIndex, 1).getDay();
  const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
  const calendarDays = useMemo(() => {
    const days = [];
    for (let i = 0; i < (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(i);
    return days;
  }, [year, monthIndex, daysInMonth, firstDayOfMonth]);
  const handlePrevMonth = () => setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
  const handleNextMonth = () => setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
  const handleDayClick = (day) => { if (day) { const date = new Date(year, monthIndex, day); const offset = date.getTimezoneOffset(); const safeDate = new Date(date.getTime() - (offset*60*1000)); onSelectDate(safeDate.toISOString().split('T')[0]); onClose(); } };
  const selectedDateStr = selectedDate || today.toISOString().split('T')[0];
  const isDaySelected = (day) => day && new Date(year, monthIndex, day).toISOString().split('T')[0] === selectedDateStr;
  const isDayToday = (day) => day && new Date(year, monthIndex, day).toISOString().split('T')[0] === today.toISOString().split('T')[0];
  const primaryColorClass = `bg-${themeColor}-600 hover:bg-${themeColor}-700 text-white`;
  const todayColorClass = `border-${themeColor}-500 text-${themeColor}-600 bg-${themeColor}-50`;
  return (
    <div className="w-full max-w-xs mx-auto">
      <div className="p-4 bg-white rounded-xl shadow-2xl border border-slate-100 w-full animate-in zoom-in duration-300">
        <div className="bg-red-50 border border-red-200 rounded-lg p-2 mb-3 text-center animate-pulse"><span className="text-red-600 font-extrabold text-xs uppercase block">⚠️ Seleccione Fecha de Atención</span></div>
        <div className="flex justify-between items-center mb-4"><button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-slate-100 text-slate-500"><ArrowLeft size={16} /></button><h4 className="font-bold text-slate-800 text-base">{monthName} {year}</h4><button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-slate-100 text-slate-500"><ArrowRight size={16} /></button></div>
        <div className="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-400 mb-2"><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
        <div className="grid grid-cols-7 gap-1">{calendarDays.map((day, index) => (<div key={index} className="aspect-square">{day ? (<button onClick={() => handleDayClick(day)} className={`w-full h-full rounded-full flex items-center justify-center text-sm font-medium transition-all ${isDaySelected(day) ? primaryColorClass + ' shadow-md' : isDayToday(day) ? todayColorClass + ' border-2' : 'text-slate-700 hover:bg-slate-100'}`}>{day}</button>) : <div />}</div>))}</div>
      </div>
      <button onClick={onClose} className={`w-full mt-4 py-2 rounded-xl text-sm font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors`}>Cerrar</button>
    </div>
  );
};

export default function App() {
  const [showNutriModal, setShowNutriModal] = useState(false);
  const [showAnemiaModal, setShowAnemiaModal] = useState(false);
  const [isCalendarOpen, setIsCalendarOpen] = useState(false);
  const calendarRef = useRef(null);
  const handleDateSelect = (date) => setPatientData(prev => ({ ...prev, fecAtencion: date }));

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (isCalendarOpen && calendarRef.current && !calendarRef.current.contains(event.target) && event.target.tagName !== 'BUTTON') setIsCalendarOpen(false);
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isCalendarOpen]);

  const stepColors = ['blue', 'emerald', 'indigo', 'amber'];
  const getTheme = (s) => { const color = stepColors[s-1] || 'slate'; return { border: `border-${color}-200`, focusBorder: `focus:border-${color}-500`, focusRing: `focus:ring-${color}-100`, text: `text-${color}-800`, labelText: `text-${color}-600`, bgHover: `hover:bg-${color}-50`, bgLight: `bg-${color}-50/50` }; };
  const baseInputStyle = "w-full h-9 px-3 border-2 rounded-xl bg-white font-bold outline-none transition-all shadow-sm text-sm";
  const dateInputStyle = "relative w-full h-9 px-3 py-1 border-2 rounded-xl bg-white font-bold outline-none transition-all shadow-sm text-sm cursor-pointer";
  const getInputStyle = (s) => `${baseInputStyle} ${getTheme(s).border} ${getTheme(s).text} ${getTheme(s).focusBorder} focus:ring-4 ${getTheme(s).focusRing} hover:border-opacity-80`;
  
  const getSelectStyle = (value, hasError = false) => {
    const baseStyle = getInputStyle(1);
    if (value === "" || hasError) return `${baseStyle.replace(getTheme(1).border, 'border-red-500').replace(getTheme(1).focusBorder, 'focus:border-red-600')} bg-red-50 text-red-900 animate-pulse`;
    return `${baseStyle.replace(getTheme(1).border, 'border-emerald-500').replace(getTheme(1).focusBorder, 'focus:border-emerald-600')} bg-emerald-50 text-emerald-900 font-black`;
  };

  const getLockedInputStyle = (s) => `${baseInputStyle} ${getTheme(s).border} ${getTheme(s).text} border-slate-200 bg-slate-50 cursor-default shadow-inner`;
  const getDateInputStyle = (s) => `${dateInputStyle} ${getTheme(s).border} ${getTheme(s).text} ${getTheme(s).focusBorder} focus:ring-4 ${getTheme(s).focusRing} hover:border-opacity-80`;
  const getLockedDateInputStyle = (s) => `${dateInputStyle} ${getTheme(s).border} ${getTheme(s).text} border-slate-200 bg-slate-50 cursor-default shadow-inner`;
  const getLabelStyle = (s) => `block text-[10px] font-bold uppercase ml-2 mb-0.5 ${getTheme(s).labelText}`; 
  const borderlessInputStyle = "w-full h-9 px-3 rounded-xl bg-slate-50 font-bold outline-none text-sm text-slate-800 transition-all focus:bg-white focus:ring-2 focus:ring-emerald-100 shadow-sm";

  const MESES = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SETIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
  const ESTABLECIMIENTOS = ["PACAIPAMPA", "EL PUERTO", "LAGUNAS S.P", "CUMBICUS", "CACHIACO"];
  const UPS_LIST = ["MEDICINA", "ENFERMERIA", "OBSTETRICIA", "NUTRICION", "ODONTOLOGIA", "PSICOLOGIA"];
  
  const [dbPacientes, setDbPacientes] = useState([]);
  
  // DATOS IMPORTADOS
  const [dbCie10, setDbCie10] = useState(CIE10_LIST); 
  const [dbPersonal, setDbPersonal] = useState(PERSONAL_LIST); 
  const [dbStatus, setDbStatus] = useState('loading'); 
// =========================================================
  // PEGAR ESTO JUSTO DEBAJO DE "const [dbStatus, setDbStatus]..."
  // =========================================================

  // --- NUEVOS ESTADOS PARA LOGIN ---
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loginDni, setLoginDni] = useState("");
  const [loginPass, setLoginPass] = useState("");
  const [showPassword, setShowPassword] = useState(false); // <--- AGREGA ESTO
  const [loginError, setLoginError] = useState("");

  // --- FUNCIÓN DE LOGIN ---
  const handleLogin = (e) => {
    e.preventDefault();
    
    // 1. Buscar usuario en tu lista de personal cargada
    const user = dbPersonal.find(u => u.dni === loginDni);

    // 2. Validar credenciales (DNI y la contraseña del JSON)
    if (user && user.password === loginPass) {
        setIsAuthenticated(true);
        setLoginError("");

        // 3. COPIAR DNI AL CAMPO DE CONFIGURACIÓN AUTOMÁTICAMENTE
        // (Esto busca la variable setAdminData que está más abajo en tu código)
        if (typeof setAdminData === 'function') {
            setAdminData(prev => ({
                ...prev,
                dniResp: user.dni,
                nombreResp: user.nombre
            }));
        }
    } else {
        setLoginError("Credenciales incorrectas o usuario no encontrado");
    }
  };
  // =========================================================

  // --- ESTADO PARA LA ALERTA DE VALIDACIÓN ---
  const [validationAlert, setValidationAlert] = useState({ isOpen: false, type: '', title: '', message: '', details: '' });

  const [searchTerm, setSearchTerm] = useState("");
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const searchRef = useRef(null);
  const [isPatientDataLocked, setIsPatientDataLocked] = useState(false); 

  const [isDxModalOpen, setIsDxModalOpen] = useState(false);
  const [currentDxRow, setCurrentDxRow] = useState(0); 
  const [modalSearchTerm, setModalSearchTerm] = useState("");
  const [modalSuggestions, setModalSuggestions] = useState([]);
  const [tempDx, setTempDx] = useState({ desc: '', tipo: 'D', lab1: '', lab2: '', lab3: '', codigo: '' });

  const [dxSuggestions, setDxSuggestions] = useState([]);
  const [activeDxIndex, setActiveDxIndex] = useState(null);
  const [activeDxField, setActiveDxField] = useState(null);
  
  const dxListRef = useRef(null);
  const dxBottomRef = useRef(null); 
  const tipoRefs = useRef([]);
  const [dxErrors, setDxErrors] = useState({});

  const [isManualModalOpen, setIsManualModalOpen] = useState(false);
  const [manualData, setManualData] = useState({ dni: '', nombres: '', fecNac: '2000-01-01', sexo: 'M', hc: '', distrito: '', direccion: '', financiador: 'SIS', estOrigen: '' });

  const [showJurisdictionModal, setShowJurisdictionModal] = useState(false);
  const [jurisdictionErrorMsg, setJurisdictionErrorMsg] = useState("");
  const [showAdolescentModal, setShowAdolescentModal] = useState(false);

  const [anemiaLocation, setAnemiaLocation] = useState("");
  const [anemiaResult, setAnemiaResult] = useState("");
  const [anemiaColor, setAnemiaColor] = useState("bg-slate-200 text-slate-500");
  const [hbAdjusted, setHbAdjusted] = useState(null);
  const [isPremature, setIsPremature] = useState(false);

  const [adminData, setAdminData] = useState({ anio: '2025', mes: 'ENERO', establecimiento: 'PACAIPAMPA', turno: 'MAÑANA', ups: 'MEDICINA', dniResp: '', nombreResp: '', isConfigured: false });

  const initialPatient = { dni: '', paciente: '', hc: '', fecNac: '', sexo: '', financiador: '', direccion: '', distrito: '', estAtencion: 'PACAIPAMPA', fecAtencion: '', condicion: '', fur: '', estOrigen: '', condEst: '', condServ: '' };
  const [patientData, setPatientData] = useState(initialPatient);
  const [savedPatients, setSavedPatients] = useState([]);

  const ageString = useMemo(() => { const { y, m, d } = getAgeComponents(patientData.fecNac, patientData.fecAtencion); return `${y}A ${m}M ${d}D`; }, [patientData.fecNac, patientData.fecAtencion]);
  const ageObj = useMemo(() => { return getAgeComponents(patientData.fecNac, patientData.fecAtencion); }, [patientData.fecNac, patientData.fecAtencion]);
  const ageInMonths = useMemo(() => { if (typeof ageObj.y === 'number' && typeof ageObj.m === 'number') { return (ageObj.y * 12) + ageObj.m; } return ''; }, [ageObj]);

  const initialClinical = { peso: '', talla: '', pAbd: '', pCef: '', imc: '', hb: '', dosaje: '', estNut: '', nivHb: '', riesgo: ' ', pPreGest: '' };
  const [clinicalData, setClinicalData] = useState(initialClinical);

  const [diagnoses, setDiagnoses] = useState([{ desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [step, setStep] = useState(1);

  // --- CARGA DE BD ---
  useEffect(() => {
    const initDB = async () => {
        try {
            const patients = await idb.getPatients();
            if (patients && patients.length > 0) {
                setDbPacientes(patients);
                setDbStatus('ready');
            } else {
                setDbStatus('empty');
            }
        } catch (e) {
            console.error("Error cargando BD", e);
            setDbStatus('empty');
        }
    };
    initDB();
  }, []);

  const clearDatabase = async () => {
      if(window.confirm("¿Estás seguro de que deseas borrar la base de datos de pacientes local? Tendrás que subir el archivo nuevamente.")) {
          await idb.clearPatients();
          setDbPacientes([]);
          setDbStatus('empty');
          alert("Base de datos limpiada.");
      }
  };

  const isInvalidCombo = useMemo(() => {
        const { condEst, condServ } = patientData;
        if (!condEst || !condServ) return false;
        if ( (condEst === 'R' && condServ === 'C') || (condEst === 'N' && condServ === 'C') || (condEst === 'N' && condServ === 'R') ) return true;
        return false;
  }, [patientData.condEst, patientData.condServ]);

  useEffect(() => {
    const p = parseFloat(clinicalData.peso); const t = parseFloat(clinicalData.talla);
    if (p > 0 && t > 0) { const t_m = t / 100; setClinicalData(prev => ({ ...prev, imc: (p / (t_m * t_m)).toFixed(2) })); }
  }, [clinicalData.peso, clinicalData.talla]);

  useEffect(() => { if (patientData.condicion !== 'GESTANTE') setPatientData(prev => ({...prev, fur: ''})); }, [patientData.condicion]);
  useEffect(() => { if (adminData.isConfigured) setPatientData(prev => ({...prev, estAtencion: adminData.establecimiento})); }, [adminData.isConfigured, adminData.establecimiento]);

  useEffect(() => { setAnemiaResult(""); setAnemiaColor("bg-slate-200 text-slate-500"); setHbAdjusted(null); }, [patientData.dni]);

  const handleFileUpload = (e, type) => {
    try {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const wb = XLSX.read(evt.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });

          if (type === 'pacientes') {
            const procesados = rawData.slice(1).map(r => {
                if (!r[0] && !r[1]) return null;
                const historyRange = [];
                for(let i=9; i<=20; i++) { if(r[i]) historyRange.push(String(r[i]).trim().toUpperCase()); }
                return {
                    dni: r[0] ? String(r[0]).trim().padStart(8, '0') : "", 
                    nombre: r[1] ? String(r[1]).trim() : "", 
                    fecNac: r[2], 
                    sexo: r[3] ? String(r[3]).trim() : "M", 
                    financiador: r[4] ? String(r[4]).trim() : "SIS", 
                    hc: r[5] ? String(r[5]).trim() : "", 
                    distrito: r[6] ? String(r[6]).trim() : "", 
                    direccion: r[7] ? String(r[7]).trim() : "", 
                    estOrigen: r[8] ? String(r[8]).trim() : "", 
                    historialEst: historyRange,
                    busqueda: ((r[0] ? String(r[0]).trim().padStart(8, '0') : "") + " " + String(r[1]||"")).toUpperCase()
                };
            }).filter(p => p !== null);
            
            await idb.savePatients(procesados);
            setDbPacientes(procesados);
            setDbStatus('ready');
            alert(`✅ ${procesados.length} pacientes guardados en la Base de Datos Local.`);

          } else if (type === 'cie10') {
            const procesados = rawData.slice(1).map(r => ({ CODIGO: r[0] ? String(r[0]).trim() : "", DESCRIPCION: r[1] ? String(r[1]).trim() : "", BUSQUEDA: (String(r[0]||"") + " " + String(r[1]||"")).toUpperCase() })).filter(d => d.CODIGO);
            setDbCie10(procesados);
            alert(`✅ ${procesados.length} diagnósticos cargados.`);
          } else if (type === 'personal') {
            const procesados = rawData.slice(1).map(r => ({ dni: r[0] ? String(r[0]).trim() : "", nombre: r[1] ? String(r[1]).trim() : "" })).filter(p => p.dni);
            setDbPersonal(procesados);
            alert(`✅ ${procesados.length} personal cargado.`);
          }
        } catch (err) { alert("Error leyendo el archivo: " + err.message); }
      };
      reader.readAsBinaryString(file);
    } catch (error) { alert("Error subiendo el archivo: " + error.message); }
  };

  const handleSearchInput = (e) => {
      const val = e.target.value.toUpperCase();
      setSearchTerm(val);
      if (val === "") {
          setPatientData(initialPatient); 
          setClinicalData(initialClinical);
          setDiagnoses([{ desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]);
          setIsPatientDataLocked(false);
          setSuggestions([]);
          setShowSuggestions(false);
          return;
      }
      if (val.length > 1 && dbPacientes.length > 0) {
        setSuggestions(dbPacientes.filter(p => p.busqueda.includes(val)).slice(0, 10));
        setShowSuggestions(true);
      } else { setSuggestions([]); setShowSuggestions(false); }
  };

  const parseExcelDate = (d) => {
    if (!d) return '2000-01-01';
    try {
      if (typeof d === 'number') { const date = new Date(Math.round((d - 25569)*86400*1000)); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); return !isNaN(date.getTime()) ? date.toISOString().split('T')[0] : '2000-01-01'; }
      if (typeof d === 'string') { if(d.includes('/')) { const p = d.split('/'); if (p.length === 3) return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; } if(d.includes('-') && !isNaN(Date.parse(d))) return d; }
    } catch (e) { return '2000-01-01'; }
    return '2000-01-01'; 
  };

  const cleanStr = (str) => { if (!str) return ""; return str.replace(/[^A-Z0-9]/g, ''); };

  const selectPatient = (p) => {
      setShowSuggestions(false); setSuggestions([]); 
      let estConfigRaw = adminData.establecimiento.trim().toUpperCase();
      let estPatientRaw = p.estOrigen ? p.estOrigen.trim().toUpperCase() : "";

      let keywordConfig = estConfigRaw;
      if(estConfigRaw.includes("LAGUNAS")) keywordConfig = "LAGUNAS";
      if(estConfigRaw.includes("PUERTO")) keywordConfig = "PUERTO";
      if(estConfigRaw.includes("CUMBICUS")) keywordConfig = "CUMBICUS";
      if(estConfigRaw.includes("CACHIACO")) keywordConfig = "CACHIACO";
      if(estConfigRaw.includes("PACAIPAMPA")) keywordConfig = "PACAIPAMPA";

      const cleanConfig = cleanStr(keywordConfig);
      const cleanPatient = cleanStr(estPatientRaw);
      const match = cleanPatient.includes(cleanConfig) || cleanConfig.includes(cleanPatient);

      if (!match) {
          setJurisdictionErrorMsg(`El paciente seleccionado pertenece a: "${p.estOrigen || 'DESCONOCIDO'}"\nPero usted está registrando en: "${adminData.establecimiento}"`);
          setShowJurisdictionModal(true); return; 
      }

      setSearchTerm(p.nombre || "");
      const safeFecNac = parseExcelDate(p.fecNac);

      const currentAgeObj = getAgeComponents(safeFecNac, patientData.fecAtencion);
      if (currentAgeObj.y >= 12 && currentAgeObj.y <= 17) {
          setShowAdolescentModal(true);
      }

      const esContinuador = p.historialEst.some(historialItem => { const itemLimpio = cleanStr(historialItem); return itemLimpio.includes(cleanConfig); });
      const condicionCalculada = esContinuador ? "C" : "R";

      setTimeout(() => { 
          setPatientData(prev => ({ ...prev, dni: p.dni || "", paciente: p.nombre || "", hc: p.hc || "", fecNac: safeFecNac, sexo: p.sexo || 'M', financiador: p.financiador || 'SIS', direccion: p.direccion || '', distrito: p.distrito || '', estOrigen: p.estOrigen || '', condEst: condicionCalculada })); 
          setIsPatientDataLocked(true); 
      }, 10);
  };

  const checkRowValidity = (row) => { return (row.desc && row.desc.trim() !== '' && row.tipo && row.tipo !== '-' && row.tipo !== '' && row.codigo && row.codigo.trim() !== ''); };
  const openDxSearch = (index) => { setCurrentDxRow(index); const existing = diagnoses[index]; setTempDx({ desc: existing.desc || '', codigo: existing.codigo || '', tipo: (existing.tipo && existing.tipo !== '-') ? existing.tipo : 'D', lab1: existing.lab1 || '', lab2: existing.lab2 || '', lab3: existing.lab3 || '' }); setModalSearchTerm(""); setModalSuggestions([]); setIsDxModalOpen(true); };
  
  const handleModalSearch = (val) => { 
    setModalSearchTerm(val); 
    const upperVal = val.toUpperCase(); 
    setTempDx(prev => ({ ...prev, desc: upperVal })); 
    
    if (upperVal.length > 1) { 
        const matches = dbCie10.filter(item => {
            if (item.BUSQUEDA && item.BUSQUEDA.includes(upperVal)) return true;
            if (item.CODIGO && String(item.CODIGO).includes(upperVal)) return true;
            if (item.DESCRIPCION && item.DESCRIPCION.includes(upperVal)) return true;
            return false;
        }).slice(0, 20); 
        setModalSuggestions(matches); 
    } else { 
        setModalSuggestions([]); 
    } 
  };

  const selectModalDx = (item) => { 
      setTempDx(prev => ({ 
          ...prev, 
          desc: item.DESCRIPCION, 
          codigo: item.CODIGO,
          lab1: item.LAB1 || '', 
          lab2: item.LAB2 || '',
          tipo: item.TIPO || prev.tipo || 'D'
      })); 
      setModalSearchTerm(item.DESCRIPCION); 
      setModalSuggestions([]); 
  };

  const saveModalSelection = () => { if (!tempDx.desc || !tempDx.codigo) { alert("Debe seleccionar un diagnóstico válido."); return; } const newDiagnoses = [...diagnoses]; newDiagnoses[currentDxRow] = { ...tempDx }; setDiagnoses(newDiagnoses); if (dxErrors[currentDxRow]) { const newErrors = { ...dxErrors }; delete newErrors[currentDxRow]; setDxErrors(newErrors); } setIsDxModalOpen(false); };
  const handleAdmin = (e) => { const name = e.target.name; const val = e.target.value; if (name === 'dniResp') { const encontrado = dbPersonal.find(p => p.dni === val.trim()); if (encontrado) { setAdminData(prev => ({ ...prev, dniResp: val, nombreResp: encontrado.nombre })); } else { setAdminData(prev => ({ ...prev, dniResp: val })); } } else { setAdminData({ ...adminData, [name]: val }); } };
  
  const handlePatient = (e) => {
      const { name, value } = e.target;
      let finalValue = value;
      if (name === "condicion" && value === "GESTANTE") {
          const isFemale = patientData.sexo === "F";
          const currentAge = getAgeComponents(patientData.fecNac, patientData.fecAtencion).y;
          if (!isFemale) { alert("Error: Solo pacientes de sexo FEMENINO pueden ser registradas como GESTANTE."); return; }
          if (currentAge < 11 || currentAge > 48) { alert(`Error de Validación: La paciente tiene ${currentAge} años.\n\nPara registrar la condición de GESTANTE, la edad debe estar entre 11 y 48 años.`); return; }
      }
      if (['direccion', 'distrito', 'estOrigen'].includes(name)) { finalValue = value.toUpperCase(); }
      setPatientData({ ...patientData, [name]: finalValue });
  };

  const handleClinical = (e) => setClinicalData({ ...clinicalData, [e.target.name]: e.target.value });
  
  const handleNumericInput = (e, min, max) => {
      let val = e.target.value;
      if (val === '') { setClinicalData({ ...clinicalData, [e.target.name]: '' }); return; }
      if (!/^\d*\.?\d*$/.test(val)) return;
      const numVal = parseFloat(val);
      if (!isNaN(numVal)) { if (numVal > max) return; }
      setClinicalData({ ...clinicalData, [e.target.name]: val });
  };

  const handleSaveManualPatient = () => { if(!manualData.dni || !manualData.nombres) return alert("Debe completar al menos DNI y Nombres"); setPatientData(prev => ({ ...prev, dni: manualData.dni, paciente: manualData.nombres.toUpperCase(), hc: manualData.hc, fecNac: manualData.fecNac, sexo: manualData.sexo, financiador: manualData.financiador, direccion: manualData.direccion.toUpperCase(), distrito: manualData.distrito.toUpperCase(), estOrigen: manualData.estOrigen.toUpperCase(), condEst: 'N', condServ: 'N' })); setSearchTerm(manualData.nombres.toUpperCase()); setIsPatientDataLocked(true); setIsManualModalOpen(false); setManualData({ dni: '', nombres: '', fecNac: '2000-01-01', sexo: 'M', hc: '', distrito: '', direccion: '', financiador: 'SIS', estOrigen: '' }); };
  
  const calculateAnemiaSimple = () => { 
      if (!clinicalData.hb || !anemiaLocation) return alert("Ingrese HB y seleccione localidad"); 
      const hb = parseFloat(clinicalData.hb); 
      const altitud = LOCALIDADES_ALTITUD[anemiaLocation] || 0; 
      let factorAjuste = 0; 
      if (altitud >= 1000) { const valor = (altitud * 0.00328); const ajusteCalc = -0.032 * valor + 0.022 * (valor * valor); factorAjuste = Math.round(ajusteCalc * 10) / 10; if(factorAjuste < 0) factorAjuste = 0; } 
      const realHb = hb - factorAjuste; 
      setHbAdjusted(realHb.toFixed(1)); 
      
      let result = "SIN ANEMIA"; 
      let color = "bg-green-100 text-green-700 border-green-200"; 

      const { y, m } = ageObj; 
      const months = (y * 12) + m; 
      const isPregnant = patientData.condicion === "GESTANTE"; 
      const isPuerpera = patientData.condicion === "PUERPERA"; 
      const isMale = patientData.sexo === "M"; 

      if (isPremature && months < 6) { if (realHb < 11.0) { result = "ANEMIA (PREMATURO)"; color = "bg-purple-100 text-purple-700 border-purple-200"; } }
      else if (months >= 6 && months <= 59) { if (realHb < 7.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 7.0 && realHb <= 9.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 10.0 && realHb <= 10.9) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } } 
      else if (months >= 60 && months <= 131) { if (realHb < 8.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.4) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } } 
      else if (months >= 144 && months <= 179) { if (realHb < 8.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.9) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } } 
      else if (months >= 180) { if (isMale) { if (realHb < 8.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 12.9) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } } else if (!isPregnant && !isPuerpera) { if (realHb < 8.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.9) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } } } 
      if (isPregnant) { if (realHb < 7.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 7.0 && realHb <= 9.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 10.0 && realHb <= 10.9) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } else { result = "SIN ANEMIA"; color = "bg-green-100 text-green-700 border-green-200"; } } 
      if (isPuerpera) { if (realHb < 8.0) { result = "ANEMIA SEVERA"; color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA"; color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.9) { result = "ANEMIA LEVE"; color = "bg-yellow-400 text-black"; } else { result = "SIN ANEMIA"; color = "bg-green-100 text-green-700 border-green-200"; } } 
      
      setAnemiaResult(result); 
      setAnemiaColor(color); 
      setClinicalData(prev => ({...prev, nivHb: result, dosaje: realHb.toFixed(1)})); 
  };

  const addDx = () => { setDiagnoses([...diagnoses, { desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]); setTimeout(() => { if (dxBottomRef.current) { dxBottomRef.current.scrollIntoView({ behavior: 'smooth' }); } }, 100); };
  const removeDx = (i) => setDiagnoses(diagnoses.filter((_, idx) => idx !== i));

  // --- NUEVA FUNCIÓN DE VALIDACIÓN DE DIAGNÓSTICOS (HIS 1.12) ---
  const validateDiagnoses = () => {
    for (let i = 0; i < diagnoses.length; i++) {
        const d = diagnoses[i];
        if(!d.codigo) continue; 
        const code = d.codigo.trim().toUpperCase();

        // 1. Validación Anemia D509
        if (code === 'D509') {
            const validLabs = ['LEV', 'MOD', 'SEV'];
            if (!validLabs.includes(d.lab1)) {
                setValidationAlert({
                    isOpen: true,
                    type: 'ANEMIA',
                    title: 'Validación de Anemia (D509)',
                    message: `En la fila ${i + 1}, el diagnóstico ANEMIA (D509) requiere especificar la severidad en el campo LAB 1.`,
                    details: 'Valores permitidos: LEV, MOD o SEV.'
                });
                return false;
            }
        }

        // 2. Validación Gestantes (Z3591, Z3592, Z3593)
        if (['Z3591', 'Z3592', 'Z3593'].includes(code)) {
            if (!d.lab1 || !d.lab2) {
                 setValidationAlert({
                    isOpen: true,
                    type: 'GESTANTE',
                    title: 'Supervisión de Embarazo (Riesgo)',
                    message: `En la fila ${i + 1}, el código ${code} requiere completar ambos campos de laboratorio.`,
                    details: 'LAB 1: Número de Control Prenatal\nLAB 2: Semanas de Gestación'
                });
                return false;
            }
        }
    }
    return true;
  };
  
  const handleNextStep = () => { 
      if (step === 1) { 
          // --- NUEVA LÓGICA: VALIDACIÓN CONDICIONAL (HIS 1.18) ---
          // Solo validar si se ha seleccionado un paciente (nombre no vacío)
          if (patientData.paciente && patientData.paciente.trim() !== "") {
              if (!patientData.fecAtencion) { alert("¡ATENCIÓN! DEBE INGRESAR LA FECHA DE ATENCIÓN."); return; } 
              if (!patientData.condEst || !patientData.condServ) { alert("ERROR: DEBE SELECCIONAR LA CONDICIÓN DE ESTABLECIMIENTO Y SERVICIO."); return; } 
              const { condEst, condServ } = patientData; 
              if ( (condEst === 'R' && condServ === 'C') || (condEst === 'N' && condServ === 'C') || (condEst === 'N' && condServ === 'R') ) { alert("COMBINACIÓN IMPOSIBLE EN CONDICIÓN DEL PACIENTE."); return; } 
              if (patientData.condicion === 'GESTANTE' && !patientData.fur) { alert("¡ATENCIÓN!\n\nHa seleccionado que la paciente es GESTANTE.\nDebe ingresar obligatoriamente la Fecha de Última Regla (FUR) para continuar."); return; }
          }
          // Si no hay paciente, pasa directamente sin validar nada
      } 
      if (step === 3) { 
          const newErrors = {}; let hasError = false; 
          diagnoses.forEach((d, i) => { if (!checkRowValidity(d)) { newErrors[i] = true; hasError = true; } }); 
          setDxErrors(newErrors); 
          if (hasError) { alert("ERROR: Complete todos los diagnósticos o elimine las filas vacías."); return; } 

          // --- LLAMADA A LA NUEVA VALIDACIÓN ---
          if (!validateDiagnoses()) return; // Si falla, detiene el avance
          // ------------------------------------
      } 
      setStep(s => s + 1); 
  };
  
  const handleBack = () => { setDxErrors({}); setStep(s => s - 1); };
  
  const resetForm = () => { 
      setPatientData({ ...initialPatient, fecAtencion: '', estAtencion: adminData.establecimiento, condEst: '', condServ: '' }); 
      setClinicalData(initialClinical); 
      setDiagnoses([{ desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]); 
      setSearchTerm(""); 
      setIsPatientDataLocked(false); 
      setDxErrors({}); 
      setAnemiaResult("");
      setIsPremature(false); 
  };

  const handleSavePatient = () => { if (window.confirm("¿Desea guardar la información de este paciente en la lista?")) { const patientRecord = { patient: { ...patientData }, clinical: { ...clinicalData }, diagnoses: [...diagnoses], ageObj: { ...ageObj } }; setSavedPatients([...savedPatients, patientRecord]); resetForm(); alert("Paciente guardado. Puede agregar otro o exportar el Excel."); } };

  const generatePDF = () => {
    try {
        const allPatients = [...savedPatients];
        if (patientData.paciente) { allPatients.push({ patient: patientData, clinical: clinicalData, diagnoses: diagnoses, ageObj: ageObj }); }
        if(allPatients.length === 0) return alert("No hay datos para exportar.");
        const doc = new jsPDF('p', 'mm', 'a4'); 
        const mx = 5; const my = 5; const width = 200; 
        const cols = { dia: 6, dni: 18, fin: 6, dist: 26, edad: 8, sex: 6, antro: 14, hb: 10, desc: 68, tipo: 6, lab: 12, cie: 12 };
        const hHeader = 4; const hRow = 4.5;
        let y = my;
        const cell = (txt, x, y, w, h, styles = {}) => {
            const { fill, bold, align, fontSize, border } = styles;
            if (fill) { doc.setFillColor(fill[0], fill[1], fill[2]); doc.rect(x, y, w, h, 'FD'); } else if (border !== false) { doc.rect(x, y, w, h); }
            if (txt) { doc.setTextColor(0,0,0); doc.setFontSize(fontSize || 6); doc.setFont("helvetica", bold ? "bold" : "normal"); let text = String(txt); if (doc.getTextWidth(text) > w - 1) { text = text.substring(0, Math.floor(w / 1.5)) + ".."; } const txtWidth = doc.getTextWidth(text); const xPos = align === 'left' ? x + 1 : x + (w / 2) - (txtWidth / 2); const yPos = y + (h / 2) + 1; doc.text(text, xPos, yPos); }
        };
        const drawHeader = () => {
            y = my; doc.setFontSize(8); doc.setFont("helvetica", "bold"); doc.text("MINISTERIO DE SALUD", 105, y + 3, { align: "center" }); doc.setFontSize(6); doc.text("OFICINA GENERAL DE ESTADÍSTICA E INFORMÁTICA", 105, y + 6, { align: "center" }); doc.text("REGISTRO DIARIO DE ATENCIÓN Y OTRAS ACTIVIDADES DE SALUD", 105, y + 9, { align: "center" }); y += 12;
            const row1Y = y; cell("AÑO", mx, row1Y, 10, hHeader, {bold:true}); cell("MES", mx+10, row1Y, 20, hHeader, {bold:true}); cell("ESTABLECIMIENTO DE SALUD", mx+30, row1Y, 50, hHeader, {bold:true}); cell("UNIDAD PRODUCTORA (UPS)", mx+80, row1Y, 35, hHeader, {bold:true}); cell("DNI RESP.", mx+115, row1Y, 20, hHeader, {bold:true}); cell("RESPONSABLE DE LAS ATENCIONES", mx+135, row1Y, 45, hHeader, {bold:true}); cell("TURNO", mx+180, row1Y, 20, hHeader, {bold:true}); y += hHeader;
            cell(adminData.anio, mx, y, 10, hHeader, {align:'center'}); cell(adminData.mes, mx+10, y, 20, hHeader, {align:'center'}); cell(adminData.establecimiento, mx+30, y, 50, hHeader, {align:'center'}); cell(adminData.ups, mx+80, y, 35, hHeader, {align:'center'}); cell(adminData.dniResp, mx+115, y, 20, hHeader, {align:'center'}); cell(adminData.nombreResp, mx+135, y, 45, hHeader, {align:'center'}); cell(adminData.turno, mx+180, y, 20, hHeader, {align:'center'}); y += hHeader + 2;
            const bgHead = [220, 220, 220]; let cx = mx; const hTable = 6; cell("DIA", cx, y, cols.dia, hTable, {fill:bgHead, bold:true}); cx+=cols.dia; cell("D.N.I / H.C.", cx, y, cols.dni, hTable, {fill:bgHead, bold:true}); cx+=cols.dni; cell("FIN", cx, y, cols.fin, hTable, {fill:bgHead, bold:true}); cx+=cols.fin; cell("DISTRITO DE PROCEDENCIA", cx, y, cols.dist, hTable, {fill:bgHead, bold:true}); cx+=cols.dist; cell("EDAD", cx, y, cols.edad, hTable, {fill:bgHead, bold:true}); cx+=cols.edad; cell("SEX", cx, y, cols.sex, hTable, {fill:bgHead, bold:true}); cx+=cols.sex; cell("ANTROPOMETRÍA", cx, y, cols.antro, hTable, {fill:bgHead, bold:true}); cx+=cols.antro; cell("HB/P", cx, y, cols.hb, hTable, {fill:bgHead, bold:true}); cx+=cols.hb; cell("DIAGNÓSTICO MOTIVO DE CONSULTA", cx, y, cols.desc, hTable, {fill:bgHead, bold:true}); cx+=cols.desc; cell("TIPO", cx, y, cols.tipo, hTable, {fill:bgHead, bold:true}); cx+=cols.tipo; cell("LAB", cx, y, cols.lab, hTable, {fill:bgHead, bold:true}); cx+=cols.lab; cell("CÓDIGO", cx, y, cols.cie, hTable, {fill:bgHead, bold:true}); cx+=cols.cie; y += hTable;
        };
        drawHeader();
        allPatients.forEach(rec => {
            const { patient, clinical, diagnoses: dxs, ageObj: age } = rec; const chunks = Math.ceil(Math.max(1, dxs.length) / 3);
            for (let c = 0; c < chunks; c++) {
                if (y > 270) { doc.addPage(); drawHeader(); }
                const chunkStart = c * 3; const chunkDxs = dxs.slice(chunkStart, chunkStart + 3); while(chunkDxs.length < 3) chunkDxs.push({});
                const bgName = [225, 245, 254]; const rowHeightName = hRow; cell("", mx, y, cols.dia, rowHeightName, {}); let nameText = c === 0 ? `${patient.paciente}   (F.N: ${patient.fecNac})` : ""; cell(nameText, mx + cols.dia, y, width - cols.dia, rowHeightName, {fill: bgName, bold: true, align: 'left', fontSize: 7}); y += rowHeightName;
                for (let i = 0; i < 3; i++) {
                    let cx = mx; const d = chunkDxs[i] || {};
                    let valDia = (i === 0 && patient.fecAtencion) ? (patient.fecAtencion || "").split('-')[2] : ""; cell(valDia, cx, y, cols.dia, hRow, {align:'center'}); cx += cols.dia;
                    let valDniHc = ""; if (i === 0) valDniHc = patient.dni ? String(patient.dni).trim().padStart(8, '0') : ""; if (i === 1) valDniHc = patient.hc; if (i === 2) valDniHc = patient.condicion || "-"; cell(valDniHc, cx, y, cols.dni, hRow, {align:'center'}); cx += cols.dni;
                    let valFin = (i === 0) ? (patient.financiador === 'SIS' ? '2' : '1') : ""; cell(valFin, cx, y, cols.fin, hRow, {align:'center'}); cx += cols.fin;
                    let valDist = ""; if (i === 0) valDist = patient.distrito; if (i === 1) valDist = patient.direccion; if (i === 2) valDist = "C.P: " + (patient.estOrigen || "-"); cell(valDist, cx, y, cols.dist, hRow, {align:'left', fontSize: 5}); cx += cols.dist;
                    let valEdad = ""; if (i === 0 && (age.y || age.y===0)) valEdad = age.y + " A"; if (i === 1 && (age.m || age.m===0)) valEdad = age.m + " M"; if (i === 2 && (age.d || age.d===0)) valEdad = age.d + " D"; cell(valEdad, cx, y, cols.edad, hRow, {align:'center'}); cx += cols.edad;
                    let valSex = (i === 0) ? patient.sexo : ""; cell(valSex, cx, y, cols.sex, hRow, {align:'center'}); cx += cols.sex;
                    let valAntro = ""; if (i === 0 && c === 0) valAntro = "T: " + (clinical.talla || ""); if (i === 1 && c === 0) valAntro = "P: " + (clinical.peso || ""); if (i === 2 && c === 0) valAntro = "Hb: " + (clinical.hb || ""); cell(valAntro, cx, y, cols.antro, hRow, {align:'left'}); cx += cols.antro;
                    let valHbP = ""; if (i === 0 && c === 0) valHbP = "PC: " + (clinical.pCef || ""); if (i === 1 && c === 0) valHbP = "PA: " + (clinical.pAbd || ""); cell(valHbP, cx, y, cols.hb, hRow, {align:'left'}); cx += cols.hb;
                    cell(d.desc || "", cx, y, cols.desc, hRow, {align:'left', fontSize: 5.5}); cx += cols.desc; cell(d.tipo || "", cx, y, cols.tipo, hRow, {align:'center'}); cx += cols.tipo; let labs = [d.lab1, d.lab2, d.lab3].filter(Boolean).join(" "); cell(labs, cx, y, cols.lab, hRow, {align:'center'}); cx += cols.lab; cell(d.codigo || "", cx, y, cols.cie, hRow, {align:'center', bold:true}); cx += cols.cie; y += hRow;
                }
            }
        });
        if (y < 270) { doc.setFontSize(6); doc.text("FIRMA Y SELLO DEL RESPONSABLE", 150, 280, {align:'center'}); doc.line(130, 278, 170, 278); }
        doc.save(`HIS_${adminData.mes}_${allPatients.length}_PACIENTES_OFICIAL.pdf`);
    } catch(err) { alert("Error al generar PDF: " + err.message); }
  }; 

  const generateExcel = () => {
    try {
        if (typeof global === 'undefined') window.global = window;
        if (savedPatients.length === 0 && !patientData.paciente) return alert("No hay datos para exportar.");
        const wb = XLSX.utils.book_new();
        const grayBorderColor = { rgb: "595959" }; const thinBorder = { top: { style: "thin", color: grayBorderColor }, bottom: { style: "thin", color: grayBorderColor }, left: { style: "thin", color: grayBorderColor }, right: { style: "thin", color: grayBorderColor } };
        const centerStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 10.5, name: "Arial" }, border: thinBorder };
        const leftStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 10.5, name: "Arial" }, border: thinBorder };
        const boxHeaderStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 10, bold: true }, border: thinBorder, fill: { fgColor: { rgb: "FFFFFF" } } };
        const smallTextStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 9, name: "Arial" }, border: thinBorder };
        const centerSmallStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 9, name: "Arial" }, border: thinBorder };
        const descStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 9.5, name: "Arial" }, border: thinBorder };
        const bahnschriftStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 11, name: "Bahnschrift SemiBold", bold: true }, border: thinBorder };
        const levenimStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 9, name: "Levenim MT", bold: false }, border: thinBorder };
        const ageStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 9, name: "Bahnschrift SemiBold", color: { rgb: "404040" }, bold: true }, border: thinBorder };
        const headerStyle = { alignment: { horizontal: "center", vertical: "center" }, font: { bold: true, sz: 10, name: "Arial" } };
        const labelHeaderStyle = { alignment: { horizontal: "right", vertical: "center" }, font: { bold: true, sz: 9, name: "Arial" }, border: thinBorder };
        const signatureStyle = { alignment: { horizontal: "center", vertical: "bottom", wrapText: true }, font: { sz: 8, name: "Arial", color: { rgb: "D9D9D9" }, bold: true }, border: thinBorder };

        const signatureText = "FIRMA Y SELLO\nDEL PERSONAL DE SALUD";
        const hRow1 = new Array(19).fill(""); hRow1[1]="Lote:"; hRow1[4]="MINISTERIO DE SALUD"; hRow1[14]=signatureText;
        const hRow2 = new Array(19).fill(""); hRow2[1]="Pag:"; hRow2[4]="OFICINA GENERAL DE ESTADÍSTICA E INFORMÁTICA";
        const hRow3 = new Array(19).fill(""); 
        const hRow4 = new Array(19).fill(""); hRow4[1]="Reg:"; hRow4[4]="Registro Diario de Atención y Otras Actividades de Salud";
        const hRow6 = ["", "AÑO", "MES", "ESTABLECIMIENTO DE SALUD", "", "UNIDAD PRESTADORA (UPS)", "", "", "", "DNI DEL RESP.", "", "", "RESPONSABLE DE LAS ATENCIONES", "", "TURNO"];
        const hRow7 = ["", adminData.anio, adminData.mes, adminData.establecimiento, "", adminData.ups, "", "", "", adminData.dniResp, "", "", adminData.nombreResp, "", adminData.turno];
        const hRow9 = ["", "F.A", "D.N.I. / H.C.", "FINANC.", "DISTRITO DE PROCEDENCIA", "EDAD", "SEXO", "ANTROPOMETRÍA", "", "", "", "EST", "SERV", "DIAGNÓSTICO MOTIVO DE CONSULTA", "TIPO", "LAB", "LAB", "LAB", "CÓDIGO"];
        const fullHeaderBlock = [ hRow1, hRow2, hRow3, hRow4, [""], hRow6, hRow7, [""], hRow9 ];
        const headerMergesTemplate = [
            { s: {r:0, c:4}, e: {r:0, c:13} }, { s: {r:1, c:4}, e: {r:1, c:13} }, { s: {r:3, c:4}, e: {r:3, c:13} },
            { s: {r:0, c:2}, e: {r:0, c:3} }, { s: {r:1, c:2}, e: {r:1, c:3} }, { s: {r:2, c:1}, e: {r:2, c:3} }, { s: {r:3, c:2}, e: {r:3, c:3} },
            { s: {r:0, c:14}, e: {r:3, c:18} },
            { s: {r:5, c:3}, e: {r:5, c:4} }, { s: {r:6, c:3}, e: {r:6, c:4} }, { s: {r:5, c:5}, e: {r:5, c:8} }, { s: {r:6, c:5}, e: {r:6, c:8} },
            { s: {r:5, c:9}, e: {r:5, c:11} }, { s: {r:6, c:9}, e: {r:6, c:11} }, { s: {r:5, c:12}, e: {r:5, c:13} }, { s: {r:6, c:12}, e: {r:6, c:13} },
            { s: {r:5, c:14}, e: {r:5, c:18} }, { s: {r:6, c:14}, e: {r:6, c:18} },
            { s: {r:8, c:7}, e: {r:8, c:10} }, { s: {r:8, c:15}, e: {r:8, c:17} }
        ];
        
        const ws_data = []; const merges = [];
        const insertHeaderBlock = (startRowIndex) => {
            fullHeaderBlock.forEach(row => ws_data.push([...row]));
            headerMergesTemplate.forEach(m => { merges.push({ s: { r: m.s.r + startRowIndex, c: m.s.c }, e: { r: m.e.r + startRowIndex, c: m.e.c } }); });
        };
        insertHeaderBlock(0);
        
        const allPatients = [...savedPatients];
        if (patientData.paciente) { allPatients.push({ patient: patientData, clinical: clinicalData, diagnoses: diagnoses, ageObj: ageObj }); }
        
        let currentRow = 9; let globalBlockIndex = 1; let blocksOnCurrentPage = 0; let patientHeaderIndices = []; let pageStartRows = [0]; const rowBreaks = [];

        // --- FUNCIÓN PARA AGREGAR BLOQUES (CON DATOS O VACÍOS) ---
        const addBlockToSheet = (rec = null) => {
             const isEmpty = !rec;
             const p = rec ? rec.patient : {};
             const c = rec ? rec.clinical : {};
             const dxs = rec ? rec.diagnoses : [];
             const age = rec ? rec.ageObj : {};

             let chunks = [];
             if (!isEmpty) {
                 const totalDxs = Math.max(1, dxs.length); 
                 for (let i = 0; i < totalDxs; i += 3) { chunks.push(dxs.slice(i, i + 3)); } 
                 if (chunks.length === 0) chunks.push([{},{},{}]);
             } else {
                 chunks.push([{},{},{}]); // Un solo chunk de 3 filas vacías
             }

             for(let k = 0; k < chunks.length; k++) {
                const chunkDxs = chunks[k];
                while(chunkDxs.length < 3) chunkDxs.push({});

                // Control de Paginación
                if (blocksOnCurrentPage === 11) {
                    ws_data.push([""]); merges.push({ s: {r:currentRow, c:0}, e: {r:currentRow, c:18} });
                    rowBreaks.push(currentRow); currentRow++; pageStartRows.push(currentRow);
                    insertHeaderBlock(currentRow); currentRow += 9; blocksOnCurrentPage = 0;
                }

                // FILA DEL PACIENTE (Nombre, FN, FUR)
                const patientRow = new Array(19).fill("");
                patientRow[0] = globalBlockIndex;
                if (k === 0) {
                    if (!isEmpty) {
                        patientRow[1] = p.paciente; 
                        patientRow[8] = p.fecNac;
                        if (c.dosaje) patientRow[10] = `F.U.DOSAJE: ${c.dosaje}`; 
                        if (p.fur) patientRow[16] = p.fur;
                    }
                    // ETIQUETAS SIEMPRE VISIBLES (HIS 1.6)
                    patientRow[6] = "F.N:"; 
                    patientRow[14] = "FUR:";
                }
                ws_data.push(patientRow);
                patientHeaderIndices.push(currentRow);

                // Merges de la fila de paciente
                merges.push({ s: {r:currentRow, c:1}, e: {r:currentRow, c:5} }); // B:F
                merges.push({ s: {r:currentRow, c:6}, e: {r:currentRow, c:7} }); // G:H
                merges.push({ s: {r:currentRow, c:8}, e: {r:currentRow, c:9} }); // I:J
                merges.push({ s: {r:currentRow, c:10}, e: {r:currentRow, c:13} }); // K:N
                merges.push({ s: {r:currentRow, c:14}, e: {r:currentRow, c:15} }); // O:P
                merges.push({ s: {r:currentRow, c:16}, e: {r:currentRow, c:18} }); // Q:S
                merges.push({ s: {r:currentRow, c:0}, e: {r:currentRow+3, c:0} }); // Col A

                currentRow++;

                // 3 FILAS DE DIAGNÓSTICOS
                for(let i = 0; i < 3; i++) {
                    const d = chunkDxs[i] || {}; 
                    const row = new Array(19).fill(""); 
                    if (!isEmpty) {
                        row[13] = d.desc || ""; row[14] = d.tipo || ""; row[15] = d.lab1 || ""; row[16] = d.lab2 || ""; row[17] = d.lab3 || ""; row[18] = d.codigo || "";
                        if (i === 0) { row[1] = p.fecAtencion ? p.fecAtencion.split('-')[2] : ""; row[2] = p.dni; row[3] = p.financiador === 'SIS' ? '1' : '2'; row[4] = p.distrito; row[5] = (age.y || age.y === 0) ? `${age.y} años` : ''; row[6] = p.sexo; row[7] = "Talla"; row[8] = (k===0 ? parseFloat(c.talla)||'' : ''); row[9] = "P.C."; row[10] = (k===0 ? parseFloat(c.pCef)||'' : ''); row[11] = p.condEst; row[12] = p.condServ; } 
                        else if (i === 1) { row[2] = p.hc; row[4] = p.direccion; row[5] = (age.m || age.m === 0) ? `${age.m} meses` : ''; row[7] = "Peso"; row[8] = (k===0 ? parseFloat(c.peso)||'' : ''); row[9] = "P.Abd"; row[10] = (k===0 ? parseFloat(c.pAbd)||'' : ''); } 
                        else if (i === 2) { row[2] = p.condicion || "-"; row[4] = "CENTRO POBLADO"; row[5] = (age.d || age.d === 0) ? `${age.d} días` : ''; row[7] = "HB"; row[8] = (k===0 ? parseFloat(c.hb)||'' : ''); row[9] = "P.Preg"; }
                    } else {
                        // Etiquetas fijas en bloques vacíos
                        if (i === 0) { row[7] = "Talla"; row[9] = "P.C."; }
                        else if (i === 1) { row[7] = "Peso"; row[9] = "P.Abd"; }
                        else if (i === 2) { row[7] = "HB"; row[9] = "P.Preg"; }
                    }
                    ws_data.push(row);
                }
                const start = currentRow; const end = currentRow + 2;
                merges.push( { s: {r:start, c:1}, e: {r:end, c:1} }, { s: {r:start, c:3}, e: {r:end, c:3} }, { s: {r:start+1, c:4}, e: {r:end, c:4} }, { s: {r:start, c:6}, e: {r:end, c:6} }, { s: {r:start, c:11}, e: {r:end, c:11} }, { s: {r:start, c:12}, e: {r:end, c:12} } );
                currentRow += 3; globalBlockIndex++; blocksOnCurrentPage++;
             }
        };

        // 1. Renderizar pacientes reales
        allPatients.forEach(rec => addBlockToSheet(rec));

        // 2. Rellenar con bloques vacíos hasta completar la página (múltiplo de 11)
        while (blocksOnCurrentPage > 0 && blocksOnCurrentPage < 11) {
            addBlockToSheet(null);
        }
        
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [ { wch: 2.22 }, { wch: 4 }, { wch: 10 }, { wch: 2 }, { wch: 19.5 }, { wch: 5.44 }, { wch: 2 }, { wch: 4.5 }, { wch: 5.88 }, { wch: 5.1 }, { wch: 5.88 }, { wch: 1.78 }, { wch: 1.78 }, { wch: 42 }, { wch: 2.33 }, { wch: 3.56 }, { wch: 3.56 }, { wch: 3.56 }, { wch: 8.5 } ];
        ws['!merges'] = merges; ws['!pageSetup'] = { scale: 65, paperSize: 9, orientation: 'portrait' }; ws['!margins'] = { left: 0.3, right: 0.3, top: 0.4, bottom: 0.4, header: 0.2, footer: 0.2 }; ws['!rowBreaks'] = rowBreaks.map(r => ({id: r}));
        const rowHeights = [];

        for(let i=0; i<ws_data.length; i++) {
            let isHeader = false; 
            for(let start of pageStartRows) { 
                if (i >= start && i < start + 9) { 
                    isHeader = true; 
                    let rel = i - start; 
                    if (rel === 0 || rel === 1 || rel === 3) { rowHeights.push({ hpx: 25 }); }
                    else if(rel===2 || rel===4 || rel===7) rowHeights.push({ hpx: 4 }); 
                    else if (rel===8) rowHeights.push({ hpx: 40.8 }); 
                    else rowHeights.push({ hpx: 20 }); 
                    break; 
                } 
            }
            if (!isHeader) { 
                if(patientHeaderIndices.includes(i)) { rowHeights.push({ hpx: 18 }); } 
                else { rowHeights.push({ hpx: 24 }); } 
            }
        }
        ws['!rows'] = rowHeights;
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_ref = XLSX.utils.encode_cell({c:C, r:R});
            if (!ws[cell_ref]) ws[cell_ref] = { t: 's', v: '' }; 
            let headerStart = -1; for(let start of pageStartRows) { if (R >= start && R < start + 9) { headerStart = start; break; } }
            const isHeaderBlock = (headerStart !== -1); const relativeR = isHeaderBlock ? (R - headerStart) : -1;
            if (isHeaderBlock) {
                if (relativeR === 0 && C === 4) { ws[cell_ref].s = { font: { name: "Arial Black", sz: 14, bold: true }, alignment: { horizontal: "center", vertical: "center" } }; }
                else if (relativeR === 1 && C === 4) { ws[cell_ref].s = { font: { name: "Arial", sz: 12, bold: true}, alignment: { horizontal: "center", vertical: "center" } }; }
                else if (relativeR <= 3) { if (C >= 1 && C <= 3) { ws[cell_ref].s = { border: thinBorder }; if (C === 1) ws[cell_ref].s = labelHeaderStyle; } else if (C >= 14) { ws[cell_ref].s = { border: thinBorder }; if (C === 14 && relativeR === 0) ws[cell_ref].s = signatureStyle; } else if (C >= 4 && C <= 13) { if (C === 4) ws[cell_ref].s = headerStyle; } }
                else if (relativeR >= 5 && relativeR <= 6 && C > 0) { ws[cell_ref].s = boxHeaderStyle;if (relativeR === 5 && C === 3) { 
        ws[cell_ref].s = { ...boxHeaderStyle, font: { sz: 9, bold: true } }; 
    }
 if (relativeR === 5 && C >= 5 && C <= 8) { ws[cell_ref].s = { ...boxHeaderStyle, font: { sz: 9, bold: true } }; } } 
                else if (relativeR === 8) { ws[cell_ref].s = { ...centerStyle, font: { bold: true, sz: 8, name: "Arial" }, fill: { fgColor: { rgb: "CCCCCC" } } }; if ([3, 5, 6, 11, 12, 14].includes(C)) { ws[cell_ref].s.alignment = { textRotation: 90, horizontal: "center", vertical: "center", wrapText: true }; } if (C === 0) { ws[cell_ref].s.fill = { fgColor: { rgb: "FFFFFF" } }; ws[cell_ref].s.border = {}; } }
                if (C === 0 && (relativeR === 5 || relativeR === 6)) { ws[cell_ref].s = { fill: { fgColor: { rgb: "FFFFFF" } } }; }
            } else {
                ws[cell_ref].s = centerStyle; if (C === 0) { ws[cell_ref].s = { alignment: { horizontal: "center", vertical: "center" }, font: { bold: true, sz: 11, name: "Arial" }, border: {} }; }
                if (C === 4) ws[cell_ref].s = leftStyle; 
                if (C === 13) ws[cell_ref].s = levenimStyle; 
                if ([1, 8, 10, 11, 12, 14, 15, 16, 17, 18].includes(C)) { ws[cell_ref].s = bahnschriftStyle; }
                if (C === 2 && !patientHeaderIndices.includes(R)) { ws[cell_ref].s = bahnschriftStyle; }
                if (C === 5) { ws[cell_ref].s = ageStyle; }
                let currentPh = -1; for(let ph of patientHeaderIndices) { if (ph <= R) currentPh = ph; else break; }
                
                if (currentPh !== -1) { 
                    const offset = R - currentPh; 
                    if (offset === 0) { 
                        // --- ESTILOS DE LA FILA DEL NOMBRE (HIS 1.6) ---
                        // Sin color de fondo general, sin bordes (solo alineación)
                        ws[cell_ref].s = { alignment: { vertical: "center" } }; 
                        
                        if (C === 1) { // Nombre Paciente (B:F)
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Bahnschrift SemiBold", sz: 11, bold: true }, alignment: { horizontal: "left", vertical: "center" } }; 
                        } 
                        if (C === 6) { // Etiqueta F.N: (G:H)
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 9, bold: true }, alignment: { horizontal: "right", vertical: "center" } };
                        }
                        if (C === 8) { // Valor F.N (I:J) -> FONDO GRIS
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 10, bold: false }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "F2F2F2" } }, border: thinBorder };
                        }
                        if (C === 14) { // Etiqueta FUR (O:P)
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 9, bold: true }, alignment: { horizontal: "right", vertical: "center" } };
                        }
                        if (C === 16) { // Valor FUR (Q:S) -> FONDO GRIS
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 10 }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "F2F2F2" } }, border: thinBorder };
                        }

                    } else if (offset === 1) { 
                        if (C === 4) ws[cell_ref].s = smallTextStyle; 
                    } else if (offset === 2) { 
                        if (C === 4) ws[cell_ref].s = smallTextStyle; 
                    } else if (offset === 3) { 
                        if (C === 2) ws[cell_ref].s = centerSmallStyle; 
                    } 
                    if (offset >= 1 && offset <= 3) { 
                        if (C === 7 || C === 9) ws[cell_ref].s = centerSmallStyle; 
                        if ([15, 16, 17].includes(C)) ws[cell_ref].s = centerSmallStyle; 
                    } 
                }
            }
            }
        }
        XLSX.utils.book_append_sheet(wb, ws, "HIS_Export");
        XLSX.writeFile(wb, `HIS_${adminData.mes}_${allPatients.length}_PACIENTES.xlsx`);
        setTimeout(() => {
            if(window.confirm("✅ Excel generado con éxito.\n\n¿Desea LIMPIAR la lista para ingresar un nuevo lote de pacientes?")) {
                setSavedPatients([]); 
                resetForm();           
                setStep(1);
                setIsCalendarOpen(true); // Abre calendario tras reset            
            }
        }, 1000); 
    } catch(err) { alert("Error al exportar Excel: " + err.message); }
  };

// --- PANTALLA DE LOGIN (PRIMERA CAPA DE SEGURIDAD) ---
  if (!isAuthenticated) {
    return (
      <div className="min-h-screen w-full bg-slate-900 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm animate-in zoom-in duration-300">
          <div className="text-center mb-6">
            <div className="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg text-white">
              <Siren size={32} />
            </div>
            <h1 className="text-2xl font-black text-slate-800">HIS 2025</h1>
            <p className="text-slate-400 text-xs font-bold uppercase">Acceso Profesional de Salud</p>
          </div>

          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-xs font-bold text-slate-500 ml-1 mb-1">DNI USUARIO</label>
              <input 
                type="number" 
                className="w-full h-12 px-4 rounded-xl border-2 border-slate-200 font-bold text-slate-700 focus:border-blue-500 outline-none transition-all"
                placeholder="Ingrese su DNI"
                value={loginDni}
                onChange={(e) => setLoginDni(e.target.value)}
                autoFocus
              />
            </div>
            {/* --- NUEVO CAMPO CONTRASEÑA CON OJITO --- */}
            <div>
              <label className="block text-xs font-bold text-slate-500 ml-1 mb-1">CONTRASEÑA</label>
              <div className="relative">
                <input 
                  /* Aquí cambiamos dinámicamente entre 'text' y 'password' */
                  type={showPassword ? "text" : "password"} 
                  className="w-full h-12 px-4 pr-12 rounded-xl border-2 border-slate-200 font-bold text-slate-700 focus:border-blue-500 outline-none transition-all"
                  placeholder="••••••••"
                  value={loginPass}
                  onChange={(e) => setLoginPass(e.target.value)}
                />
                <button 
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-600 transition-colors p-1"
                  tabIndex="-1" // Para que no moleste al navegar con Tab
                >
                  {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                </button>
              </div>
            </div>
            {loginError && (
              <div className="p-3 bg-red-50 text-red-600 text-xs font-bold rounded-lg text-center border border-red-100 flex items-center justify-center gap-2">
                <AlertTriangle size={14}/> {loginError}
              </div>
            )}

            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">
              INICIAR SESIÓN
            </button>
          </form>
          
          <p className="text-center text-[10px] text-slate-300 mt-6">
            Versión Sistema de Atención 2025
          </p>
        </div>
      </div>
    );
  }
    if (!adminData.isConfigured) {
    const cfgInputStyle = "w-full h-10 px-3 border-2 border-slate-200 rounded-xl bg-white text-slate-700 font-bold focus:border-slate-500 focus:ring-4 focus:ring-slate-100 outline-none transition-all shadow-sm text-sm hover:border-slate-300";
    const cfgLabelStyle = "block text-xs font-bold text-slate-400 uppercase ml-2 mb-1"; 
    return (
      <div className="min-h-screen w-full bg-[#f0f2f5] font-sans flex items-center justify-center p-4">
        <div className="w-full max-w-5xl bg-white shadow-2xl rounded-[30px] overflow-hidden border border-slate-100 animate-in fade-in zoom-in duration-300 mx-auto">
          <div className="bg-[#0F172A] px-10 py-6 flex justify-between items-end">
            <div><h1 className="text-2xl font-bold text-white tracking-wide">REGISTRO HIS</h1><p className="text-slate-400 text-xs mt-1">Configuración de Sesión</p></div>
            <div className="flex gap-2">
              {/* Botones de carga para Pacientes, CIE y Personal */}
              <div className="relative group"><input type="file" id="filePac" className="hidden" onChange={(e) => handleFileUpload(e, 'pacientes')} /><label htmlFor="filePac" className={`cursor-pointer px-5 py-2.5 rounded-xl border ${dbPacientes.length ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700'} flex items-center gap-2 text-xs font-bold transition-all shadow-lg`}><Database size={16}/> {dbPacientes.length ? `BD OK (${dbPacientes.length})` : "Cargar Pacientes"}</label></div>
              <div className="relative group"><input type="file" id="fileCie" className="hidden" onChange={(e) => handleFileUpload(e, 'cie10')} /><label htmlFor="fileCie" className={`cursor-pointer px-5 py-2.5 rounded-xl border ${dbCie10.length ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700'} flex items-center gap-2 text-xs font-bold transition-all shadow-lg`}><FileSpreadsheet size={16}/> {dbCie10.length ? `BD OK (${dbCie10.length})` : "Cargar CIE-10"}</label></div>
              <div className="relative group"><input type="file" id="filePersonal" className="hidden" onChange={(e) => handleFileUpload(e, 'personal')} /><label htmlFor="filePersonal" className={`cursor-pointer px-5 py-2.5 rounded-xl border ${dbPersonal.length ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700'} flex items-center gap-2 text-xs font-bold transition-all shadow-lg`}><Users size={16}/> {dbPersonal.length ? `Personal OK` : "Cargar Personal"}</label></div>
              
              {/* NUEVO: Botón para limpiar IndexedDB */}
              {dbStatus === 'ready' && (
                  <button onClick={clearDatabase} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2.5 rounded-xl border border-red-400 flex items-center gap-2 text-xs font-bold transition-all shadow-lg ml-2" title="Borrar Base de Datos Local de Pacientes">
                      <Trash2 size={16}/> Borrar BD
                  </button>
              )}
            </div>
          </div>
	  {/* --- INICIO DEL NUEVO FORMULARIO CON CAMPOS BLOQUEADOS --- */}
          <div className="p-10 grid grid-cols-1 md:grid-cols-4 gap-6 bg-white">
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>Año</label><select name="anio" className={cfgInputStyle} value={adminData.anio} onChange={handleAdmin}><option>2025</option><option>2026</option></select></div>
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>Mes</label><select name="mes" className={cfgInputStyle} value={adminData.mes} onChange={handleAdmin}>{MESES.map(m=><option key={m}>{m}</option>)}</select></div>
            <div className="md:col-span-2 flex flex-col gap-1"><label className={cfgLabelStyle}>Establecimiento</label><select name="establecimiento" className={cfgInputStyle} value={adminData.establecimiento} onChange={handleAdmin}>{ESTABLECIMIENTOS.map(e=><option key={e}>{e}</option>)}</select></div>
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>Turno</label><select name="turno" className={cfgInputStyle} value={adminData.turno} onChange={handleAdmin}><option>MAÑANA</option><option>TARDE</option><option>NOCHE</option></select></div>
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>UPS</label><select name="ups" className={cfgInputStyle} value={adminData.ups} onChange={handleAdmin}>{UPS_LIST.map(u=><option key={u}>{u}</option>)}</select></div>
            
            {/* AQUI ESTAN LOS CAMBIOS: DNI Y NOMBRE BLOQUEADOS */}
            <div className="flex flex-col gap-1">
                <label className={cfgLabelStyle}>DNI Responsable</label>
                <input 
                    name="dniResp" 
                    // Se agrega fondo gris (bg-slate-200), cursor de prohibido y bordes
                    className={cfgInputStyle + " bg-slate-200 text-slate-600 cursor-not-allowed border-slate-300 shadow-inner"} 
                    value={adminData.dniResp} 
                    readOnly={true} // ESTO HACE QUE NO SE PUEDA ESCRIBIR
                />
            </div>
            <div className="md:col-span-2 flex flex-col gap-1">
                <label className={cfgLabelStyle}>Nombre Responsable</label>
                <input 
                    name="nombreResp" 
                    // Se agrega fondo gris, cursor de prohibido y bordes
                    className={cfgInputStyle + " uppercase bg-slate-200 text-slate-600 cursor-not-allowed border-slate-300 shadow-inner"} 
                    value={adminData.nombreResp} 
                    readOnly={true} // ESTO HACE QUE NO SE PUEDA ESCRIBIR
                />
            </div>
          </div>
          {/* --- FIN DEL FORMULARIO --- */}
          <div className="bg-slate-50 px-10 py-6 flex justify-end border-t border-slate-100">
            <button onClick={() => setAdminData({...adminData, isConfigured: true})} className="bg-[#0F172A] hover:bg-slate-800 text-white px-8 py-3 rounded-xl shadow-xl font-bold flex items-center gap-3 transition-transform hover:scale-[1.02] text-sm">INGRESAR AL SISTEMA <ArrowRight size={18}/></button>
          </div>
        </div>
      </div>
    );
  }

  const consolidatedPatients = [...savedPatients];
  if (patientData.paciente) {
      consolidatedPatients.push({ patient: patientData, clinical: clinicalData, diagnoses: diagnoses, ageObj: ageObj });
  }
  const totalGridRows = consolidatedPatients.reduce((acc, p) => {
      const chunks = Math.ceil(Math.max(1, p.diagnoses.length) / 3);
      return acc + (chunks * 4); 
  }, 0); 
  let visualBlockIndex = 1; 

  return (
    <div className="h-screen w-full bg-slate-100 font-sans flex flex-col overflow-hidden">
      {/* --- CINTILLO SUPERIOR MEJORADO --- */}
      <div className="h-16 bg-[#0F172A] text-white flex justify-between items-center px-6 shadow-md z-20 shrink-0 border-b border-slate-800">
        
        {/* PARTE IZQUIERDA: LOGO + ESTABLECIMIENTO + TURNO */}
        <div className="flex items-center gap-4">
            <div className="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/50">
                <Activity size={20} className="text-white" />
            </div>
            <div>
                <h2 className="font-black text-sm tracking-widest text-white mb-0.5">REGISTRO HIS</h2>
                <div className="flex gap-3 text-[10px] font-bold text-slate-400 uppercase tracking-wide">
                    <span>ESTABLECIMIENTO: <span className="text-blue-300">{adminData.establecimiento}</span></span>
                    <span className="text-slate-700">|</span>
                    <span>TURNO: <span className="text-emerald-300">{adminData.turno}</span></span>
                </div>
            </div>
        </div>

        {/* PARTE DERECHA: USUARIO GRANDE + BOTÓN SALIR */}
        <div className="flex items-center gap-6">
            <div className="flex flex-col items-end">
                <span className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">USUARIO ACTIVO</span>
                <span className="uppercase text-white font-black tracking-wide text-sm md:text-base">
                    {adminData.nombreResp || "INVITADO"}
                </span>
            </div>
            <button 
                onClick={() => setAdminData({...adminData, isConfigured: false})} 
                className="bg-red-500/10 hover:bg-red-500/20 text-red-200 px-4 py-2 rounded-xl border border-red-500/30 flex gap-2 transition-all hover:border-red-400 font-bold text-xs items-center"
            >
                <LogOut size={16}/> SALIR
            </button>
        </div>
      </div>
      <div className="flex-1 w-full flex items-center justify-center p-4 relative bg-slate-100">
        {!isModalOpen ? (
          <div className="bg-white rounded-[30px] shadow-2xl border border-white p-12 text-center max-w-xl w-full animate-in fade-in zoom-in duration-300 m-auto">
            <div className="bg-blue-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 shadow-inner"><Plus size={48}/></div>
            <h3 className="text-2xl font-extrabold text-slate-800 mb-2">Nueva Atención</h3>
            <p className="text-slate-500 mb-8 text-sm font-medium">Estado de Base de datos: {dbPacientes.length > 0 ? <span className="text-emerald-600 font-bold bg-emerald-50 px-3 py-1 rounded-xl">Conectada ({dbPacientes.length})</span> : <span className="text-orange-500 font-bold bg-orange-50 px-3 py-1 rounded-xl">Sin datos</span>}</p>
            <button onClick={() => {resetForm(); setIsCalendarOpen(true); setIsModalOpen(true);}} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-xl shadow-blue-600/20 text-lg transition-all hover:-translate-y-1 active:scale-[0.98]">REGISTRAR PACIENTE</button>
          </div>
        ) : (
          <div className="bg-white rounded-[30px] shadow-2xl border border-slate-200 overflow-hidden flex flex-col w-full max-w-[95%] h-[90vh] animate-in zoom-in-95 duration-200 ring-1 ring-black/5 m-auto">
            <div className="flex border-b border-slate-100 bg-white px-6 shrink-0">
              {['Paciente', 'Datos Clínicos', 'Diagnósticos', 'Finalizar'].map((label, idx) => (
                  <div key={idx} className={`flex-1 text-center py-4 text-xs font-bold border-b-[3px] transition-colors ${step === idx + 1 ? `border-${stepColors[idx]}-600 text-${stepColors[idx]}-700` : 'border-transparent text-slate-300'}`}><span className="mr-2 opacity-40">{idx + 1}.</span>{label}</div>
              ))}
              <button onClick={() => setIsModalOpen(false)} className="px-4 ml-2 hover:bg-slate-50 text-slate-300 hover:text-red-500 transition-colors"><X size={20}/></button>
            </div>

            <div className="flex-grow overflow-y-auto p-6 bg-[#FAFAFA] no-scrollbar relative" ref={dxListRef}>
              {/* --- MODAL DE ALERTA DE VALIDACIÓN (BONITO, SIN IMAGEN) --- */}
              {validationAlert.isOpen && (
                <div className="absolute inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in duration-300">
                    <div className={`rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border-2 animate-in zoom-in duration-300 bg-white ${validationAlert.type === 'GESTANTE' ? 'border-pink-200' : 'border-orange-200'}`}>
                        <div className={`px-8 py-6 border-b flex items-center gap-4 ${validationAlert.type === 'GESTANTE' ? 'bg-pink-50 border-pink-100' : 'bg-orange-50 border-orange-100'}`}>
                            <div className={`p-4 rounded-full shrink-0 shadow-sm ${validationAlert.type === 'GESTANTE' ? 'bg-pink-200 text-pink-700' : 'bg-orange-200 text-orange-700'}`}>
                                {validationAlert.type === 'GESTANTE' ? <Baby size={40} strokeWidth={2} /> : <Activity size={40} strokeWidth={2} />}
                            </div>
                            <div>
                                <h3 className={`text-2xl font-black ${validationAlert.type === 'GESTANTE' ? 'text-pink-700' : 'text-orange-800'}`}>{validationAlert.title}</h3>
                                <p className={`text-xs font-bold mt-1 uppercase ${validationAlert.type === 'GESTANTE' ? 'text-pink-400' : 'text-orange-400'}`}>Corrección requerida</p>
                            </div>
                        </div>
                        <div className="p-8">
                            <p className="text-slate-700 font-bold text-lg mb-6 leading-snug">{validationAlert.message}</p>
                            <div className={`p-5 rounded-2xl border flex items-start gap-4 shadow-sm ${validationAlert.type === 'GESTANTE' ? 'bg-pink-50 border-pink-200' : 'bg-orange-50 border-orange-200'}`}>
                                <div className={`mt-1 ${validationAlert.type === 'GESTANTE' ? 'text-pink-500' : 'text-orange-500'}`}><AlertTriangle size={24}/></div>
                                <div className="text-sm font-medium text-slate-600 whitespace-pre-line leading-relaxed">
                                    {validationAlert.details}
                                </div>
                            </div>
                        </div>
                        <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                            <button 
                                onClick={() => setValidationAlert({ ...validationAlert, isOpen: false })} 
                                className={`px-8 py-3 rounded-xl font-black shadow-lg transition-transform active:scale-95 text-sm tracking-wide text-white ${validationAlert.type === 'GESTANTE' ? 'bg-pink-500 hover:bg-pink-600' : 'bg-orange-500 hover:bg-orange-600'}`}
                            >
                                ENTENDIDO, VOY A CORREGIR
                            </button>
                        </div>
                    </div>
                </div>
              )}
              {/* --------------------------------------------------------- */}

              {isCalendarOpen && step === 1 && (<div className="absolute top-0 left-0 w-full h-full bg-black/10 flex items-center justify-center z-50 p-4" onClick={() => setIsCalendarOpen(false)}><div ref={calendarRef} onClick={(e) => e.stopPropagation()}><SimpleCalendar selectedDate={patientData.fecAtencion} onSelectDate={handleDateSelect} onClose={() => setIsCalendarOpen(false)} themeColor={stepColors[0]} /></div></div>)}
              
              {isManualModalOpen && (
                  <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 animate-in zoom-in duration-200">
                          <div className="flex justify-between items-center mb-6 border-b pb-2">
                              <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><UserPlus className="text-blue-600"/> Registrar Nuevo Paciente</h3>
                              <button onClick={() => setIsManualModalOpen(false)}><X className="text-slate-400 hover:text-red-500"/></button>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                              <div><label className={getLabelStyle(1)}>DNI</label><input className={borderlessInputStyle + " border border-slate-200"} value={manualData.dni} onChange={(e) => setManualData({...manualData, dni: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>H. Clínica</label><input className={borderlessInputStyle + " border border-slate-200"} value={manualData.hc} onChange={(e) => setManualData({...manualData, hc: e.target.value})} /></div>
                              <div className="col-span-2"><label className={getLabelStyle(1)}>Apellidos y Nombres</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.nombres} onChange={(e) => setManualData({...manualData, nombres: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>Fecha Nac.</label><input type="date" className={borderlessInputStyle + " border border-slate-200"} value={manualData.fecNac} onChange={(e) => setManualData({...manualData, fecNac: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>Sexo</label><select className={borderlessInputStyle + " border border-slate-200"} value={manualData.sexo} onChange={(e) => setManualData({...manualData, sexo: e.target.value})}><option value="M">MASCULINO</option><option value="F">FEMENINO</option></select></div>
                              <div className="col-span-2"><label className={getLabelStyle(1)}>Dirección</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.direccion} onChange={(e) => setManualData({...manualData, direccion: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>Distrito</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.distrito} onChange={(e) => setManualData({...manualData, distrito: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>Establecimiento Origen</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.estOrigen} onChange={(e) => setManualData({...manualData, estOrigen: e.target.value})} /></div>
                          </div>
                          <div className="col-span-2">
                            <label className={getLabelStyle(1)}>Financiador (SIS, ESSALUD, ETC)</label>
                            <input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.financiador} onChange={(e) => setManualData({...manualData, financiador: e.target.value})} />
                          </div>
                          <div className="mt-6 flex justify-end">
                              <button onClick={handleSaveManualPatient} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg"><Save size={18}/> GUARDAR DATOS</button>
                          </div>
                      </div>
                  </div>
              )}

              {/* --- MODAL ALERTA ADOLESCENTE (12-17 AÑOS) --- */}
              {showAdolescentModal && (
                <div className="absolute inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in duration-300">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-amber-200 animate-in zoom-in duration-300">
                        <div className="bg-amber-50 px-8 py-6 border-b border-amber-200 flex items-center gap-4">
                            <div className="bg-amber-100 p-3 rounded-full shrink-0">
                                <Siren size={32} className="text-amber-600" />
                            </div>
                            <div>
                                <h3 className="text-xl font-extrabold text-amber-800">Alerta de Paciente Adolescente</h3>
                                <p className="text-xs text-amber-600 font-bold mt-1 uppercase">Verificación de Indicadores FED</p>
                            </div>
                        </div>
                        <div className="p-8">
                            <p className="text-slate-700 font-bold text-lg mb-4 leading-tight">
                                Estimado usuario, debe tener cuidado con el paciente que está registrando puesto que es <span className="text-amber-600 underline decoration-2">ADOLESCENTE ({ageObj.y} años)</span>.
                            </p>
                            <div className="bg-purple-50 border border-purple-200 p-6 rounded-2xl flex items-start gap-4 shadow-sm">
                                <Activity size={32} className="text-purple-600 mt-1 shrink-0"/>
                                <p className="text-sm text-purple-900 leading-relaxed font-medium">
                                    Debe registrar con mucho detalle la <b>condición al establecimiento</b>.<br/><br/>
                                    Recordarle que las <b>ADOLESCENTES MUJERES REINGRESANTES O NUEVAS</b> al establecimiento deben tener un <b>DOSAJE DE HEMOGLOBINA</b>, según indicador FED.
                                </p>
                            </div>
                        </div>
                        <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                            <button onClick={() => setShowAdolescentModal(false)} className="bg-amber-600 hover:bg-amber-700 text-white px-8 py-3 rounded-xl font-black shadow-lg transition-transform active:scale-95 text-sm tracking-wide">ENTENDIDO</button>
                        </div>
                    </div>
                </div>
              )}

              {/* --- MODAL DE ADVERTENCIA DE JURISDICCIÓN --- */}
              {showJurisdictionModal && (
                <div className="absolute inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in duration-300">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-red-100 animate-in zoom-in duration-300">
                        <div className="bg-red-50 px-8 py-6 border-b border-red-100 flex items-center gap-4">
                            <div className="bg-red-100 p-3 rounded-full shrink-0"><AlertTriangle size={32} className="text-red-600" /></div>
                            <div><h3 className="text-xl font-extrabold text-red-700">Advertencia de Jurisdicción</h3><p className="text-xs text-red-500 font-bold mt-1 uppercase">Conflicto de Establecimiento</p></div>
                        </div>
                        <div className="p-8">
                            <div className="text-slate-600 text-sm font-medium leading-relaxed whitespace-pre-line mb-6">{jurisdictionErrorMsg}</div>
                            <div className="bg-blue-50 border border-blue-100 p-4 rounded-xl flex items-start gap-3"><div className="bg-blue-100 p-1.5 rounded-full mt-0.5"><Plus size={16} className="text-blue-600"/></div><p className="text-xs text-blue-800 font-bold leading-relaxed">RECUERDE: Si no lo encuentra en el establecimiento que usted está buscando, debe ingresarlo como <span className="underline decoration-2 decoration-blue-400">PACIENTE NUEVO</span> usando el botón azul (+).<br/><br/>Al hacerlo, quedará activa automáticamente la opción: <br/><span className="bg-white px-2 py-0.5 rounded border border-blue-200 text-blue-600 mt-1 inline-block">COND. EST: NUEVO</span> y <span className="bg-white px-2 py-0.5 rounded border border-blue-200 text-blue-600 inline-block">COND. SERV: NUEVO</span>.</p></div>
                        </div>
                        <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end"><button onClick={() => setShowJurisdictionModal(false)} className="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 text-sm">Entendido, cerraré esta ventana</button></div>
                    </div>
                </div>
              )}

              {step === 1 && (
                <div className="animate-in fade-in slide-in-from-right-8 duration-300 min-w-[800px] mx-auto max-w-5xl"> 
                  <div className={`border rounded-xl p-4 mb-4 shadow-sm ${getTheme(1).border} ${getTheme(1).bgLight}`} ref={searchRef}>
                    <div className="flex gap-4 items-end">
                        <div className="flex-1 relative">
                            <label className={`text-[10px] font-bold uppercase block mb-1.5 ml-2 ${getTheme(1).labelText}`}>Buscar Paciente (DNI o Nombre)</label>
                            <div className="relative flex gap-2">
                                <div className="relative flex-1">
                                    <input className={`w-full pl-12 pr-4 h-12 rounded-xl bg-white border-2 outline-none text-lg font-bold placeholder-slate-300 shadow-sm transition-all ${getTheme(1).border} ${getTheme(1).text} ${getTheme(1).focusBorder} focus:ring-4 ${getTheme(1).focusRing}`} placeholder="Ej. 12345678 o JUAN PEREZ" autoFocus value={searchTerm} onChange={handleSearchInput} onFocus={() => { if(suggestions.length > 0) setShowSuggestions(true); }} />
                                    <Search className={`absolute left-4 top-3.5 ${getTheme(1).labelText}`} size={22}/>
                                    {showSuggestions && (<div className="absolute z-50 w-full bg-white mt-2 border border-slate-100 rounded-xl shadow-2xl max-h-64 overflow-y-auto p-2 no-scrollbar">{suggestions.map((p, idx) => (<div key={idx} onMouseDown={() => selectPatient(p)} className={`px-4 py-3 cursor-pointer rounded-xl group transition-colors mb-1 ${getTheme(1).bgHover}`}><div className={`font-bold text-sm group-hover:${getTheme(1).text}`}>{p.nombre}</div><div className="text-[10px] text-slate-400 flex gap-2 mt-1 font-bold"><span className="bg-slate-100 px-2 py-0.5 rounded text-slate-500">DNI: {p.dni}</span><span className="bg-slate-100 px-2 py-0.5 rounded text-slate-500">HC: {p.hc}</span><span className="bg-slate-100 px-2 py-0.5 rounded text-slate-500">Est: {p.estOrigen}</span></div></div>))}</div>)}
                                </div>
                                <button onClick={() => setIsManualModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg transition-transform active:scale-95" title="Registrar Paciente Nuevo"><UserPlus size={24}/></button>
                            </div>
                        </div>
                        <div className="w-48 shrink-0"><label className={getLabelStyle(1)}>F. Atención</label><div className="relative"><input type="date" name="fecAtencion" className={getDateInputStyle(1) + ` h-12 ${getTheme(1).bgLight} text-center`} value={patientData.fecAtencion} onChange={handlePatient} /></div></div>
                    </div>
                  </div>
                  <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                    <div className="flex justify-end mb-2">{isPatientDataLocked ? (<button onClick={() => setIsPatientDataLocked(false)} className={`bg-slate-100 hover:bg-slate-200 text-${stepColors[0]}-600 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition-colors`}><Edit size={16}/> EDITAR DATOS (Desbloquear)</button>) : (<button onClick={() => setIsPatientDataLocked(true)} className={`bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition-colors`}><X size={16}/> BLOQUEAR</button>)}</div>
                    
                    <div className="grid grid-cols-12 gap-2 items-end border-b pb-4 border-slate-100 mb-2 bg-slate-50/50 p-2 rounded-xl">
                        <div className="col-span-3 flex flex-col gap-1">
                            <label className={getLabelStyle(1)}>Cond. Establec.</label>
                            <select name="condEst" className={getSelectStyle(patientData.condEst)} value={patientData.condEst} onChange={handlePatient}>
                                <option value="">SELECCIONE...</option>
                                <option value="N">NUEVO</option>
                                <option value="C">CONTINUADOR</option>
                                <option value="R">REINGRESANTE</option>
                            </select>
                        </div>
                        <div className="col-span-3 flex flex-col gap-1">
                            <label className={getLabelStyle(1)}>Cond. Servicio</label>
                            {/* AQUI SE APLICA LA NUEVA VALIDACIÓN VISUAL (isInvalidCombo) */}
                            <select name="condServ" className={getSelectStyle(patientData.condServ, isInvalidCombo)} value={patientData.condServ} onChange={handlePatient}>
                                <option value="">SELECCIONE...</option>
                                <option value="N">NUEVO</option>
                                <option value="C">CONTINUADOR</option>
                                <option value="R">REINGRESANTE</option>
                            </select>
                        </div>
                        <div className="col-span-6 text-[10px] text-slate-400 italic flex items-center h-10 px-2">
                            * Estos campos son obligatorios para continuar. (Rojo=Falta, Verde=OK)
                        </div>
                    </div>

                    <div className="grid grid-cols-12 gap-2 items-end">
                      <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>DNI</label><input name="dni" className={getLockedInputStyle(1)} value={patientData.dni} onChange={handlePatient} readOnly={true} /></div>
                      <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>H. Clínica</label><input name="hc" className={isPatientDataLocked ? getLockedInputStyle(1) : getInputStyle(1)} value={patientData.hc} onChange={handlePatient} readOnly={isPatientDataLocked} /></div>
                      <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>Fecha Nac.</label><input type="date" name="fecNac" className={getLockedDateInputStyle(1)} value={patientData.fecNac} onChange={handlePatient} readOnly={true} /></div>
                      <div className="col-span-1 flex flex-col gap-1"><label className={getLabelStyle(1)}>Sexo</label><input name="sexo" className={getLockedInputStyle(1)} value={patientData.sexo} onChange={handlePatient} readOnly={true} /></div>
                      <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>Edad (A/M/D)</label><input className={`${baseInputStyle} border-orange-200 text-orange-800 bg-orange-50 cursor-default text-center tracking-wide`} value={ageString} readOnly={true} /></div>
                      <div className="col-span-1 flex flex-col gap-1"><label className={getLabelStyle(1)}>Edad Meses</label><input className={`${baseInputStyle} border-orange-200 text-orange-800 bg-orange-50 cursor-default text-center font-black`} value={ageInMonths} readOnly={true} /></div>
                      <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>Financiador</label><input name="financiador" className={isPatientDataLocked ? getLockedInputStyle(1) : getInputStyle(1)} value={patientData.financiador} onChange={handlePatient} readOnly={isPatientDataLocked} /></div>
                    </div>
                    <div className="grid grid-cols-12 gap-2 items-end">
                      <div className="col-span-8 flex flex-col gap-1"><label className={getLabelStyle(1)}>Paciente</label><input name="paciente" className={isPatientDataLocked ? getLockedInputStyle(1) + " font-black" : getInputStyle(1) + " font-black"} value={patientData.paciente} onChange={handlePatient} readOnly={isPatientDataLocked} /></div>
                      <div className="col-span-4 flex flex-col gap-1"><label className={getLabelStyle(1)}>Distrito</label><input name="distrito" className={isPatientDataLocked ? getLockedInputStyle(1) : getInputStyle(1)} value={patientData.distrito} onChange={handlePatient} readOnly={isPatientDataLocked} /></div>
                    </div>
                    <div className="grid grid-cols-12 gap-2 items-end">
                        <div className="col-span-4 flex flex-col gap-1"><label className={getLabelStyle(1)}>Dirección</label><input name="direccion" className={isPatientDataLocked ? getLockedInputStyle(1) : getInputStyle(1)} value={patientData.direccion} onChange={handlePatient} readOnly={isPatientDataLocked} /></div>
                        <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>Condición</label><select name="condicion" className={getInputStyle(1)} value={patientData.condicion} onChange={handlePatient}><option value="">NINGUNA</option><option value="GESTANTE">GESTANTE</option><option value="PUERPERA">PUERPERA</option></select></div>
                        <div className="col-span-2 flex flex-col gap-1"><label className={getLabelStyle(1)}>FUR</label><div className="relative"><input type="date" name="fur" className={(patientData.condicion !== 'GESTANTE' ? 'bg-slate-100 opacity-50 cursor-not-allowed' : 'bg-white cursor-pointer') + " " + getDateInputStyle(1) + " text-center"} value={patientData.fur} onChange={handlePatient} disabled={patientData.condicion !== 'GESTANTE'} /></div></div>
                        <div className="col-span-4 flex flex-col gap-1"><label className={getLabelStyle(1)}>ESTABLECIMIENTO DE ATENCIÓN</label><input name="estOrigen" className={isPatientDataLocked ? getLockedInputStyle(1) : getInputStyle(1)} value={patientData.estOrigen} onChange={handlePatient} readOnly={isPatientDataLocked} /></div>
                    </div>
                  </div>
                </div>
              )}
              
              {step === 2 && (
                <div className="w-full max-w-[98%] mx-auto">
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    {/* COLUMNA 1: ANTROPOMETRÍA */}
                    <div className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-200`}>
                      <h3 className={`font-extrabold mb-4 flex items-center gap-2 text-lg ${getTheme(2).text}`}><Activity size={24}/> Antropometría</h3>
                      <div className="space-y-4">
                        {/* TALLA (MOVIDO AL INICIO) */}
                        <div className="flex flex-col gap-1"><label className={getLabelStyle(2)}>Talla (30 - 200 cm)</label><input name="talla" type="text" className={borderlessInputStyle} value={clinicalData.talla} onChange={(e) => handleNumericInput(e, 30, 200)} /></div>
                        {/* PESO (MOVIDO AL SEGUNDO LUGAR) */}
                        <div className="flex flex-col gap-1"><label className={getLabelStyle(2)}>Peso (0.8 - 180 kg)</label><input name="peso" type="text" className={borderlessInputStyle} value={clinicalData.peso} onChange={(e) => handleNumericInput(e, 0.8, 180)} /></div>
                        
                        <div className="flex flex-col gap-1"><label className={getLabelStyle(2)}>P. Abd (30 - 200 cm)</label><input name="pAbd" type="text" className={borderlessInputStyle} value={clinicalData.pAbd} onChange={(e) => handleNumericInput(e, 30, 200)} /></div>
                        <div className="flex flex-col gap-1"><label className={getLabelStyle(2)}>P. Cefálico (20 - 60 cm)</label><input name="pCef" type="text" className={borderlessInputStyle} value={clinicalData.pCef} onChange={(e) => handleNumericInput(e, 20, 60)} /></div>
                        
                        {/* CAMPO HEMOGLOBINA AGREGADO */}
                        <div className="flex flex-col gap-1">
                            <label className={getLabelStyle(2)}>Hemoglobina (0 - 21 g/dL)</label>
                            <input name="hb" type="text" className={borderlessInputStyle} value={clinicalData.hb} onChange={(e) => handleNumericInput(e, 0, 21)} />
                        </div>

                        <div className="flex flex-col gap-1">
                            <label className={getLabelStyle(2)}>Peso Pre-Gest. (Solo Gestante)</label>
                            <input name="pPreGest" type="text" className={`${borderlessInputStyle} ${patientData.condicion !== 'GESTANTE' ? 'bg-slate-100 cursor-not-allowed opacity-50' : 'bg-white'}`} value={clinicalData.pPreGest || ''} onChange={(e) => handleNumericInput(e, 30, 150)} disabled={patientData.condicion !== 'GESTANTE'} />
                        </div>
                      </div>
                    </div>
                    
                    {/* COLUMNA 2: BOTÓN PARA ABRIR LA CALCULADORA MODAL (Reemplaza la columna central anterior) */}
                    <div className="bg-purple-50/50 p-6 rounded-2xl border border-purple-100 flex flex-col justify-center items-center h-full min-h-[300px]">
                        <Calculator size={48} className="text-purple-600 mb-4" />
                        <h3 className="text-purple-800 font-extrabold text-xl mb-2 text-center">Evaluación de Anemia</h3>
                        <p className="text-purple-600 text-xs mb-6 text-center max-w-[200px] font-medium">
                            Use la herramienta especializada para ajuste de hemoglobina por altitud y diagnóstico.
                        </p>
                        <button 
                             onClick={() => setShowAnemiaModal(true)} 
                             className="w-full max-w-[250px] bg-purple-600 hover:bg-purple-700 text-white font-bold h-12 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all flex justify-center items-center gap-2 text-sm uppercase tracking-wide"
                        >
                             <Activity size={18}/> ABRIR CALCULADORA
                        </button>
                    </div>
                    
                    {/* COLUMNA 3: RESULTADOS Y EXTRAS (DERECHA) */}
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 h-fit">
                      <h3 className="text-slate-700 font-extrabold mb-4 text-lg">Resultados</h3>
                      <div className="space-y-4">
                        <div className="grid grid-cols-2 items-center gap-2">
                            <label className={`text-xs font-bold text-slate-500 uppercase`}>IMC</label>
                            <input name="imc" className={borderlessInputStyle + ` text-center font-black bg-slate-50`} readOnly value={clinicalData.imc} />
                        </div>
                        <div className="grid grid-cols-2 items-center gap-2">
                            <label className={`text-xs font-bold text-slate-500 uppercase`}>Riesgo</label>
                            <input name="riesgo" className={borderlessInputStyle} value={clinicalData.riesgo} onChange={handleClinical} />
                        </div>
                      </div>
                      
                      <div className="mt-8 pt-6 border-t border-slate-100">
                           <button onClick={() => setShowNutriModal(true)} className="w-full py-3 text-xs font-bold text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors flex justify-center gap-2 items-center border-2 border-dashed border-slate-200 hover:border-blue-200">
                               <Calculator size={16}/> Calculadora OMS (Z-Score)
                           </button>
                      </div>
                    </div>

                  </div>
                </div>
              )}
              {step === 3 && (
                <div className="animate-in fade-in slide-in-from-right-8 duration-300 w-full max-w-[95%] mx-auto">
                  <div className={`flex justify-between items-end mb-6 p-5 rounded-2xl border ${getTheme(3).bgLight} ${getTheme(3).border}`}>
                      <div>
                          <h3 className="font-extrabold text-slate-700 text-lg">Diagnósticos CIE-10</h3>
                          <p className={`text-xs mt-1 font-medium ${getTheme(3).labelText}`}>Haga clic en las filas para buscar y editar</p>
                      </div>
                  </div>

                  <div className="space-y-3">
                    <div className={`grid grid-cols-12 gap-3 text-[10px] font-bold uppercase px-3 items-center ${getTheme(3).labelText}`}>
                        <div className="col-span-1 text-center">Opción</div>
                        <div className="col-span-6">Diagnóstico Seleccionado</div>
                        <div className="col-span-1 text-center">Tipo</div> 
                        <div className="col-span-2 text-center">Lab</div> 
                        <div className="col-span-2 text-center">CIE-10</div>
                    </div>

                    {diagnoses.map((dx, idx) => {
                      const hasError = dxErrors[idx];
                      const errorBorder = hasError ? "border-red-500 ring-2 ring-red-100" : "border-slate-200";
                      const showAddButton = (idx === diagnoses.length - 1); 

                      return (
                      <div key={idx} className={`grid grid-cols-12 gap-3 items-center bg-white p-3 rounded-xl border ${errorBorder} hover:shadow-lg transition-all group relative`}>
                        <div className="col-span-1 flex justify-center">
                            <button onClick={() => openDxSearch(idx)} className={`w-10 h-10 rounded-xl bg-${stepColors[2]}-50 text-${stepColors[2]}-600 flex items-center justify-center border border-${stepColors[2]}-200 hover:bg-${stepColors[2]}-600 hover:text-white transition-colors`}><Search size={18}/></button>
                        </div>
                        <div className="col-span-6 relative" onClick={() => openDxSearch(idx)}>
                          <div className={`w-full h-10 px-3 border-2 rounded-xl flex items-center bg-slate-50 cursor-pointer hover:bg-white hover:border-${stepColors[2]}-300 transition-colors`}>
                              {dx.desc ? <span className="text-xs font-bold text-slate-700 truncate uppercase">{dx.desc}</span> : <span className="text-xs text-slate-400 italic">Clic para buscar diagnóstico...</span>}
                          </div>
                        </div>
                        <div className="col-span-1 flex justify-center">
                           <div className={`w-12 h-12 rounded-xl flex items-center justify-center font-black text-base text-white shadow-sm ${dx.tipo === 'P' ? 'bg-amber-500' : dx.tipo === 'D' ? 'bg-blue-600' : dx.tipo === 'R' ? 'bg-emerald-500' : 'bg-slate-300'}`}>{dx.tipo}</div>
                        </div>
                        <div className="col-span-2 flex gap-2 justify-center">
                          {[dx.lab1, dx.lab2, dx.lab3].map((l, i) => ( <div key={i} className="w-12 h-12 bg-slate-50 border-2 border-slate-200 rounded-xl flex items-center justify-center text-sm font-bold text-slate-700">{l || '-'}</div> ))}
                        </div>
                        <div className="col-span-2 flex justify-center items-center gap-2 relative">
                            <div className="font-black text-slate-800 text-sm bg-slate-100 px-3 py-2 rounded-lg min-w-[60px] text-center">{dx.codigo || '---'}</div>
                            {showAddButton && ( <button onClick={addDx} title="Agregar siguiente fila" className="w-8 h-8 bg-blue-100 text-blue-600 hover:bg-blue-600 hover:text-white rounded-full flex items-center justify-center transition-colors shadow-sm animate-in zoom-in"><Plus size={16} strokeWidth={3} /></button> )}
                            <button onClick={(e) => { e.stopPropagation(); removeDx(idx); }} className="absolute -right-2 top-2 text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={16}/></button>
                        </div>
                      </div>
                    )})}
                    <div ref={dxBottomRef} className="h-24 w-full bg-transparent"></div>
                  </div>
                </div>
              )}
              {step === 4 && (
                <div className="w-full h-full bg-white flex flex-col animate-in fade-in zoom-in duration-300 font-arial">
                   <div className="h-10 bg-[#107C41] flex items-center px-4 justify-between shrink-0">
                    <div className="flex items-center gap-4 text-white text-xs font-bold"><FileSpreadsheet size={18} /><span>Autoguardado</span><span className="opacity-50">|</span><span>HIS_{patientData.dni || 'SINDNI'}_{adminData.mes}</span></div>
                    <div className="flex gap-2"><div className="w-3 h-3 rounded-full bg-white/20 hover:bg-white/40 cursor-pointer"></div><div className="w-3 h-3 rounded-full bg-white/20 hover:bg-white/40 cursor-pointer"></div></div>
                  </div>
                  <div className="h-24 bg-[#F3F3F3] border-b border-[#E1E1E1] flex items-end px-4 pb-2 shrink-0">
                      <div className="flex gap-6 text-xs text-slate-600 font-medium">
                        <div className="flex flex-col items-center gap-1 cursor-pointer hover:bg-slate-200 p-2 rounded"><Grid size={20}/> <span>Inicio</span></div>
                        <div className="flex flex-col items-center gap-1 cursor-pointer hover:bg-slate-200 p-2 rounded"><FileSpreadsheet size={20}/> <span>Insertar</span></div>
                      </div>
                  </div>
                  <div className="h-8 bg-white border-b border-[#E1E1E1] flex items-center px-2 gap-2 text-sm shrink-0">
                      <div className="w-10 text-center font-bold text-slate-500 bg-slate-100 rounded border border-slate-300">A1</div>
                      <div className="flex-1 font-mono text-slate-600 px-2 border-l border-slate-300">fx: MINISTERIO DE SALUD</div>
                  </div>
                  <div className="flex-1 overflow-auto bg-[#E6E6E6] p-1">
                      <div className="bg-white shadow-sm min-w-[1200px]">
                        <div className="flex">
                            <div className="w-10 bg-[#F8F9FA] border-r border-b border-[#D4D4D4]"></div>
                            {['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R'].map((col, i) => (
                                <div key={col} className="flex-1 bg-[#F8F9FA] border-r border-b border-[#D4D4D4] text-center text-xs font-bold text-slate-600 py-1 min-w-[40px]">{col}</div>
                            ))}
                        </div>
                         <div className="flex">
                            <div className="w-10 bg-[#F8F9FA] border-r border-[#D4D4D4] flex flex-col text-center text-xs font-bold text-slate-600">
                                {Array.from({ length: 10 + totalGridRows }, (_, i) => i + 1).map(n => (
                                    <div key={n} className="h-8 border-b border-[#D4D4D4] flex items-center justify-center">{n}</div>
                                ))}
                            </div>
                            <div className="flex-1 flex flex-col text-[11px] font-arial text-slate-800">
                                <div className="flex"><div className="w-[40px] border-r border-[#D4D4D4] bg-white shrink-0"></div><div className="flex-1"><div className="h-8 border-b border-r border-[#D4D4D4] flex items-center justify-center font-bold text-sm">MINISTERIO DE SALUD</div></div></div>
                                <div className="h-8 flex border-b border-[#D4D4D4] font-bold text-[10px] bg-white text-center items-center"><div className="w-[40px] border-r border-[#D4D4D4] bg-white shrink-0"></div><div className="flex-1 border-r border-[#D4D4D4]">RESPONSABLE DE ATENCION</div></div>
                                 {consolidatedPatients.map((rec, idx) => {
                                    const p = rec.patient; const c = rec.clinical; const dxs = rec.diagnoses; const a = rec.ageObj; const isPreview = idx === consolidatedPatients.length - 1 && patientData.paciente;
                                    const totalDxs = Math.max(1, dxs.length); const chunks = []; for (let i = 0; i < totalDxs; i += 3) { chunks.push(dxs.slice(i, i + 3)); } if (chunks.length === 0) chunks.push([{},{},{}]); 
                                    return chunks.map((chunk, chunkIdx) => {
                                        while(chunk.length < 3) chunk.push({}); const heightPx = 3 * 32; const blockNum = visualBlockIndex++;
                                        return (
                                            <div key={`${idx}-${chunkIdx}`} className={`flex border-b border-[#D4D4D4]`}>
                                                <div className="w-[40px] border-r border-[#D4D4D4] flex items-center justify-center font-bold text-slate-700 shrink-0 text-lg bg-white relative"><div className="absolute top-0 bottom-0 left-0 right-0 flex items-center justify-center" style={{top: 0, height: '128px', zIndex: 10, background: 'white', borderRight: '1px solid #D4D4D4', borderBottom: '1px solid #D4D4D4'}}>{blockNum}</div></div>
                                                <div className="flex-1 flex flex-col">
                                                    <div className={`h-8 border-b border-r border-[#D4D4D4] ${isPreview ? 'bg-blue-50 text-blue-800' : 'bg-[#D1EDFF] text-emerald-800'} flex items-center px-2 font-bold text-xs`}>{chunkIdx === 0 && (<><span className="mr-2">#{idx+1}</span> {p.paciente}</>)}</div>
                                                    <div className="flex" style={{ height: `${heightPx}px` }}>
                                                        <div className="w-[4%] border-r border-b border-[#D4D4D4] flex items-center justify-center font-bold text-lg">{ (p.fecAtencion || "").split('-')[2] || "" }</div>
                                                        <div className="w-[10%] flex flex-col border-r border-[#D4D4D4]"><div className="h-8 border-b border-[#D4D4D4] flex items-center justify-center font-bold">{p.dni}</div><div className="h-8 border-b border-[#D4D4D4] flex items-center justify-center">{p.hc}</div><div className="flex-1 border-b border-[#D4D4D4] flex items-center justify-center text-[10px]">{p.condicion || '-'}</div></div>
                                                        <div className="flex-1 flex flex-col border-r border-[#D4D4D4]">
                                                            {chunk.map((d, i) => (<div key={i} className="h-8 border-b border-[#D4D4D4] flex text-[10px]"><div className="flex-1 border-r border-[#D4D4D4] flex items-center pl-1 font-medium truncate">{d.desc}</div><div className="w-8 border-r border-[#D4D4D4] flex items-center justify-center">{d.tipo}</div><div className="w-8 border-r border-[#D4D4D4] flex items-center justify-center">{d.lab1}</div><div className="w-8 border-r border-[#D4D4D4] flex items-center justify-center">{d.lab2}</div><div className="w-8 border-r border-[#D4D4D4] flex items-center justify-center">{d.lab3}</div><div className="w-12 flex items-center justify-center font-bold">{d.codigo}</div></div>))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    });
                                })}
                            </div>
                        </div>
                      </div>
                  </div>
                </div>
              )}
            </div>
            <div className="bg-white p-6 border-t border-slate-100 flex justify-between items-center shrink-0">
               {step > 1 ? (<button onClick={handleBack} className="px-6 py-2 rounded-xl hover:bg-slate-50 text-slate-500 font-bold flex gap-2 transition-all hover:text-slate-800 text-xs h-10 items-center"><ArrowLeft size={18}/> Atrás</button>) : (<div></div>)}
               <div className="flex gap-3">
                   {step === 4 && ( <> <button onClick={() => { setStep(1); resetForm(); setTimeout(() => setIsCalendarOpen(true), 100); }} className={`px-6 py-2 rounded-xl font-bold shadow-lg flex gap-2 items-center transition-all text-xs h-10 bg-slate-100 hover:bg-slate-200 text-slate-700`}><UserPlus size={18}/> NUEVO PACIENTE</button> <button onClick={handleSavePatient} className={`px-6 py-2 rounded-xl font-bold shadow-lg flex gap-2 items-center transition-all text-xs h-10 bg-blue-600 hover:bg-blue-700 text-white`}><SaveIcon size={18}/> GUARDAR PACIENTE</button> </> )}
                   {step < 4 ? (<button onClick={handleNextStep} className="bg-[#0F172A] hover:bg-slate-800 text-white px-8 py-2 rounded-xl font-bold shadow-xl flex gap-2 items-center transition-all hover:translate-x-1 hover:shadow-2xl text-xs h-10">Siguiente <ArrowRight size={18}/></button>) : ( <> <button onClick={generateExcel} className={`px-10 py-2 rounded-xl font-bold shadow-xl flex gap-2 items-center transition-all text-xs h-10 bg-emerald-600 hover:bg-emerald-700 text-white hover:-translate-y-1`}><Download size={20}/> EXPORTAR EXCEL ({savedPatients.length})</button> <button onClick={generatePDF} className={`px-6 py-2 rounded-xl font-bold shadow-xl flex gap-2 items-center transition-all text-xs h-10 bg-red-600 hover:bg-red-700 text-white hover:-translate-y-1 ml-2`}><FileText size={20}/> EXPORTAR PDF</button> </> )}
               </div>
            </div>
          </div>
        )}
      </div>

      {isDxModalOpen && (
        <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-7xl overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
                <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div><h3 className="text-xl font-extrabold text-slate-800">Buscar Diagnóstico</h3><p className="text-xs text-slate-400 font-bold uppercase mt-1">Editando Fila {currentDxRow + 1} de {diagnoses.length}</p></div>
                    <button onClick={() => setIsDxModalOpen(false)} className="bg-white p-2 rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 transition-all shadow-sm border border-slate-100"><X size={24}/></button>
                </div>
                <div className="p-8 space-y-6 overflow-y-auto">
                    <div className="flex flex-col gap-4">
                        <div className="flex gap-4 items-center">
                            <div className="flex gap-2 shrink-0">
                                {['P', 'D', 'R'].map(type => (
                                    <button key={type} onClick={() => setTempDx({...tempDx, tipo: type})} className={`w-12 h-12 rounded-2xl font-black text-lg shadow-sm border-2 transition-all ${tempDx.tipo === type ? (type === 'P' ? 'bg-amber-100 border-amber-500 text-amber-600' : type === 'D' ? 'bg-blue-100 border-blue-600 text-blue-700' : 'bg-emerald-100 border-emerald-500 text-emerald-700') : 'bg-white border-slate-200 text-slate-300 hover:border-slate-300'}`}>{type}</button>
                                ))}
                            </div>
                            <div className="flex-1 relative">
                                <input autoFocus value={modalSearchTerm} onChange={(e) => handleModalSearch(e.target.value)} placeholder="Escribe código o descripción..." className="w-full h-12 pl-4 pr-4 rounded-xl border-2 border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none font-bold text-slate-700 uppercase transition-all" />
                                {modalSuggestions.length > 0 && (
                                    <div className="absolute top-14 left-0 w-full bg-white rounded-2xl shadow-2xl border border-slate-200 max-h-64 overflow-y-auto z-50 p-2 no-scrollbar">
                                            {modalSuggestions.map((item, i) => ( <div key={i} onClick={() => selectModalDx(item)} className="p-3 hover:bg-blue-50 rounded-xl cursor-pointer flex flex-col group border-b border-slate-50 last:border-0"> <div className="font-black text-blue-600 text-sm">{item.CODIGO}</div> <div className="text-xs font-bold text-slate-600 group-hover:text-blue-800">{item.DESCRIPCION}</div> </div> ))}
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-2 shrink-0">
                                {[1, 2, 3].map(n => (
                                    <input key={n} maxLength={3} placeholder="LAB" value={tempDx[`lab${n}`]} onChange={(e) => setTempDx({...tempDx, [`lab${n}`]: e.target.value.toUpperCase()})} className="w-24 h-16 rounded-xl border-2 border-slate-200 text-center font-bold text-slate-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none uppercase text-xl placeholder-slate-300 transition-all" />
                                ))}
                            </div>
                        </div>
                        <div className="bg-blue-50/50 rounded-2xl p-4 border border-blue-100 flex items-center justify-between">
                             <div className="flex items-center gap-4"> <div className="bg-white px-4 py-2 rounded-lg shadow-sm border border-blue-100 font-black text-blue-600 text-xl">{tempDx.codigo || '---'}</div> <div className="flex flex-col"> <span className="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Diagnóstico Seleccionado</span> <span className="font-bold text-slate-700 text-sm line-clamp-1">{tempDx.desc || 'Ninguno seleccionado'}</span> </div> </div>
                             <div className="text-right"> <span className="block text-[10px] text-slate-400 font-bold uppercase">Tipo</span> <span className={`font-black text-lg ${tempDx.tipo === 'P' ? 'text-amber-500' : tempDx.tipo === 'D' ? 'text-blue-600' : 'text-emerald-500'}`}>{tempDx.tipo === 'P' ? 'PRESUNTIVO' : tempDx.tipo === 'D' ? 'DEFINITIVO' : 'REPETIDO'}</span> </div>
                        </div>
                    </div>
                </div>
                <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onClick={() => setIsDxModalOpen(false)} className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors text-sm">Cerrar</button>
                    <button onClick={saveModalSelection} className="px-8 py-3 rounded-xl font-bold bg-emerald-500 hover:bg-emerald-600 text-white shadow-lg shadow-emerald-200 hover:translate-y-[-2px] transition-all text-sm flex items-center gap-2"><Save size={18}/> GUARDAR SELECCIÓN</button>
                </div>
            </div>
        </div>
      )}
      
      {/* INSERCION DE LA NUEVA CALCULADORA MODAL */}
      <AnemiaCalculatorModal 
        isOpen={showAnemiaModal} 
        onClose={() => setShowAnemiaModal(false)} 
        initialData={{
           fecNac: patientData.fecNac,
           fecAtencion: patientData.fecAtencion
        }}
      />

      <NutritionalStatusModal isOpen={showNutriModal} onClose={() => setShowNutriModal(false)} />
      <style>{` .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; } input[type="date"]::-webkit-calendar-picker-indicator { opacity: 1; display: block; width: 1em; height: 1em; position: absolute; top: 50%; right: 12px; transform: translateY(-50%); color: #475569; cursor: pointer; } input[type="date"] { text-align: center; padding-left: 0.5rem; padding-right: 2.5rem; } `}</style>
    </div>
  );
}