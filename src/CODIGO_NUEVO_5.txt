import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Activity, ArrowRight, ArrowLeft, X, Plus, LogOut, Database, Search, Trash2, FileSpreadsheet, Calendar, Edit, Download, Grid, Save, UserPlus, Users,User,UserRound,Stethoscope, Save as SaveIcon, FileText, AlertTriangle, Calculator, Siren, Baby, RefreshCw, CheckCircle, Droplets, Eye, EyeOff,Lock, Heart, Syringe, Brain, Smile } from 'lucide-react';

import NutritionalStatusModal from './NutritionalStatusModal';
import AnemiaCalculatorModal from './AnemiaCalculatorModal';

// --- IMPORTACI√ìN DE DATOS EST√ÅTICOS EXTERNOS ---
import { CIE10_LIST } from './Cie10Data';
import { PERSONAL_LIST } from './PersonalData';
// ------------------------------------------------------------------
import { pacientesFormateados } from './adaptador';
import { SEGUIMIENTO_GESTANTES } from './SEGUIMIENTO_GESTANTES';

import * as XLSXStyle from 'xlsx-js-style';
import { jsPDF } from "jspdf";

// Definici√≥n de constantes DESPU√âS de todos los imports
const XLSX = XLSXStyle.default || XLSXStyle;

// --- PARCHE DE SEGURIDAD ---
if (typeof global === 'undefined') { window.global = window; }

// --- LISTA DE LOCALIDADES ---
const LOCALIDADES_ALTITUD = {
    "AGURAN": 1480, "ALFONSO UGARTE": 1708, "ALTAMIZA": 2684, "ALTO EL MILAGRO": 1900, "ALTO MILAGRO": 2413, 
    "ALTO SANTA ROSA": 2072, "ARANZA": 1332, "BELLAVISTA DE CACHIACO": 1758, "BELLAVISTA DE SAN PABLO": 2065, 
    "CALABOZO": 2390, "CAMINO REAL": 2386, "CASCAJAL": 1757, "CERRO PINTADO": 1735, "CHANGRA": 2796, 
    "CHULUCANITAS": 2690, "CORRAL DE PIEDRAS": 1865, "CUMBICUS ALTO": 2421, "CUMBICUS BAJO": 1602, 
    "CURILCAS": 1518, "CURIRCA": 2595, "EL ALGARROBO": 1830, "EL ALUMBRE": 1325, "EL CARMEN": 2098, 
    "EL CARMEN DE CURILCAS": 2070, "EL CEIBO": 1812, "EL HUABO (EL HUABO DE CURILCAS)": 1780, 
    "EL LIMO": 1826, "EL MOLINO": 1871, "EL PALMO": 2193, "EL PUERTO": 1455, "EL SAUCE": 2576, 
    "EL YAMBUR": 2414, "FRANCISCO BOLOGNESI": 2100, "HUACAMUYOS": 2632, "HUALANGA": 1948, 
    "HUARACAS DE MATALACAS": 3030, "LA COFRADIA": 2650, "LA COIPA DE CURILCAS": 1677, "LA CRIA SAN PABLO": 1684, 
    "LA FLORIDA": 2586, "LA HUACA": 2537, "LA LAGUNA": 2190, "LA LAGUNA (2)": 2607, "LA LOMA": 1861, 
    "LA PALMA": 2753, "LA RAMADA DE MALACHE": 2960, "LA UNION DE SAN PABLO": 2096, "LAGUNAS DE SAN PABLO": 2275, 
    "LAQUE MATALACAS": 1992, "LAS GREDAS": 1457, "LAS JUNTAS": 1853, "LAS LOMAS": 3135, "LAS MERCEDES": 3232, 
    "LAS PALMERAS": 1984, "LAS VEGAS DE CURIRCA": 2222, "LECHEROS": 3077, "LETREROS-TUCAQUE": 2512, 
    "LINDEROS CURILCAS": 1569, "LIRIO": 2459, "LIVIN DE CURILCAS (EL ROYO)": 1908, "LIVIN DE SAN PABLO": 1826, 
    "LOS ALISOS": 2541, "LOS CLAVELES DE MALACHE": 2250, "LUCUMO": 2640, "MALACHE": 2770, "MANGAS DE CACHIACO": 2701, 
    "MARAY DE CURILCAS": 1819, "MARAY DE MATALACAS": 2270, "MARAY DE SAN PABLO": 1997, "MEJICO": 2073, 
    "MEMBRILLO": 2768, "MIRAFLORES": 3104, "MORE": 3095, "MUSHCAPAN": 2255, "NANGAY DE MATALACAS": 2071, 
    "NANGAY PAMPA": 1672, "NARANJITO DE MATALACHE": 1180, "NARANJITO RAMADA DE VILCA": 2312, 
    "NARANJO DE CURILCAS": 1754, "NARANJO DE VILCAS": 1503, "NOTA": 2400, "NUEVA ALIANZA": 1686, 
    "NUEVA ESPERANZA": 3267, "NUEVO FLORECER": 3027, "NUEVO PORVENIR": 2100, "NUEVO PROGRESO": 2670, 
    "PACAIPAMPA": 1980, "PAGAY": 2306, "PALO BLANCO": 2806, "PALO BLANCO DE MATALACAS": 2230, 
    "PALOBLANQUITO": 2969, "PALOMAR": 3303, "PAMPAGRANDE": 2460, "PAPELILLO": 1753, "PAPELILLO (2)": 2051, 
    "PAREDONES": 1302, "PATA DE CACHIACO (PAJUL)": 2281, "PEDREGAL DE MATALACAS": 3092, "PE√ëA BLANCA": 2350, 
    "PORTACHUELO DE MATALACAS": 2490, "PORVENIR DE MATALACAS": 3285, "PUEBLO NUEVO DE MATALACAS": 1964, 
    "PUMURCO": 2120, "PUR PUR": 2176, "RAMADAS VILCAS": 2270, "RAMON CASTILLA": 2057, "SAN ANDRES DEL FAIQUE": 2130, 
    "SAN FRANCISCO": 1761, "SAN FRANCISCO (2)": 2690, "SAN JOSE DE MATALACAS": 2275, "SAN JUAN DE CACHIACO": 2234, 
    "SAN LAZARO": 1620, "SAN LUIS": 1839, "SAN MARTIN": 2539, "SAN MIGUEL DE MATALACAS": 2838, 
    "SAN MIGUEL DE SAN PABLO": 2081, "SANTA CRUZ": 2840, "SANTA CRUZ DE LA VEGA": 1274, "SANTA FE": 3108, 
    "SANTA MARIA": 2433, "SANTA ROSA": 1218, "TAILIN": 2251, "TAUMA": 2264, "TASAJERAS": 1850, 
    "TIERRA COLORADA": 2517, "TINGOS": 2418, "TOJAS": 1966, "TOTORA": 2582, "TULMAN DE MATALACAS": 1817, 
    "TULMANCITO": 2096, "UNION DE LA CRUZ": 2194, "VEGA DEL PUNTO": 1105, "VILCAS": 1710, "YAMANGITO": 2237, 
    "YUMBE": 2434, "YUMBE DE CHANGRA": 2647, "CACHIACO": 1000 
};

// --- SERVICIO INDEXEDDB ---
const DB_NAME = 'HisDatabase_V1';
const STORE_PACIENTES = 'pacientes';

const idb = {
  open: () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_PACIENTES)) {
          db.createObjectStore(STORE_PACIENTES, { keyPath: 'id', autoIncrement: true });
        }
      };
      request.onsuccess = (event) => resolve(event.target.result);
      request.onerror = (event) => reject(event.target.error);
    });
  },
  savePatients: async (patients) => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readwrite');
      const store = transaction.objectStore(STORE_PACIENTES);
      store.clear(); 
      patients.forEach(p => store.add(p));
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => reject(false);
    });
  },
  getPatients: async () => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readonly');
      const store = transaction.objectStore(STORE_PACIENTES);
      const request = store.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject([]);
    });
  },
  clearPatients: async () => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readwrite');
      const store = transaction.objectStore(STORE_PACIENTES);
      const request = store.clear();
      request.onsuccess = () => resolve(true);
      request.onerror = () => reject(false);
    });
  },
  addPatient: async (patient) => {
    const db = await idb.open();
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_PACIENTES], 'readwrite');
      const store = transaction.objectStore(STORE_PACIENTES);
      const request = store.add(patient);
      request.onsuccess = () => resolve(true);
      request.onerror = () => reject(false);
    });
  }
};

const getAgeComponents = (birthDate, attnDate) => {
    if (!birthDate || !attnDate) return { y: '', m: '', d: '' };
    const birth = new Date(birthDate);
    const attn = new Date(attnDate);
    if (isNaN(birth.getTime()) || isNaN(attn.getTime()) || birth > attn) return { y: '-', m: '-', d: '-' };
    let years = attn.getFullYear() - birth.getFullYear();
    let months = attn.getMonth() - birth.getMonth();
    let days = attn.getDate() - birth.getDate();
    if (days < 0) { months--; const prevMonth = new Date(attn.getFullYear(), attn.getMonth(), 0); days += prevMonth.getDate(); }
    if (months < 0) { years--; months += 12; }
    return { y: years, m: months, d: days };
};

// --- COMPONENTE CALENDARIO ---
const SimpleCalendar = ({ selectedDate, onSelectDate, onClose, themeColor }) => {
  const today = new Date();
  const [currentMonth, setCurrentMonth] = useState(new Date(today.getFullYear(), today.getMonth(), 1));
  const year = currentMonth.getFullYear();
  const monthIndex = currentMonth.getMonth();
  const monthName = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"][monthIndex];
  const firstDayOfMonth = new Date(year, monthIndex, 1).getDay();
  const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
  const calendarDays = useMemo(() => {
    const days = [];
    for (let i = 0; i < (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(i);
    return days;
  }, [year, monthIndex, daysInMonth, firstDayOfMonth]);
  const handlePrevMonth = () => setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
  const handleNextMonth = () => setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
  const handleDayClick = (day) => { if (day) { const date = new Date(year, monthIndex, day); const offset = date.getTimezoneOffset();
  const safeDate = new Date(date.getTime() - (offset*60*1000)); onSelectDate(safeDate.toISOString().split('T')[0]); onClose(); } };
  const selectedDateStr = selectedDate || today.toISOString().split('T')[0];
  const isDaySelected = (day) => day && new Date(year, monthIndex, day).toISOString().split('T')[0] === selectedDateStr;
  const isDayToday = (day) => day && new Date(year, monthIndex, day).toISOString().split('T')[0] === today.toISOString().split('T')[0];
  const primaryColorClass = `bg-${themeColor}-600 hover:bg-${themeColor}-700 text-white`;
  const todayColorClass = `border-${themeColor}-500 text-${themeColor}-600 bg-${themeColor}-50`;
  return (
    <div className="w-full max-w-xs mx-auto">
      <div className="p-4 bg-white rounded-xl shadow-2xl border border-slate-100 w-full animate-in zoom-in duration-300">
        <div className="bg-red-50 border border-red-200 rounded-lg p-2 mb-3 text-center animate-pulse"><span className="text-red-600 font-extrabold text-xs uppercase block">‚ö†Ô∏è Seleccione Fecha de Atenci√≥n</span></div>
        <div className="flex justify-between items-center mb-4"><button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-slate-100 text-slate-500"><ArrowLeft size={16} /></button><h4 className="font-bold text-slate-800 text-base">{monthName} {year}</h4><button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-slate-100 text-slate-500"><ArrowRight size={16} /></button></div>
        <div className="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-400 mb-2"><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
        <div className="grid grid-cols-7 gap-1">{calendarDays.map((day, index) => (<div key={index} className="aspect-square">{day ?
        (<button onClick={() => handleDayClick(day)} className={`w-full h-full rounded-full flex items-center justify-center text-sm font-medium transition-all ${isDaySelected(day) ? primaryColorClass + ' shadow-md' : isDayToday(day) ? todayColorClass + ' border-2' : 'text-slate-700 hover:bg-slate-100'}`}>{day}</button>) : <div />}</div>))}</div>
      </div>
      <button onClick={onClose} className={`w-full mt-4 py-2 rounded-xl text-sm font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors`}>Cerrar</button>
    </div>
  );
};

// --- COMPONENTE MODAL PARA VER SEGUIMIENTO CRED ---
const CredFollowUpModal = ({ isOpen, onClose }) => {
  const [credData, setCredData] = useState([]);
  const [columns, setColumns] = useState([]); 
  const [filterTerm, setFilterTerm] = useState("");
  const [isLoading, setIsLoading] = useState(false);

  if (!isOpen) return null;
  const formatExcelDate = (value) => {
    if (typeof value === 'number' && value > 20000 && value < 60000) {
       const date = new Date(Math.round((value - 25569) * 86400 * 1000));
       date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
       if(!isNaN(date.getTime())) {
         return date.toLocaleDateString("es-PE");
       }
    }
    return value;
  };
  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setIsLoading(true);
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (data.length > 0) {
            const headers = data[0];
            setColumns(headers); 
            const rows = data.slice(1).map((r, i) => {
                let obj = { id: i };
                headers.forEach((h, index) => {
                    obj[h] = r[index] !== undefined ? r[index] : "";
                });
                obj.searchStr = Object.values(obj).join(" ").toUpperCase();
                return obj;
            });
            setCredData(rows);
        }
      } catch (err) {
        alert("Error al leer el Excel CRED: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };
    reader.readAsBinaryString(file);
  };
  const filteredData = credData.filter(row => 
    !filterTerm || row.searchStr.includes(filterTerm.toUpperCase())
  ).slice(0, 100);
  return (
    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-[95%] h-[90vh] flex flex-col border border-slate-200 overflow-hidden">
        
        {/* CABECERA */}
        <div className="bg-[#0F172A] p-4 flex justify-between items-center shrink-0">
            <div className="flex items-center gap-3">
                <div className="bg-emerald-500 p-2 rounded-lg text-white"><FileSpreadsheet size={24}/></div>
                <div>
                    <h3 className="text-white font-bold text-lg">SEGUIMIENTO CRED</h3>
                    <p className="text-slate-400 text-xs">Visualizaci√≥n Completa del Archivo</p>
                </div>
            </div>
            <button onClick={onClose} className="text-slate-400 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all"><X size={24}/></button>
        </div>

        {/* BARRA DE HERRAMIENTAS */}
        <div className="p-4 bg-slate-50 border-b border-slate-200 flex gap-4 items-center shrink-0">
            {credData.length === 0 ?
            (
                <div className="relative group w-full">
                    <input type="file" id="fileCred" className="hidden" accept=".xlsx, .xls" onChange={handleFileUpload} />
                    <label htmlFor="fileCred" className="cursor-pointer w-full border-2 border-dashed border-slate-300 hover:border-emerald-500 bg-white hover:bg-emerald-50 h-16 rounded-xl flex flex-col items-center justify-center transition-all group-hover:text-emerald-600 text-slate-500 font-bold">
                        {isLoading ? "Cargando..." : "üìÇ CLIC AQU√ç PARA CARGAR EL EXCEL 'SEGUIMIENTO CRED'"}
                    </label>
                </div>
            ) : (
                <div className="flex w-full gap-4">
                     <div className="relative flex-1">
                        <Search className="absolute left-3 top-3 text-slate-400" size={20}/>
                        <input 
                            autoFocus
                            className="w-full h-11 pl-10 pr-4 rounded-xl border-2 border-slate-300 focus:border-emerald-500 outline-none font-bold uppercase text-sm" 
                            placeholder="BUSCAR EN CUALQUIER COLUMNA..." 
                            value={filterTerm}
                            onChange={e => setFilterTerm(e.target.value)}
                        />
                    </div>
                    <button onClick={() => { setCredData([]); setColumns([]); }} className="px-4 bg-red-100 text-red-600 font-bold rounded-xl hover:bg-red-200 text-xs whitespace-nowrap">CAMBIAR ARCHIVO</button>
                </div>
            )}
        </div>

        {/* TABLA DE DATOS */}
        <div className="flex-1 overflow-auto bg-slate-100 p-4">
            {credData.length > 0 ?
            (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                    <table className="w-full text-xs text-left border-collapse">
                        <thead className="bg-slate-50 text-slate-500 font-bold uppercase">
                             <tr>
                                {columns.map((col, i) => (
                                    <th key={i} className="px-4 py-3 border-b border-r border-slate-200 whitespace-nowrap min-w-[100px] bg-slate-50 sticky top-0 z-10">
                                             {col}
                                    </th>
                                ))}
                             </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {filteredData.map((row) => (
                                <tr key={row.id} className="hover:bg-blue-50 transition-colors">
                                    {columns.map((col, i) => (
                                        <td key={i} className="px-4 py-2 text-slate-700 whitespace-nowrap border-r border-slate-100">
                                            {formatExcelDate(row[col])}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {filteredData.length === 0 && <div className="p-10 text-center text-slate-400 font-bold">No se encontraron resultados para "{filterTerm}"</div>}
                </div>
            ) : (
                <div className="h-full flex items-center justify-center text-slate-400 font-medium">
                    Esperando archivo...
                </div>
            )}
        </div>
        <div className="bg-slate-50 p-2 text-center text-[10px] text-slate-400 font-bold border-t border-slate-200">
            Mostrando {filteredData.length} registros.
            (Deslice horizontalmente para ver m√°s columnas)
        </div>
      </div>
    </div>
  );
};

// --- COMPONENTE VISOR INTEGRADO ---
// --- COMPONENTE VISOR INTEGRADO (CON BOT√ìN DE OJO) ---
const InlineFollowUpViewer = ({ type, data, onClose, onFileUpload, externalFilter, onView }) => {
  const [filter, setFilter] = useState(externalFilter || "");
  const [selectedRowIndex, setSelectedRowIndex] = useState(null);
  useEffect(() => {setFilter(externalFilter || "");}, [externalFilter]);
  
  // Columnas (quitamos ID y searchStr)
  const columns = data && data.length > 0 ? Object.keys(data[0]).filter(k => k !== 'id' && k !== 'searchStr') : [];
  const filtered = data ? data.filter(row => !filter || row.searchStr.includes(filter.toUpperCase())).slice(0, 100) : []; 

  const formatCell = (value) => {
      if (typeof value === 'number' && value > 20000 && value < 60000) {
          const date = new Date(Math.round((value - 25569) * 86400 * 1000));
          date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
          if(!isNaN(date.getTime())) {
              return date.toLocaleDateString("es-PE", { day: '2-digit', month: '2-digit', year: 'numeric' });
          }
      }
      return value;
  };

  return (
    <div className="mb-6 bg-white border-2 border-slate-200 rounded-xl overflow-hidden animate-in fade-in slide-in-from-top-4 duration-300 shadow-xl">
      {/* CABECERA */}
      <div className="bg-slate-100 p-3 flex justify-between items-center border-b border-slate-200">
        <h3 className="font-black text-slate-700 uppercase flex items-center gap-2">
           <Database size={18}/> SEGUIMIENTO: <span className="text-blue-600">{type}</span>
        </h3>
        <button onClick={onClose} className="text-xs font-bold bg-slate-200 hover:bg-red-100 text-slate-600 hover:text-red-600 px-3 py-1 rounded-lg transition-colors border border-slate-300">
            CERRAR VISOR
        </button>
      </div>

      {/* CONTENIDO */}
      <div className="p-4">
        {(!data || data.length === 0) ? (
            <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center text-slate-400 bg-slate-50">
                <p className="font-bold mb-3">No hay datos cargados para {type}</p>
                <input type="file" id={`file_${type}`} className="hidden" accept=".xlsx, .xls" onChange={(e) => onFileUpload(e, type)} />
                <label htmlFor={`file_${type}`} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                    <Download size={16}/> CARGAR EXCEL {type}
                </label>
            </div>
        ) : (
            <>
                <div className="mb-3 relative">
                    <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                    <input 
                        className="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-300 text-xs font-bold uppercase focus:ring-2 focus:ring-blue-100 outline-none" 
                        placeholder="BUSCAR EN ESTA LISTA..." 
                        value={filter}
                        onChange={e => setFilter(e.target.value)}
                    />
                </div>

                {/* SCROLLBAR SIEMPRE VISIBLE */}
                <div className="border border-slate-300 rounded-lg overflow-auto w-full max-h-[60vh] relative shadow-inner bg-slate-50">
                    <table className="w-full text-[10px] text-left border-collapse">
                        <thead className="bg-slate-100 text-slate-600 font-extrabold uppercase sticky top-0 z-20 shadow-sm">
                            <tr>
                                {/* COLUMNA DE ACCI√ìN FIJA (OJO) */}
                                <th className="px-2 py-3 border-b border-r border-slate-300 bg-slate-200 text-center w-10 sticky left-0 z-30">
                                    VER
                                </th>
                                {columns.map((c, i) => (
                                    <th key={i} className="px-3 py-3 border-b border-r border-slate-300 whitespace-nowrap min-w-[100px] bg-slate-100">
                                         {c}
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="bg-white">
                            {filtered.map((row, i) => (
                                <tr key={i} className="hover:bg-blue-50 transition-colors border-b border-slate-200">
                                    {/* BOT√ìN OJO */}
                                    <td className="px-2 py-2 border-r border-slate-200 text-center bg-slate-50 sticky left-0 z-20 shadow-sm">
                                        <button 
                                            onClick={() => onView && onView(row)} 
                                            className="bg-blue-100 text-blue-600 hover:bg-blue-600 hover:text-white p-1.5 rounded-lg transition-all shadow-sm"
                                            title="Ver seguimiento gr√°fico"
                                        >
                                            <Eye size={16} />
                                        </button>
                                    </td>
                                    {/* RESTO DE DATOS */}
                                    {columns.map((c, j) => (
                                        <td key={j} className="px-3 py-2 whitespace-nowrap border-r border-slate-200">
                                            {formatCell(row[c])}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                
                <div className="mt-2 text-[10px] text-slate-400 font-bold text-right flex justify-between items-center">
                    <span>üí° Tip: Use Shift + Rueda del mouse para desplazarse horizontalmente.</span>
                    <span>Mostrando {filtered.length} coincidencias.</span>
                </div>
            </>
        )}
      </div>
    </div>
  );
};
// --- MODAL DE SEGUIMIENTO INDIVIDUAL (ESTILO PASTILLAS) ---
const SeguimientoIndividualModal = ({ paciente, onClose }) => {
  if (!paciente) return null;

  // Calculamos resumen r√°pido
  const ultimoControl = paciente.historialControles[paciente.historialControles.length - 1] || {};
  const controlesTotal = paciente.historialControles.length;
  const ultimaHb = paciente.historialControles.map(c => c.hb).filter(h => h).pop();
  const tieneAnemia = ultimaHb && parseFloat(ultimaHb) < 11.0;

  return (
    <div className="fixed inset-0 z-[150] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in duration-300">
      <div className="bg-slate-50 w-full max-w-5xl max-h-[90vh] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col border border-white/20">
        
        {/* 1. CABECERA DE LA PACIENTE (Estilo Tarjeta de Cr√©dito) */}
        <div className={`relative p-8 shrink-0 overflow-hidden ${tieneAnemia ? 'bg-gradient-to-r from-rose-500 to-pink-600' : 'bg-gradient-to-r from-emerald-500 to-teal-600'}`}>
          {/* Decoraci√≥n de fondo */}
          <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/3 blur-3xl"></div>
          
          <div className="relative z-10 flex justify-between items-start text-white">
            <div className="flex gap-6 items-center">
              <div className="bg-white/20 p-4 rounded-full backdrop-blur-md shadow-inner border border-white/30">
                <UserRound size={48} strokeWidth={1.5} />
              </div>
              <div>
                <h2 className="text-3xl font-black tracking-tight leading-none mb-2">{paciente.nombre}</h2>
                <div className="flex gap-4 text-sm font-bold opacity-90">
                  <span className="bg-black/20 px-3 py-1 rounded-lg border border-white/10">DNI: {paciente.dni}</span>
                  <span className="bg-black/20 px-3 py-1 rounded-lg border border-white/10">EDAD: {paciente.edad} A√ëOS</span>
                  <span className="bg-black/20 px-3 py-1 rounded-lg border border-white/10">HC: {paciente.hc}</span>
                </div>
                <div className="mt-3 flex items-center gap-2 text-xs font-medium opacity-80">
                  <Database size={12}/> {paciente.establecimiento}
                </div>
              </div>
            </div>

            <div className="flex flex-col items-end gap-2">
              <button onClick={onClose} className="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full transition-all backdrop-blur-md">
                <X size={24} />
              </button>
              {tieneAnemia && (
                <div className="bg-red-600 text-white px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 shadow-lg animate-pulse border border-red-400">
                  <AlertTriangle size={16} /> ALERTA DE ANEMIA (Hb: {ultimaHb})
                </div>
              )}
            </div>
          </div>
        </div>

        {/* 2. CUERPO: L√çNEA DE TIEMPO DE CONTROLES (Pastillas) */}
        <div className="flex-1 overflow-y-auto p-8 bg-slate-50">
          {controlesTotal === 0 ? (
            <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60">
              <FileText size={64} strokeWidth={1} />
              <p className="mt-4 font-bold text-lg">Sin controles registrados</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {paciente.historialControles.map((ctrl, idx) => {
                // An√°lisis de cada pastilla
                const isAnemia = ctrl.hb && parseFloat(ctrl.hb) < 11.0;
                
                return (
                  <div key={idx} className={`relative bg-white rounded-3xl p-5 shadow-sm border-2 transition-all hover:-translate-y-1 hover:shadow-xl group
                    ${isAnemia ? 'border-rose-100 hover:border-rose-300' : 'border-slate-100 hover:border-emerald-200'}
                  `}>
                    {/* N√∫mero de Control (Badge Flotante) */}
                    <div className={`absolute -top-3 -right-3 w-10 h-10 rounded-full flex items-center justify-center text-sm font-black text-white shadow-lg border-4 border-slate-50 z-20
                      ${isAnemia ? 'bg-rose-500' : 'bg-emerald-500'}
                    `}>
                      {ctrl.numero}
                    </div>

                    {/* Fecha */}
                    <div className="flex items-center gap-2 mb-4 pb-3 border-b border-slate-50">
                      <div className={`p-2 rounded-xl ${isAnemia ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-500'}`}>
                        <Calendar size={18} />
                      </div>
                      <div>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Fecha Atenci√≥n</p>
                        <p className="text-sm font-black text-slate-700">{ctrl.fecha}</p>
                      </div>
                    </div>

                    {/* Datos Cl√≠nicos (Grid Interno) */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                      {/* Peso */}
                      <div className="bg-slate-50 rounded-2xl p-2 text-center">
                        <span className="text-[9px] font-bold text-slate-400 block mb-1">PESO (Kg)</span>
                        <span className="text-lg font-black text-slate-700">{ctrl.peso || '--'}</span>
                      </div>
                      {/* Talla */}
                      <div className="bg-slate-50 rounded-2xl p-2 text-center">
                        <span className="text-[9px] font-bold text-slate-400 block mb-1">TALLA (cm)</span>
                        <span className="text-lg font-black text-slate-700">{ctrl.talla || '--'}</span>
                      </div>
                      {/* Hemoglobina (Destacada) */}
                      <div className={`col-span-2 rounded-2xl p-2 text-center border ${isAnemia ? 'bg-rose-50 border-rose-100' : 'bg-blue-50 border-blue-100'}`}>
                        <span className={`text-[9px] font-bold block mb-1 ${isAnemia ? 'text-rose-400' : 'text-blue-400'}`}>HEMOGLOBINA</span>
                        <span className={`text-xl font-black ${isAnemia ? 'text-rose-600' : 'text-blue-700'}`}>{ctrl.hb || '--'}</span>
                      </div>
                    </div>

                    {/* Footer: Responsable */}
                    <div className="text-[10px] text-slate-400 font-medium border-t border-slate-50 pt-3 flex items-center gap-2 truncate">
                      <Stethoscope size={12} className="shrink-0" />
                      <span className="truncate uppercase" title={ctrl.responsable}>{ctrl.responsable || "NO REGISTRADO"}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
        
        {/* Footer del Modal */}
        <div className="p-4 bg-white border-t border-slate-100 flex justify-between items-center text-xs font-bold text-slate-400">
           <span>Total Controles: {controlesTotal}</span>
           <span>√öltima Atenci√≥n: {paciente.ultimaAtencion}</span>
        </div>
      </div>
    </div>
  );
};
export default function App() {
  const [showNutriModal, setShowNutriModal] = useState(false);
  const [showAnemiaModal, setShowAnemiaModal] = useState(false);
  const [showSaveConfirm, setShowSaveConfirm] = useState(false);
  const [isCalendarOpen, setIsCalendarOpen] = useState(false);
  const [lastClinicalData, setLastClinicalData] = useState({});
  const [isDataVerified, setIsDataVerified] = useState(false);
  const hcInputRef = useRef(null);
  // LISTA DE CASER√çOS
  const listaCaserios = useMemo(() => Object.keys(LOCALIDADES_ALTITUD).sort(), []);
  const calendarRef = useRef(null);
  const handleDateSelect = (date) => setPatientData(prev => ({ ...prev, fecAtencion: date }));
  const [showCredModal, setShowCredModal] = useState(false);
  const [isBatchFinished, setIsBatchFinished] = useState(false);
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (isCalendarOpen && calendarRef.current && !calendarRef.current.contains(event.target) && event.target.tagName !== 'BUTTON') setIsCalendarOpen(false);
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isCalendarOpen]);
  const stepColors = ['blue', 'emerald', 'indigo', 'amber'];
  const getTheme = (s) => { const color = stepColors[s-1] || 'slate';
  return { border: `border-${color}-200`, focusBorder: `focus:border-${color}-500`, focusRing: `focus:ring-${color}-100`, text: `text-${color}-800`, labelText: `text-${color}-600`, bgHover: `hover:bg-${color}-50`, bgLight: `bg-${color}-50/50` }; };
  const baseInputStyle = "w-full h-9 px-3 border-2 rounded-xl bg-white font-bold outline-none transition-all shadow-sm text-sm";
  const dateInputStyle = "relative w-full h-9 px-3 py-1 border-2 rounded-xl bg-white font-bold outline-none transition-all shadow-sm text-sm cursor-pointer";
  const getInputStyle = (s) => `${baseInputStyle} ${getTheme(s).border} ${getTheme(s).text} ${getTheme(s).focusBorder} focus:ring-4 ${getTheme(s).focusRing} hover:border-opacity-80`;
  const getSelectStyle = (value, hasError = false) => {
    const baseStyle = getInputStyle(1);
    if (value === "" || hasError) return `${baseStyle.replace(getTheme(1).border, 'border-red-500').replace(getTheme(1).focusBorder, 'focus:border-red-600')} bg-red-50 text-red-900 animate-pulse`;
    return `${baseStyle.replace(getTheme(1).border, 'border-emerald-500').replace(getTheme(1).focusBorder, 'focus:border-emerald-600')} bg-emerald-50 text-emerald-900 font-black`;
  };

  const getLockedInputStyle = (s) => `${baseInputStyle} ${getTheme(s).border} ${getTheme(s).text} border-slate-200 bg-slate-50 cursor-default shadow-inner`;
  const getDateInputStyle = (s) => `${dateInputStyle} ${getTheme(s).border} ${getTheme(s).text} ${getTheme(s).focusBorder} focus:ring-4 ${getTheme(s).focusRing} hover:border-opacity-80`;
  const getLockedDateInputStyle = (s) => `${dateInputStyle} ${getTheme(s).border} ${getTheme(s).text} border-slate-200 bg-slate-50 cursor-default shadow-inner`;
  const getLabelStyle = (s) => `block text-[10px] font-bold uppercase ml-2 mb-0.5 ${getTheme(s).labelText}`;
  const borderlessInputStyle = "w-full h-9 px-3 rounded-xl bg-slate-50 font-bold outline-none text-sm text-slate-800 transition-all focus:bg-white focus:ring-2 focus:ring-emerald-100 shadow-sm";
  const MESES = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SETIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
  const ESTABLECIMIENTOS = ["E.S I-4 PACAIPAMPA", "P.S I-2 EL PUERTO", "P.S I-1 LAGUNAS DE SAN PABLO", "P.S I-1 CUMBICUS", "P.S I-1 CACHIACO"];
  const UPS_LIST = ["MEDICINA", "ENFERMERIA", "OBSTETRICIA", "NUTRICION", "ODONTOLOGIA", "PSICOLOGIA"];
  const [dbPacientes, setDbPacientes] = useState([]);
  
  // DATOS IMPORTADOS
  const [dbCie10, setDbCie10] = useState(CIE10_LIST); 
  const [dbPersonal, setDbPersonal] = useState(PERSONAL_LIST);
  const [dbStatus, setDbStatus] = useState('loading'); 

  // --- NUEVOS ESTADOS PARA LOGIN ---
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loginDni, setLoginDni] = useState("");
  const [loginPass, setLoginPass] = useState("");
  const [showPassword, setShowPassword] = useState(false); 
  const [loginError, setLoginError] = useState("");
  const handleLogin = (e) => {
    e.preventDefault();
    const user = dbPersonal.find(u => u.dni === loginDni);

    if (user && user.password === loginPass) {
      setIsAuthenticated(true);
      setLoginError("");
      
      // --- AQU√ç EST√Å EL CAMBIO ---
      if (typeof setAdminData === 'function') {
        setAdminData(prev => ({ 
            ...prev, 
            dniResp: user.dni, 
            nombreResp: user.nombre,
            
            // Si el usuario tiene UPS definida, √∫sala. Si no, usa MEDICINA por defecto.
            ups: user.ups || 'MEDICINA' 
        }));
      }
      // ---------------------------

    } else {
      setLoginError("Credenciales incorrectas o usuario no encontrado");
    }
  };

  const [validationAlert, setValidationAlert] = useState({ isOpen: false, type: '', title: '', message: '', details: '' });
  const [searchTerm, setSearchTerm] = useState("");
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const searchRef = useRef(null);
  const [isPatientDataLocked, setIsPatientDataLocked] = useState(false); 

  const [isDxModalOpen, setIsDxModalOpen] = useState(false);
  const [currentDxRow, setCurrentDxRow] = useState(0); 
  const [modalSearchTerm, setModalSearchTerm] = useState("");
  const [modalSuggestions, setModalSuggestions] = useState([]);
  const [tempDx, setTempDx] = useState({ desc: '', tipo: 'D', lab1: '', lab2: '', lab3: '', codigo: '' });
  const [dxSuggestions, setDxSuggestions] = useState([]);
  const [activeDxIndex, setActiveDxIndex] = useState(null);
  const [activeDxField, setActiveDxField] = useState(null);
  
  const dxListRef = useRef(null);
  const dxBottomRef = useRef(null); 
  const tipoRefs = useRef([]);
  const [dxErrors, setDxErrors] = useState({});

  const [isManualModalOpen, setIsManualModalOpen] = useState(false);
  const [manualData, setManualData] = useState({ dni: '', nombres: '', fecNac: '2000-01-01', sexo: 'M', hc: '', distrito: '', direccion: '', financiador: '2-SIS', estOrigen: '' });
  const [showJurisdictionModal, setShowJurisdictionModal] = useState(false);
  const [jurisdictionErrorMsg, setJurisdictionErrorMsg] = useState("");
  const [showAdolescentModal, setShowAdolescentModal] = useState(false);

  const [anemiaLocation, setAnemiaLocation] = useState("");
  const [anemiaResult, setAnemiaResult] = useState("");
  const [anemiaColor, setAnemiaColor] = useState("bg-slate-200 text-slate-500");
  const [hbAdjusted, setHbAdjusted] = useState(null);
  const [isPremature, setIsPremature] = useState(false);

  const [adminData, setAdminData] = useState({ anio: '2026', mes: 'ENERO', establecimiento: 'E.S I-4 PACAIPAMPA', turno: 'MA√ëANA', ups: 'MEDICINA', dniResp: '', nombreResp: '', isConfigured: false });
  const initialPatient = { dni: '', paciente: '', hc: '', fecNac: '', sexo: '', financiador: '', direccion: '', distrito: '', estAtencion: 'PACAIPAMPA', fecAtencion: '', condicion: '', fur: '', estOrigen: '', condEst: '', condServ: '' };
  const [patientData, setPatientData] = useState(initialPatient);
  const [savedPatients, setSavedPatients] = useState([]);
  // CAMBIO: Formato de edad extendido
  const ageString = useMemo(() => { 
      const { y, m, d } = getAgeComponents(patientData.fecNac, patientData.fecAtencion); 
      if (typeof y !== 'number') return "-";
      return `${y} A√ëOS, ${m} MESES, ${d} D√çAS`; 
  }, [patientData.fecNac, patientData.fecAtencion]);
  const ageObj = useMemo(() => { return getAgeComponents(patientData.fecNac, patientData.fecAtencion); }, [patientData.fecNac, patientData.fecAtencion]);
  const ageInMonths = useMemo(() => { if (typeof ageObj.y === 'number' && typeof ageObj.m === 'number') { return (ageObj.y * 12) + ageObj.m; } return ''; }, [ageObj]);
  const initialClinical = { peso: '', talla: '', pAbd: '', pCef: '', imc: '', hb: '', dosaje: '', estNut: '', nivHb: '', riesgo: ' ', pPreGest: '' };
  const [clinicalData, setClinicalData] = useState(initialClinical);

  const [diagnoses, setDiagnoses] = useState([{ desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [step, setStep] = useState(1);
  const [ignorePreGestValidation, setIgnorePreGestValidation] = useState(false);
  const [showPreGestError, setShowPreGestError] = useState(false);
  const [showHbError, setShowHbError] = useState(false);
  const [ignorePAbdValidation, setIgnorePAbdValidation] = useState(false);
  const [showPAbdError, setShowPAbdError] = useState(false);
  const [ignorePCefValidation, setIgnorePCefValidation] = useState(false);
  const [showPCefError, setShowPCefError] = useState(false);
  const [activeFollowUp, setActiveFollowUp] = useState(null); 
  const [selectedGestanteForModal, setSelectedGestanteForModal] = useState(null);
  const dataGestantesInicial = useMemo(() => {
    if (typeof SEGUIMIENTO_GESTANTES !== 'undefined' && Array.isArray(SEGUIMIENTO_GESTANTES)) {
        return SEGUIMIENTO_GESTANTES.map((row, i) => ({
            ...row,
            id: i, // ID √∫nico para la tabla
            searchStr: Object.values(row).join(" ").toUpperCase() // Para poder filtrar en la tabla
        }));
    }
    return [];
}, []);

// Inicializamos el estado YA CON LOS DATOS CARGADOS en la llave 'GESTANTE'
const [followUpData, setFollowUpData] = useState({
    'GESTANTE': dataGestantesInicial
});
  useEffect(() => {
    const initDB = async () => {
        try {
            const patients = await idb.getPatients();
            if (patients && patients.length > 0) {
                setDbPacientes(patients);
                setDbStatus('ready');
            } else {
                setDbStatus('empty');
            }
        } catch (e) {
            console.error("Error cargando BD", e);
            setDbStatus('empty');
        }
    };
    initDB();
  }, []);
  const clearDatabase = async () => {
      if(window.confirm("¬øEst√°s seguro de que deseas borrar la base de datos de pacientes local? Tendr√°s que subir el archivo nuevamente.")) {
          await idb.clearPatients();
          setDbPacientes([]);
          setDbStatus('empty');
          alert("Base de datos limpiada.");
      }
  };

  const isInvalidCombo = useMemo(() => {
        const { condEst, condServ } = patientData;
        if (!condEst || !condServ) return false;
        if ( (condEst === 'R' && condServ === 'C') || (condEst === 'N' && condServ === 'C') || (condEst === 'N' && condServ === 'R') ) return true;
        return false;
  }, [patientData.condEst, patientData.condServ]);
  useEffect(() => {
    const p = parseFloat(clinicalData.peso);
    const t = parseFloat(clinicalData.talla);
    const anios = typeof ageObj.y === 'number' ? ageObj.y : 0;

    // 1. C√ÅLCULO DEL IMC MATEM√ÅTICO (Solo si es mayor de 5 a√±os)
    let imcCalc = "";
    if (anios >= 5 && p > 0 && t > 0) {
        const t_m = t / 100;
        imcCalc = (p / (t_m * t_m)).toFixed(2);
    }

    // 2. CLASIFICACI√ìN / DIAGN√ìSTICO SEG√öN GRUPO ETARIO
    let dx = "";
    
    if (imcCalc) {
        const imcVal = parseFloat(imcCalc);

        // CASO A: ADULTO MAYOR (60 A√ëOS A M√ÅS) - RM N¬∞ 240-2013/MINSA
        // Rangos especiales: Delgadez <23, Normal 23-27.9, Sobrepeso 28-31.9
        if (anios >= 60) {
            if (imcVal < 23.0) dx = "DELGADEZ";
            else if (imcVal <= 27.9) dx = "NORMAL";
            else if (imcVal <= 31.9) dx = "SOBREPESO";
            else dx = "OBESIDAD";
        }
        
        // CASO B: ADULTO JOVEN Y MADURO (20 A 59 A√ëOS) - EST√ÅNDAR OMS
        // Rangos est√°ndar: Bajo <18.5, Normal 18.5-24.9, Sobrepeso 25-29.9
        else if (anios >= 20) {
            if (imcVal < 18.5) dx = "BAJO PESO";
            else if (imcVal <= 24.9) dx = "NORMAL";
            else if (imcVal <= 29.9) dx = "SOBREPESO";
            else if (imcVal <= 34.9) dx = "OBESIDAD I";
            else if (imcVal <= 39.9) dx = "OBESIDAD II";
            else dx = "OBESIDAD III";
        }
        
        // CASO C: ESCOLAR Y ADOLESCENTE (5 A 19 A√ëOS) - NTS N¬∞ 157
        // Requiere Gr√°ficas/Tablas (Z-Score). No se clasifica solo con el n√∫mero.
        else {
            dx = "VER TABLA Z"; 
        }
    }

    // 3. ACTUALIZACI√ìN DEL ESTADO (IMC + RIESGO)
    setClinicalData(prev => ({ 
        ...prev, 
        imc: imcCalc,
        riesgo: dx // Aqu√≠ se llena autom√°ticamente el input de la derecha
    }));

  }, [clinicalData.peso, clinicalData.talla, ageObj.y]);
  useEffect(() => { if (patientData.condicion !== 'GESTANTE') setPatientData(prev => ({...prev, fur: ''})); }, [patientData.condicion]);
  useEffect(() => { if (adminData.isConfigured) setPatientData(prev => ({...prev, estAtencion: adminData.establecimiento})); }, [adminData.isConfigured, adminData.establecimiento]);
  useEffect(() => { setAnemiaResult(""); setAnemiaColor("bg-slate-200 text-slate-500"); setHbAdjusted(null); }, [patientData.dni]);
    // --- NUEVA L√ìGICA PROACTIVA: DETECTAR GESTANTE POR FUR ---
 // --- NUEVA L√ìGICA PROACTIVA: DETECTAR GESTANTE POR FUR (CORREGIDO) ---
  useEffect(() => {
      // Solo si estamos en el Paso 1, hay una FUR v√°lida y la condici√≥n no est√° definida
      if (step === 1 && patientData.fur && (!patientData.condicion || patientData.condicion === 'NINGUNA')) {
          
          // Peque√±o delay para que no choque con la renderizaci√≥n
          const timer = setTimeout(() => {
              const confirmacion = window.confirm(
                  `‚ö†Ô∏è ATENCI√ìN: Sra. ${patientData.paciente}\n\n` +
                  `El sistema detect√≥ una Fecha de √öltima Regla (FUR): ${patientData.fur}\n\n` +
                  `¬øLa paciente contin√∫a con la condici√≥n de GESTANTE?\n` +
                  `[Aceptar] = S√ç, marcar como GESTANTE.\n` +
                  `[Cancelar] = NO, borrar fecha y continuar.`
              );

              if (confirmacion) {
                  // Opci√≥n S√ç: Marcar como GESTANTE
                  setPatientData(prev => ({ ...prev, condicion: 'GESTANTE' }));
              } else {
                  // Opci√≥n NO: Borrar FUR y dejar Condici√≥n vac√≠a
                  setPatientData(prev => ({ ...prev, fur: '', condicion: '' }));
              }
          }, 200);
          
          return () => clearTimeout(timer); // Limpieza del timer
      }
  }, [patientData.fur, step]); // Se ejecuta cuando cambia la FUR o el paso
  const handleFileUpload = (e, type) => {
    try {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const wb = XLSX.read(evt.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
          if (type === 'pacientes') {
            const procesados = rawData.slice(1).map(r => {
                if (!r[0] && !r[1]) return null;
                const historyRange = [];
                for(let i=9; i<=13; i++) { if(r[i]) historyRange.push(String(r[i]).trim().toUpperCase()); }

                return {
                    dni: r[0] ? String(r[0]).trim().padStart(8, '0') : "", 
                    nombre: r[1] ? String(r[1]).trim() : "", 
                    fecNac: r[2], 
                    sexo: r[3] ? String(r[3]).trim() : "M", 
                    financiador: r[4] ? String(r[4]).trim() : "SIS", 
                    hc: r[5] ? String(r[5]).trim().replace(/^'/, '') : "", 
                    distrito: r[6] ? String(r[6]).trim() : "", 
                    direccion: r[7] ? String(r[7]).trim() : "", 
                    estOrigen: r[8] ? String(r[8]).trim() : "", 
                    historialEst: historyRange,
                    
                    last_fec_talla: r[14], last_talla: r[15],
                    last_fec_peso:  r[16], last_peso:  r[17],
                    last_fec_pabd:  r[18], last_pabd:  r[19],
                    last_fec_pcef:  r[20], last_pcef:  r[21],
                    last_fec_hb:    r[22], last_hb:    r[23],
                    last_fur:       r[24],
                    last_fec_ppreg: r[25], last_ppreg: r[26],

                    busqueda: ((r[0] ? String(r[0]).trim().padStart(8, '0') : "") + " " + String(r[1]||"")).toUpperCase()
                };
            }).filter(p => p !== null);
            
            await idb.savePatients(procesados);
            setDbPacientes(procesados);
            setDbStatus('ready');
            alert(`‚úÖ BASE DE DATOS ACTUALIZADA: ${procesados.length} pacientes cargados con sus hist√≥ricos.`);
          } else if (type === 'cie10') {
            const procesados = rawData.slice(1).map(r => ({ CODIGO: r[0] ? String(r[0]).trim() : "", DESCRIPCION: r[1] ? String(r[1]).trim() : "", BUSQUEDA: (String(r[0]||"") + " " + String(r[1]||"")).toUpperCase() })).filter(d => d.CODIGO);
            setDbCie10(procesados);
            alert(`‚úÖ ${procesados.length} diagn√≥sticos cargados.`);
          } else if (type === 'personal') {
            const procesados = rawData.slice(1).map(r => ({ dni: r[0] ? String(r[0]).trim() : "", nombre: r[1] ? String(r[1]).trim() : "" })).filter(p => p.dni);
            setDbPersonal(procesados);
            alert(`‚úÖ ${procesados.length} personal cargado.`);
          }
        } catch (err) { alert("Error leyendo el archivo: " + err.message);
        }
      };
      reader.readAsBinaryString(file);
    } catch (error) { alert("Error subiendo el archivo: " + error.message);
    }
  };

  const handleFollowUpUpload = (e, type) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (data.length > 0) {
            const headers = data[0];
            const rows = data.slice(1).map((r, i) => {
                let obj = { id: i };
                headers.forEach((h, index) => { obj[h] = r[index] !== undefined ? r[index] : ""; });
                obj.searchStr = Object.values(obj).join(" ").toUpperCase();
                return obj;
             });
            setFollowUpData(prev => ({ ...prev, [type]: rows }));
        }
      } catch (err) { alert("Error al leer Excel: " + err.message);
      }
    };
    reader.readAsBinaryString(file);
  };
  const handleSearchInput = (e) => {
      const val = e.target.value.toUpperCase();
      setSearchTerm(val);

      // 1. SI BORRAS TODO, RESETEA EL FORMULARIO
      if (val === "") {
          setPatientData(initialPatient); 
          setClinicalData(initialClinical);
          setDiagnoses([{ desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]);
          setIsPatientDataLocked(false);
          setSuggestions([]);
          setShowSuggestions(false);
          return;
      }

      // 2. BUSCAR SOLO EN BASE DE DATOS LOCAL (dbPacientes)
      // Usamos dbPacientes que son los que T√ö has guardado o registrado manualmente
      if (val.length > 1 && dbPacientes.length > 0) {
        const resultados = dbPacientes.filter(p => p.busqueda.includes(val)).slice(0, 10);
        setSuggestions(resultados);
        setShowSuggestions(true);
      } else { 
        setSuggestions([]); 
        setShowSuggestions(false); 
      }
  };  
  const parseExcelDate = (d) => {
    if (!d) return '2000-01-01';
    try {
      if (typeof d === 'number') { const date = new Date(Math.round((d - 25569)*86400*1000));
      date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); return !isNaN(date.getTime()) ? date.toISOString().split('T')[0] : '2000-01-01'; }
      if (typeof d === 'string') { if(d.includes('/')) { const p = d.split('/');
      if (p.length === 3) return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; } if(d.includes('-') && !isNaN(Date.parse(d))) return d;
      }
    } catch (e) { return '2000-01-01'; }
    return '2000-01-01'; 
  };
  const cleanStr = (str) => { if (!str) return ""; return str.replace(/[^A-Z0-9]/g, ''); };
  const getHighlightedText = (text, highlight) => {
      if (!highlight || !text) return text;
      const parts = text.toString().split(new RegExp(`(${highlight})`, 'gi'));
      return parts.map((part, i) => 
          part.toLowerCase() === highlight.toLowerCase() ? 
          <span key={i} className="text-blue-600 font-black bg-blue-50/50 rounded px-0.5">{part}</span> : part
      );
  };
  const selectPatient = (p) => {
      setShowSuggestions(false); 
      setSuggestions([]); 
      
      // 1. DETECCI√ìN DE JURISDICCI√ìN
      let estConfigRaw = adminData.establecimiento.trim().toUpperCase();
      let estPatientRaw = p.estOrigen ? p.estOrigen.trim().toUpperCase() : "";
      
      let keyword = "";
      if (estConfigRaw.includes("PACAIPAMPA")) keyword = "PACAIPAMPA";
      else if (estConfigRaw.includes("PUERTO")) keyword = "PUERTO";
      else if (estConfigRaw.includes("LAGUNAS")) keyword = "LAGUNAS";
      else if (estConfigRaw.includes("CUMBICUS")) keyword = "CUMBICUS";
      else if (estConfigRaw.includes("CACHIACO")) keyword = "CACHIACO";
      else keyword = estConfigRaw;

      const isSameJurisdiction = estPatientRaw.includes(keyword);

      // 2. PREPARAR DATOS COMUNES
      setSearchTerm(p.nombre || "");
      const safeFecNac = parseExcelDate(p.fecNac);
      
      // Alerta Adolescente
      const currentAgeObj = getAgeComponents(safeFecNac, patientData.fecAtencion);
      if (currentAgeObj.y >= 12 && currentAgeObj.y <= 17) {
          setShowAdolescentModal(true);
      }

      // Cargar Historial Cl√≠nico Previo
      const formatLastDate = (val) => {
          if(!val) return "-";
          const isoDate = parseExcelDate(val); 
          if (!isoDate || isoDate === '2000-01-01') return "-";
          const partes = isoDate.split('-'); 
          if(partes.length === 3) return `${partes[2]}/${partes[1]}/${partes[0]}`; 
          return isoDate;
      };

      setLastClinicalData({
          talla: { val: p.last_talla, date: formatLastDate(p.last_fec_talla) },
          peso:  { val: p.last_peso,  date: formatLastDate(p.last_fec_peso) },
          pAbd:  { val: p.last_pabd,  date: formatLastDate(p.last_fec_pabd) },
          pCef:  { val: p.last_pcef,  date: formatLastDate(p.last_fec_pcef) },
          hb:    { val: p.last_hb,    date: formatLastDate(p.last_fec_hb) },
          pPreg: { val: p.last_ppreg, date: formatLastDate(p.last_fec_ppreg) }
      });

      // --- VERIFICAR SI FALTAN DATOS CR√çTICOS (HC o DIRECCI√ìN) ---
      const faltaHC = !p.hc || String(p.hc).trim() === "";
      const faltaDir = !p.direccion || String(p.direccion).trim() === "";
      const necesitaEdicion = faltaHC || faltaDir;

      // 3. L√ìGICA DE CARGA
      if (isSameJurisdiction) {
          const esContinuador = p.historialEst.some(h => cleanStr(h).includes(cleanStr(keyword)));
          
          setPatientData(prev => ({ 
              ...prev,
              id: p.id, 
              dni: p.dni || "", 
              paciente: p.nombre || "", 
              hc: p.hc || "", 
              fecNac: safeFecNac, 
              sexo: p.sexo || 'M', 
              financiador: p.financiador || '2-SIS', 
              direccion: p.direccion || '', 
              distrito: p.distrito || '', 
              estOrigen: p.estOrigen || '', 
              condicion: '', 
              fur: p.last_fur ? parseExcelDate(p.last_fur) : '', 
              condEst: esContinuador ? "C" : "R", 
              condServ: '' 
          }));
          
          // L√ìGICA SOLICITADA: SI FALTAN DATOS -> DESBLOQUEAR AUTOM√ÅTICAMENTE
          setIsPatientDataLocked(!necesitaEdicion); 

      } else {
          setPatientData(prev => ({ 
              ...prev,
              id: p.id, 
              dni: p.dni || "", 
              paciente: p.nombre || "", 
              fecNac: safeFecNac, 
              sexo: p.sexo || 'M', 
              financiador: p.financiador || '2-SIS', 
              direccion: p.direccion || '', 
              distrito: p.distrito || '', 
              condicion: '', 
              fur: p.last_fur ? parseExcelDate(p.last_fur) : '', 
              estOrigen: adminData.establecimiento, 
              hc: "",                        
              condEst: 'N',                   
              condServ: 'N'                   
          }));

          setIsPatientDataLocked(false); // Siempre desbloqueado si viene de fuera

          setValidationAlert({
              isOpen: true,
              type: 'TRANSFER', 
              title: 'Paciente de Otro Establecimiento',
              message: `El paciente pertenece a: "${p.estOrigen || 'DESCONOCIDO'}".\nSe proceder√° a registrar en: "${adminData.establecimiento}".`,
              details: '‚úÖ Se han cargado sus datos personales.\n‚úÖ La condici√≥n cambi√≥ autom√°ticamente a NUEVO.\n‚úèÔ∏è POR FAVOR: Ingrese el N¬∞ de HISTORIA CL√çNICA de este establecimiento.'
          });
      }
      
      // Auto-Focus inteligente: Si falta HC, ir ah√≠. Si falta Direcci√≥n (y hay HC), ir ah√≠.
      setTimeout(() => { 
          const hcInput = document.querySelector('input[name="hc"]');
          const dirInput = document.querySelector('input[name="direccion"]');
          
          if (faltaHC && hcInput) {
               hcInput.focus();
          } else if (faltaDir && dirInput) {
               dirInput.focus();
          }
      }, 200);
  };
  const checkRowValidity = (row) => { return (row.desc && row.desc.trim() !== '' && row.tipo && row.tipo !== '-' && row.tipo !== '' && row.codigo && row.codigo.trim() !== '');
  };
  const openDxSearch = (index) => { setCurrentDxRow(index); const existing = diagnoses[index];
  setTempDx({ desc: existing.desc || '', codigo: existing.codigo || '', tipo: (existing.tipo && existing.tipo !== '-') ? existing.tipo : 'D', lab1: existing.lab1 || '', lab2: existing.lab2 || '', lab3: existing.lab3 || '' });
  setModalSearchTerm(""); setModalSuggestions([]); setIsDxModalOpen(true); };
  
  const handleModalSearch = (val) => { 
    setModalSearchTerm(val); 
    const upperVal = val.toUpperCase();
    setTempDx(prev => ({ ...prev, desc: upperVal })); 
    
    if (upperVal.length > 1) { 
        const matches = dbCie10.filter(item => {
            if (item.BUSQUEDA && item.BUSQUEDA.includes(upperVal)) return true;
            if (item.CODIGO && String(item.CODIGO).includes(upperVal)) return true;
            if (item.DESCRIPCION && item.DESCRIPCION.includes(upperVal)) return true;
            return false;
        }).slice(0, 20);
        setModalSuggestions(matches); 
    } else { 
        setModalSuggestions([]); 
    } 
  };
  const selectModalDx = (item) => { 
      setTempDx(prev => ({ 
          ...prev, 
          desc: item.DESCRIPCION, 
          codigo: item.CODIGO, 
          lab1: item.LAB1 || '', 
          lab2: item.LAB2 || '',
          tipo: item.TIPO || prev.tipo || 'D'
      }));
      setModalSearchTerm(item.DESCRIPCION); 
      setModalSuggestions([]); 
  };

  const saveModalSelection = () => { if (!tempDx.desc || !tempDx.codigo) { alert("Debe seleccionar un diagn√≥stico v√°lido."); return;
  } const newDiagnoses = [...diagnoses]; newDiagnoses[currentDxRow] = { ...tempDx }; setDiagnoses(newDiagnoses); if (dxErrors[currentDxRow]) { const newErrors = { ...dxErrors };
  delete newErrors[currentDxRow]; setDxErrors(newErrors); } setIsDxModalOpen(false); };
  const handleAdmin = (e) => { const name = e.target.name; const val = e.target.value;
  if (name === 'dniResp') { const encontrado = dbPersonal.find(p => p.dni === val.trim());
  if (encontrado) { setAdminData(prev => ({ ...prev, dniResp: val, nombreResp: encontrado.nombre }));
  } else { setAdminData(prev => ({ ...prev, dniResp: val })); } } else { setAdminData({ ...adminData, [name]: val });
  } };
  
  const handlePatient = (e) => {
      const { name, value } = e.target;
      let finalValue = value;

      // --- VALIDACI√ìN DE GESTANTE / PU√âRPERA ---
      if (name === "condicion" && (value === "GESTANTE" || value === "PUERPERA")) {
          const sexo = patientData.sexo ? patientData.sexo.toUpperCase() : "";
          const esHombre = sexo === "M" || sexo === "MASCULINO";

          // 1. REGLA ABSOLUTA: HOMBRES NO PUEDEN SER GESTANTES
          if (esHombre) {
              alert(`‚õî ERROR DE SEXO\n\nEl paciente est√° registrado como MASCULINO.\nNo puede asignarle la condici√≥n de ${value}.`);
              return; // DETIENE EL CAMBIO (El select no cambiar√°)
          }

          // 2. REGLA DE EDAD F√âRTIL (Aproximada 10-55 a√±os)
          const currentAge = getAgeComponents(patientData.fecNac, patientData.fecAtencion).y;
          if (currentAge < 10 || currentAge > 55) {
               alert(`‚ö†Ô∏è ALERTA DE EDAD\n\nLa paciente tiene ${currentAge} a√±os.\nVerifique si realmente corresponde la condici√≥n de ${value}.`);
               // Aqu√≠ no hacemos return, solo avisamos, por si es un caso excepcional.
          }
      }

      if (['direccion', 'distrito', 'estOrigen'].includes(name)) { 
          finalValue = value.toUpperCase();
      }
      
      setPatientData(prev => ({ ...prev, [name]: finalValue }));
  };
  const handleClinical = (e) => setClinicalData({ ...clinicalData, [e.target.name]: e.target.value });
  const handleNumericInput = (e, min, max) => {
      let val = e.target.value;
      if (val === '') { setClinicalData({ ...clinicalData, [e.target.name]: '' }); return; }
      if (!/^\d*\.?\d*$/.test(val)) return;
      const numVal = parseFloat(val);
      if (!isNaN(numVal)) { if (numVal > max) return;
      }
      setClinicalData({ ...clinicalData, [e.target.name]: val });
  };
  const handleSaveManualPatient = async () => {
      // --- VALIDACI√ìN DE CAMPOS VAC√çOS ---
      if (
          !manualData.dni || 
          !manualData.nombres || 
          !manualData.hc || 
          !manualData.fecNac ||
          !manualData.sexo || 
          !manualData.direccion || 
          !manualData.distrito || 
          !manualData.estOrigen || 
          !manualData.financiador
      ) {
          return alert("‚ö†Ô∏è TODOS LOS CAMPOS SON OBLIGATORIOS\n\nPor favor complete toda la informaci√≥n del formulario para poder guardar.");
      }

      const nuevoPacienteBD = {
          dni: manualData.dni.trim(),
          nombre: manualData.nombres.trim().toUpperCase(),
          fecNac: manualData.fecNac,
          sexo: manualData.sexo,
          financiador: manualData.financiador,
          hc: manualData.hc,
          distrito: manualData.distrito.trim().toUpperCase(),
          direccion: manualData.direccion.trim().toUpperCase(),
          estOrigen: manualData.estOrigen.trim().toUpperCase(),
          historialEst: [adminData.establecimiento], 
          busqueda: (manualData.dni.trim() + " " + manualData.nombres.trim()).toUpperCase()
      };
      
      try {
          await idb.addPatient(nuevoPacienteBD);
          markAsContinuadorOnSave(nuevoPacienteBD); 
          setDbPacientes(prev => [...prev, nuevoPacienteBD]);
          
          setPatientData(prev => ({ 
              ...prev, 
              dni: manualData.dni, 
              paciente: manualData.nombres.toUpperCase(), 
              hc: manualData.hc, 
              fecNac: manualData.fecNac, 
              sexo: manualData.sexo, 
              financiador: manualData.financiador, 
              direccion: manualData.direccion.toUpperCase(), 
              distrito: manualData.distrito.toUpperCase(), 
              estOrigen: manualData.estOrigen.toUpperCase(), 
              condEst: 'N', 
              condServ: 'N' 
          }));

          setSearchTerm(manualData.nombres.toUpperCase());
          setIsPatientDataLocked(true);
          setIsManualModalOpen(false);
          
          // Reseteamos con valores por defecto seguros
          setManualData({ dni: '', nombres: '', fecNac: '2000-01-01', sexo: 'M', hc: '', distrito: '', direccion: '', financiador: '2-SIS', estOrigen: '' });
          alert("‚úÖ Paciente registrado. En futuras b√∫squedas aparecer√° como CONTINUADOR.");

      } catch (error) {
          console.error(error);
          alert("Error al guardar el paciente en la base de datos.");
      }
  };
  const calculateAnemiaSimple = () => { 
      if (!clinicalData.hb || !anemiaLocation) return alert("Ingrese HB y seleccione localidad");
      const hb = parseFloat(clinicalData.hb); 
      const altitud = LOCALIDADES_ALTITUD[anemiaLocation] || 0; 
      let factorAjuste = 0;
      if (altitud >= 1000) { const valor = (altitud * 0.00328);
      const ajusteCalc = -0.032 * valor + 0.022 * (valor * valor); factorAjuste = Math.round(ajusteCalc * 10) / 10;
      if(factorAjuste < 0) factorAjuste = 0; } 
      const realHb = hb - factorAjuste; 
      setHbAdjusted(realHb.toFixed(1));
      let result = "SIN ANEMIA"; 
      let color = "bg-green-100 text-green-700 border-green-200"; 

      const { y, m } = ageObj;
      const months = (y * 12) + m; 
      const isPregnant = patientData.condicion === "GESTANTE"; 
      const isPuerpera = patientData.condicion === "PUERPERA";
      const isMale = patientData.sexo === "M"; 

      if (isPremature && months < 6) { if (realHb < 11.0) { result = "ANEMIA (PREMATURO)";
      color = "bg-purple-100 text-purple-700 border-purple-200"; } }
      else if (months >= 6 && months <= 59) { if (realHb < 7.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 7.0 && realHb <= 9.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 10.0 && realHb <= 10.9) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } } 
      else if (months >= 60 && months <= 131) { if (realHb < 8.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.4) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } } 
      else if (months >= 144 && months <= 179) { if (realHb < 8.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.9) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } } 
      else if (months >= 180) { if (isMale) { if (realHb < 8.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 12.9) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } } else if (!isPregnant && !isPuerpera) { if (realHb < 8.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.9) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } } } 
      if (isPregnant) { if (realHb < 7.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 7.0 && realHb <= 9.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 10.0 && realHb <= 10.9) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } else { result = "SIN ANEMIA"; color = "bg-green-100 text-green-700 border-green-200";
      } } 
      if (isPuerpera) { if (realHb < 8.0) { result = "ANEMIA SEVERA";
      color = "bg-red-600 text-white"; } else if (realHb >= 8.0 && realHb <= 10.9) { result = "ANEMIA MODERADA";
      color = "bg-orange-500 text-white"; } else if (realHb >= 11.0 && realHb <= 11.9) { result = "ANEMIA LEVE";
      color = "bg-yellow-400 text-black"; } else { result = "SIN ANEMIA"; color = "bg-green-100 text-green-700 border-green-200";
      } } 
      
      setAnemiaResult(result); 
      setAnemiaColor(color);
      setClinicalData(prev => ({...prev, nivHb: result, dosaje: realHb.toFixed(1)})); 
  };

  const addDx = () => { 
      const newIndex = diagnoses.length; 
      
      // 1. Agregamos la fila a la lista con tipo 'D' por defecto
      setDiagnoses([...diagnoses, { desc: '', tipo: 'D', lab1: '', lab2: '', lab3: '', codigo: '' }]);
      
      // 2. Preparamos el modal con tipo 'D' por defecto tambi√©n
      setCurrentDxRow(newIndex);
      setTempDx({ desc: '', tipo: 'D', lab1: '', lab2: '', lab3: '', codigo: '' });
      setModalSearchTerm(""); 
      setModalSuggestions([]); 
      
      // 3. Abrimos el modal y hacemos scroll
      setIsDxModalOpen(true);
      setTimeout(() => { if (dxBottomRef.current) { dxBottomRef.current.scrollIntoView({ behavior: 'smooth' }); } }, 100); 
  };
  const removeDx = (i) => setDiagnoses(diagnoses.filter((_, idx) => idx !== i));
  const updateToContinuador = (idPaciente) => {
      if (!idPaciente) return;
      setDbPacientes(prev => prev.map(p => {
          if (p.id === idPaciente) {
              const nuevoHistorial = p.historialEst ? [...p.historialEst] : [];
              if (!nuevoHistorial.includes(adminData.establecimiento)) {
                  nuevoHistorial.push(adminData.establecimiento);
              }
              return { ...p, condEst: 'C', historialEst: nuevoHistorial };
          }
          return p;
      }));
      const request = indexedDB.open(DB_NAME, 1);
      request.onsuccess = (e) => {
          const db = e.target.result;
          const tx = db.transaction([STORE_PACIENTES], 'readwrite');
          const store = tx.objectStore(STORE_PACIENTES);
          const getReq = store.get(idPaciente);
          getReq.onsuccess = () => {
              const record = getReq.result;
              if (record) {
                  record.condEst = 'C';
                  if (!record.historialEst) record.historialEst = [];
                  if (!record.historialEst.includes(adminData.establecimiento)) {
                      record.historialEst.push(adminData.establecimiento);
                  }
                  store.put(record);
              }
          };
      };
  };
  const markAsContinuadorOnSave = (datosPaciente) => {
      if (!datosPaciente.id && !datosPaciente.dni) return;
      // CORRECCI√ìN: Usar setDbPacientes en lugar de setAllPatients
      setDbPacientes(prevLista => prevLista.map(p => {
          if ((p.id && p.id === datosPaciente.id) || (p.dni && p.dni === datosPaciente.dni)) {
              return { ...p, condEst: 'C' }; 
          }
          return p;
      }));
      const request = indexedDB.open(DB_NAME, 1);
      request.onsuccess = (e) => {
          const db = e.target.result;
          const tx = db.transaction([STORE_PACIENTES], 'readwrite');
          const store = tx.objectStore(STORE_PACIENTES);
          if (datosPaciente.id) {
              const getReq = store.get(datosPaciente.id);
              getReq.onsuccess = () => {
                  const record = getReq.result;
                  if (record && (record.condEst === 'N' || record.condEst === 'R')) {
                      record.condEst = 'C';
                      store.put(record); 
                  }
              };
          }
      };
  };

  const validateDiagnoses = () => {
    if (!patientData.paciente || patientData.paciente.trim() === "") return true;
    for (let i = 0; i < diagnoses.length; i++) {
        const d = diagnoses[i];
        if(!d.codigo) continue; 
        const code = d.codigo.trim().toUpperCase();

        if (code === 'D509') {
            const validLabs = ['LEV', 'MOD', 'SEV'];
            if (!validLabs.includes(d.lab1)) {
                setValidationAlert({
                    isOpen: true,
                    type: 'ANEMIA',
                    title: 'Validaci√≥n de Anemia (D509)',
                    message: `En la fila ${i + 1}, el diagn√≥stico ANEMIA (D509) requiere especificar la severidad en el campo LAB 1.`,
                    details: 'Valores permitidos: LEV, MOD o SEV.'
                });
                return false;
            }
        } 

        if (['85018', '85018.01'].includes(code)) {
            const valorHb = clinicalData.hb;
            if (!valorHb || valorHb === '' || parseFloat(valorHb) === 0) {
                 setValidationAlert({
                    isOpen: true,
                    type: 'LAB_MISSING', 
                    title: 'Falta Resultado de Hemoglobina',
                    message: `En la fila ${i + 1}, ha registrado el procedimiento de Dosaje (${code}), pero no ingres√≥ el resultado.`,
                    details: 'El sistema detect√≥ que el campo "Hemoglobina" en los Datos Cl√≠nicos (Paso 2) est√° vac√≠o.\n\nRECUERDA QUE EL VALOR DE HEMOGLOBINA SE DEBE REGISTRAR SIN DESCUENTO.'
                });
                return false; 
            }
        }

        if (['Z3591', 'Z3592', 'Z3593'].includes(code)) {
            if (!d.lab1 || !d.lab2) {
                 setValidationAlert({
                    isOpen: true,
                    type: 'GESTANTE',
                    title: 'Supervisi√≥n de Embarazo (Riesgo)',
                    message: `En la fila ${i + 1}, el c√≥digo ${code} requiere completar ambos campos de laboratorio.`,
                    details: 'LAB 1: N√∫mero de Control Prenatal\nLAB 2: Semanas de Gestaci√≥n'
                  });
                return false;
            }
        }

        const femalePrefixes = ['O', 'Z34', 'Z35', 'N70', 'N71', 'N72', 'N73', 'N75', 'N76', 'Z32', 'Z39'];
        const malePrefixes = ['N40', 'N41', 'N42', 'N43', 'N44', 'N45', 'N49', 'N50'];
        if (patientData.sexo === 'M') {
            if (femalePrefixes.some(pre => code.startsWith(pre))) {
                setValidationAlert({
                    isOpen: true,
                    type: 'SEX_MISMATCH',
                    title: 'Inconsistencia de Sexo',
                    message: `En la fila ${i + 1}, el c√≥digo ${code} es exclusivo para pacientes de sexo FEMENINO.`,
                    details: `El paciente actual est√° registrado como MASCULINO.\nNo se puede registrar diagn√≥sticos ginecol√≥gicos o de embarazo en hombres.`
                });
                return false;
            }
        }

        if (patientData.sexo === 'F') {
            if (malePrefixes.some(pre => code.startsWith(pre))) {
                setValidationAlert({
                    isOpen: true,
                    type: 'SEX_MISMATCH',
                    title: 'Inconsistencia de Sexo',
                    message: `En la fila ${i + 1}, el c√≥digo ${code} es exclusivo para pacientes de sexo MASCULINO.`,
                    details: `La paciente actual est√° registrada como FEMENINO.\nNo se pueden registrar patolog√≠as de pr√≥stata o test√≠culos.`
                });
                return false;
            }
        }
    }
    return true;
  };
   useEffect(() => {
    if (step === 1 && patientData.dni) {
      const hcInput = document.querySelector('input[name="hc"]');
      
      const dniStr = String(patientData.dni).trim();
      const hcStr = String(patientData.hc || "").trim();

      // 1. L√ìGICA MATEM√ÅTICA: Convertimos a n√∫mero para ignorar ceros a la izquierda
      // Esto hace que "00373661" sea igual a "373661" -> DETECTA EL ERROR
      const dniNum = parseInt(dniStr, 10);
      const hcNum = parseInt(hcStr, 10);

      // Hay error si los n√∫meros coinciden (y son v√°lidos) O si el texto es id√©ntico
      const isError = ((dniNum === hcNum && dniNum > 0) || dniStr === hcStr) && hcStr.length > 0;

      if (isError) {
        // --- CASO ERROR: SON IGUALES (EL DNI NO DEBE SER LA HC) ---
        setIsPatientDataLocked(false); // 1. Activa el bot√≥n EDITAR autom√°ticamente

        
        if (hcInput) {
          // 2. Pinta de ROJO (Error cr√≠tico)
          hcInput.style.borderColor = "red"; 
          hcInput.style.backgroundColor = "#fee2e2";
          hcInput.style.borderWidth = "3px";
          hcInput.classList.add("animate-pulse"); 
          
          // 3. Manda el cursor dentro
          if (document.activeElement !== hcInput) {
             setTimeout(() => { hcInput.focus(); hcInput.select(); }, 150);
          }
        }
      } else if (hcStr.length > 0 && hcInput) {
        // --- CASO CORRECTO: SON DIFERENTES ---
        // 4. Se pinta de VERDE
        hcInput.style.borderColor = "#10b981";
        // Verde
        hcInput.style.backgroundColor = "#ecfdf5";
        // Fondo verde suave
        hcInput.style.borderWidth = "2px";
        hcInput.classList.remove("animate-pulse");
      }
    }
  }, [patientData.dni, patientData.hc, step]);
  const handleNextStep = () => {
    // Funci√≥n auxiliar visual para marcar errores
    const markError = (name) => {
        const input = document.querySelector(`[name="${name}"]`);
        if (input) {
            input.style.borderColor = "red";
            input.style.borderWidth = "2px";
            input.classList.add("animate-pulse");
            const eventType = input.tagName === 'SELECT' ? 'change' : 'input';
            input.addEventListener(eventType, () => {
                input.style.borderColor = ""; 
                input.style.borderWidth = ""; 
                input.classList.remove("animate-pulse");
            }, { once: true });
        }
    };

    // ========================================================================
    // PASO 1: L√ìGICA INTELIGENTE (SOLO VALIDA SI HAY DATOS)
    // ========================================================================
    if (step === 1) {
        // A. DETECCI√ìN: ¬øEl usuario escribi√≥ algo en DNI o Nombre?
        const hayDatos = (patientData.dni && patientData.dni.trim().length > 0) || 
                         (patientData.paciente && patientData.paciente.trim().length > 0);

        // B. SI NO HAY DATOS -> DEJAR PASAR (Navegaci√≥n libre entre ventanas)
        if (!hayDatos) {
            setStep(prev => prev + 1);
            return;
        }

        // C. SI HAY DATOS -> ENTONCES S√ç EXIGIMOS TODO (Modo estricto)
        
        // 1. Identidad
        if (!patientData.dni) { 
            alert("‚ö†Ô∏è FALTAN DATOS\nComplete el DNI."); 
            markError("dni"); return; 
        }
        if (!patientData.paciente) { 
            alert("‚ö†Ô∏è FALTAN DATOS\nComplete el Nombre."); 
            markError("paciente"); return; 
        }
        
        // 2. Fecha de Atenci√≥n
        if (!patientData.fecAtencion) { 
            alert("‚ö†Ô∏è FALTA FECHA DE ATENCI√ìN\n\nPor favor, seleccione la fecha para continuar."); 
            setIsCalendarOpen(true); // <--- ESTA L√çNEA ABRE EL CALENDARIO AUTOM√ÅTICAMENTE
            return; 
        }

        // 3. Condiciones (Establecimiento y Servicio)
        if (!patientData.condEst || patientData.condEst === "") { 
            alert("‚ö†Ô∏è FALTA CONDICI√ìN ESTABLECIMIENTO\nSeleccione: Nuevo, Continuador o Reingresante."); 
            markError("condEst"); return; 
        }
        if (!patientData.condServ || patientData.condServ === "") { 
            alert("‚ö†Ô∏è FALTA CONDICI√ìN SERVICIO\nSeleccione: Nuevo, Continuador o Reingresante."); 
            markError("condServ"); return; 
        }

        // --- VALIDACIONES DE CONSISTENCIA (TUS REGLAS ESPEC√çFICAS) ---
        
        // Caso 1: Si es NUEVO en Est., debe ser NUEVO en Serv.
        if (patientData.condEst === 'N' && patientData.condServ !== 'N') {
            alert("‚õî ERROR DE CONSISTENCIA\n\nSi el paciente es NUEVO en el establecimiento, obligatoriamente debe ser NUEVO en el servicio.\n\nCorrija 'Cond. Serv' a NUEVO.");
            markError("condServ"); return;
        }

        // Caso 2: Si es REINGRESANTE en Est., NO puede ser CONTINUADOR en Serv.
        if (patientData.condEst === 'R' && patientData.condServ === 'C') {
             alert("‚õî ERROR DE CONSISTENCIA\n\nUn paciente REINGRESANTE al establecimiento no puede ser CONTINUADOR en el servicio inmediatamente.\n\nSeleccione NUEVO o REINGRESANTE para el servicio.");
             markError("condServ"); return;
        }
        // --- NUEVA VALIDACI√ìN: GESTANTE Y FUR ---
        if (patientData.condicion === 'GESTANTE') {
            // 1. Validar que la FUR no est√© vac√≠a
            if (!patientData.fur) {
                alert("‚ö†Ô∏è ATENCI√ìN: GESTANTE SIN FUR\n\nAl seleccionar la condici√≥n 'GESTANTE', es OBLIGATORIO registrar la Fecha de √öltima Regla (FUR).");
                markError("fur"); 
                return;
            }

            // 2. Validar consistencia de fechas (FUR no puede ser mayor a Fecha de Atenci√≥n)
            const dFur = new Date(patientData.fur);
            // Usamos la fecha de atenci√≥n si existe, sino la fecha actual del sistema
            const dAtencion = patientData.fecAtencion ? new Date(patientData.fecAtencion) : new Date();
            
            // Normalizamos las horas a 00:00:00 para comparar solo d√≠as
            dFur.setHours(0,0,0,0); 
            dAtencion.setHours(0,0,0,0);

            if (dFur > dAtencion) {
                alert(`‚õî ERROR DE FECHAS\n\nLa FUR (${patientData.fur}) no puede ser una fecha futura respecto a la Fecha de Atenci√≥n (${patientData.fecAtencion}).\n\nPor favor corrija la fecha.`);
                markError("fur");
                return;
            }
        }
        // 4. Historia Cl√≠nica vs DNI
        const dniStr = String(patientData.dni).trim();
        const hcStr = String(patientData.hc || '').trim();
        const dniNum = parseInt(dniStr, 10);
        const hcNum = parseInt(hcStr, 10);

        if (!hcStr) { 
            alert("‚ö†Ô∏è FALTA HISTORIA CL√çNICA\nIngrese el N¬∞ de Historia cl√≠nica."); 
            markError("hc"); return; 
        }
        
        // Si son iguales, bloqueamos (usando tu l√≥gica original + num√©rica)
        if (dniStr === hcStr || (dniNum === hcNum && dniNum > 0)) {
             alert(`‚õî ERROR DE HISTORIA CL√çNICA\nLa H.C. (${hcStr}) es igual al DNI.\nEsto es incorrecto. Ingrese el N¬∞ DE HISTORIA CLINICA.`); 
             markError("hc"); setIsPatientDataLocked(false); return;
        }

        // 5. Direcci√≥n
        if (!patientData.direccion || patientData.direccion.trim().length < 2) { 
            alert("‚ö†Ô∏è FALTA DIRECCI√ìN\nEl campo direcci√≥n no puede estar vac√≠o."); 
            markError("direccion"); return; 
        }
    }

    // ========================================================================
    // PASO 2: VALIDACI√ìN M√âDICA INTELIGENTE (TU C√ìDIGO ORIGINAL INTACTO)
    // ========================================================================
     // ========================================================================
    // PASO 2: VALIDACI√ìN M√âDICA INTELIGENTE (CON RANGOS DE AYUDA)
    // ========================================================================
    if (step === 2) {
      const { talla, peso, hb, pAbd } = clinicalData;
      const t = talla ? parseFloat(talla) : null;
      const p = peso ? parseFloat(peso) : null;
      const { y, m, d } = ageObj;

      // --- GRUPO 1: RECI√âN NACIDO (0 a 28 d√≠as) ---
      if (y === 0 && m === 0 && d >= 0) {
          if (t && (t < 40 || t > 62)) { 
              alert(`‚õî TALLA IRREAL (Neonato)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 40 - 62 cm`); 
              markError("talla"); return; 
          }
          if (p && (p < 1.5 || p > 6)) { 
              alert(`‚õî PESO IRREAL (Neonato)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 1.5 - 6.0 kg`); 
              markError("peso"); return; 
          }
      }

      // --- GRUPO 2: LACTANTE (1 mes a 11 meses) ---
      else if (y === 0 && m > 0) {
          if (t && (t < 45 || t > 85)) { 
              alert(`‚õî TALLA IRREAL (Lactante)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 45 - 85 cm`); 
              markError("talla"); return; 
          }
          if (p && (p < 2.5 || p > 14)) { 
              alert(`‚õî PESO IRREAL (Lactante)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 2.5 - 14.0 kg`); 
              markError("peso"); return; 
          }
      }

      // --- GRUPO 3: NI√ëO PEQUE√ëO (1 a 4 a√±os) ---
      else if (y >= 1 && y < 5) {
          if (t && (t < 65 || t > 120)) { 
              alert(`‚õî TALLA IRREAL (Ni√±o ${y} a√±os)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 65 - 120 cm`); 
              markError("talla"); return; 
          }
          if (p && (p < 7 || p > 28)) { 
              alert(`‚õî PESO IRREAL (Ni√±o ${y} a√±os)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 7.0 - 28.0 kg`); 
              markError("peso"); return; 
          }
      }

      // --- GRUPO 4: ESCOLAR Y ADOLESCENTE (5 a 17 a√±os) ---
      else if (y >= 5 && y < 18) {
          if (t && (t < 95 || t > 210)) { 
              alert(`‚õî TALLA IRREAL (Paciente ${y} a√±os)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 95 - 210 cm`); 
              markError("talla"); return; 
          }
          if (p && (p < 12 || p > 130)) { 
              alert(`‚õî PESO IRREAL (Paciente ${y} a√±os)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 12.0 - 130.0 kg`); 
              markError("peso"); return; 
          }
      }

      // --- GRUPO 5: ADULTO (18 a√±os a m√°s) ---
      else if (y >= 18) {
          if (t && (t < 130 || t > 250)) { 
              alert(`‚õî TALLA INV√ÅLIDA (Adulto)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 130 - 250 cm`); 
              markError("talla"); return; 
          }
          if (p && (p < 35 || p > 300)) { 
              alert(`‚õî PESO INV√ÅLIDO (Adulto)\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 35.0 - 300.0 kg`); 
              markError("peso"); return; 
          }
      }

      // Validaciones Generales (Hemoglobina y Per√≠metro Abdominal)
      if (hb && (hb < 3 || hb > 24)) { 
          alert("‚õî HEMOGLOBINA ERR√ìNEA\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 3.0 - 24.0"); 
          markError("hb"); return; 
      }
      if (pAbd && (parseFloat(pAbd) < 10 || parseFloat(pAbd) > 200)) { 
          alert("‚õî P. ABDOMINAL ERR√ìNEO\nPOR FAVOR DEBE REGISTRAR VALORES ENTRE: 10 - 200 cm"); 
          markError("pAbd"); return; 
      }
    }

    // ========================================================================
    // PASO 3: VALIDACI√ìN CIE-10
    // ========================================================================
    if (step === 3) {
       // Si hay paciente pero no diagn√≥sticos -> Alerta
       if ((patientData.dni || patientData.paciente) && diagnoses.length === 0) { 
           alert("‚ö†Ô∏è FALTAN DIAGN√ìSTICOS"); return; 
       }
       
       // Si hay diagn√≥sticos, validamos reglas espec√≠ficas (D509, Sexo, Lab)
       if (diagnoses.length > 0) {
           if (!validateDiagnoses()) return; // Llama a tu funci√≥n externa
       }
       
       // Validaci√≥n extra de sexo por c√≥digo (tu l√≥gica original)
       for (let d of diagnoses) {
           const code = d.codigo.toUpperCase();
           if (code.startsWith('O') && patientData.sexo !== 'F') { 
               alert(`‚õî ERROR: C√≥digo ${code} es SOLO MUJERES.`); return; 
           }
       }
    }

    // AVANZAR
    setStep(prev => prev + 1);
  };
  
  const handleBack = () => { setDxErrors({}); setStep(s => s - 1); };
  const resetForm = () => { 
      setPatientData({ ...initialPatient, fecAtencion: '', estAtencion: adminData.establecimiento, condEst: '', condServ: '' });
      setClinicalData(initialClinical); 
      setDiagnoses([{ desc: '', tipo: '-', lab1: '', lab2: '', lab3: '', codigo: '' }]); 
      setSearchTerm(""); 
      setIsPatientDataLocked(false); 
      setDxErrors({}); 
      setAnemiaResult("");
      setIsPremature(false);
      setIgnorePreGestValidation(false);
      setShowPreGestError(false);
      setShowHbError(false);
      setIgnorePAbdValidation(false);
      setShowPAbdError(false);
      setIgnorePCefValidation(false);
      setShowPCefError(false);
      setLastClinicalData({});
      setIsDataVerified(false);
      setIsBatchFinished(false);
  };
  // 1. FUNCI√ìN PARA EL BOT√ìN "REVISAR LA INFORMACI√ìN"
  const handleReviewInfo = () => {
      setShowSaveConfirm(false);
      // Cierra la alerta
      setStep(1);
      // Regresa al paso 1 (Paciente)
      setIsCalendarOpen(false);
      // IMPORTANTE: Asegura que el calendario NO se abra
      // Nota: No llamamos a resetForm(), por lo que los datos se mantienen intactos.
  };

  // 2. FUNCI√ìN PARA EL BOT√ìN "S√ç, DESEO GUARDAR"
// 2. FUNCI√ìN PARA EL BOT√ìN "S√ç, DESEO GUARDAR" (L√ìGICA HIS CORREGIDA)
    // 2. FUNCI√ìN PARA EL BOT√ìN "S√ç, DESEO GUARDAR" (L√ìGICA INTELIGENTE)
   const confirmSavePatient = () => {
      // 1. Empaquetamos los datos actuales
      const newRecord = { 
          patient: { ...patientData }, 
          clinical: { ...clinicalData }, 
          diagnoses: [...diagnoses], 
          ageObj: { ...ageObj } 
      };

      // 2. Actualizamos la lista con filtro inteligente
      setSavedPatients(prev => {
          const index = prev.findIndex(p => 
              p.patient.dni === newRecord.patient.dni &&
              p.patient.fecAtencion === newRecord.patient.fecAtencion &&
              JSON.stringify(p.diagnoses) === JSON.stringify(newRecord.diagnoses)
          );

          if (index >= 0) {
              const updated = [...prev];
              updated[index] = newRecord;
              return updated;
          } else {
              return [...prev, newRecord];
          }
      });

      // 3. Actualizamos estado de "Continuador" en base de datos
      if (patientData.id) {
          updateToContinuador(patientData.id);
      } 
      
      // 4. Limpiamos y cerramos
      resetForm();
      setShowSaveConfirm(false); 
      alert("‚úÖ Registro guardado exitosamente."); 
  };

const generatePDF = () => {
    try {
        const allPatients = [...savedPatients];
        // --- L√ìGICA INTELIGENTE APLICADA AL PDF ---
        // Verificamos si hay un paciente en pantalla
        if (patientData.paciente) {
            // Revisamos si este paciente EXACTO (con mismos diagn√≥sticos y fecha) ya est√° guardado
            const yaExiste = savedPatients.some(p => 
                p.patient.dni === patientData.dni &&
                p.patient.fecAtencion === patientData.fecAtencion &&
                JSON.stringify(p.diagnoses) === JSON.stringify(diagnoses)
            );
            // Solo lo agregamos al PDF si NO existe en la lista de guardados (es decir, es nuevo o editado sin guardar)
            if (!yaExiste) {
                allPatients.push({ 
                    patient: patientData, 
                    clinical: clinicalData, 
                    diagnoses: diagnoses, 
                    ageObj: ageObj 
                });
            }
        }
        if(allPatients.length === 0) return alert("No hay datos para exportar.");
        const visualBlocks = [];
        let globalIndex = 1;

        allPatients.forEach(rec => {
            const { patient, clinical, diagnoses: dxs, ageObj: age } = rec;
            const totalChunks = Math.ceil(Math.max(1, dxs.length) / 3);

            for (let c = 0; c < totalChunks; c++) {
                const start = c * 3;
                const chunkDxs = dxs.slice(start, start + 3);
                while(chunkDxs.length < 3) chunkDxs.push({});

                visualBlocks.push({
                    index: globalIndex,
                    isFirstChunk: c === 0,
                    patient,
                    clinical,
                    age,
                    diagnoses: chunkDxs
                });
            
            }
            globalIndex++;
        });
        const doc = new jsPDF('p', 'mm', 'a4'); 
        
        doc.setFont("helvetica", "normal"); 
        doc.setDrawColor(50, 50, 50); 
        doc.setLineWidth(0.15);        

        const mx = 5;
        const my = 5; 
        
        const hRowName = 4.5; 
        const hRowData = 5.5; 
        const hBlock = hRowName + (hRowData * 3);
        const w = {
            idx: 6,   dia: 6,   dni: 14,  fin: 5,   dist: 28, 
            edad: 8,  sex: 5,   
            antL: 7,  antV: 8,
            est: 5,   serv: 5,
            dx: 55,   
            tipo: 6,  lab: 5,   cie: 13
        };
        const hHeaderSmall = 4; 
        
        const cell = (txt, x, y, cw, ch, styles = {}) => {
            const { fill, bold, align, fontSize, border, rotate, vAlign, textColor, wrap, drawColor } = styles;
            const originalDrawColor = doc.getDrawColor(); 

            if (drawColor) {
                doc.setDrawColor(drawColor[0], drawColor[1], drawColor[2]);
            }

            if (fill) { 
                doc.setFillColor(fill[0], fill[1], fill[2]);
                if (border === false) doc.rect(x, y, cw, ch, 'F'); 
                else doc.rect(x, y, cw, ch, 'FD');
            } 
            else if (border !== false) { 
                doc.rect(x, y, cw, ch);
            }

            if (drawColor) {
                doc.setDrawColor(originalDrawColor);
            }

            if (txt !== undefined && txt !== null && txt !== "") { 
                if(textColor) doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                else doc.setTextColor(0,0,0);

                doc.setFontSize(fontSize || 6);
                doc.setFont("helvetica", bold ? "bold" : "normal"); 
                
                let text = String(txt);
                const sensitiveLabels = ["Talla", "Peso", "HB", "P.C.", "P.Abd", "P.Preg", "a√±os", "meses", "d√≠as"];
                const isSensitive = sensitiveLabels.some(l => text.includes(l));
                if (!isSensitive && !styles.keepCase) text = text.toUpperCase();

                if (rotate) {
                    const xPos = x + (cw / 2);
                    const yPos = y + ch - 1.5;    
                    doc.text(text, xPos, yPos, { angle: 90, align: 'left' });
                } 
                else if (wrap) {
                    const lines = doc.splitTextToSize(text, cw - 1);
                    const lineHeight = (fontSize || 6) * 0.35; 
                    let yPos = y + 2.5;
                    lines.forEach((line) => {
                        if (yPos < y + ch) {
                            doc.text(line, x + 1, yPos);
                            yPos += lineHeight + 1; 
                         }
                    });
                } 
                else {
                    if (doc.getTextWidth(text) > cw - 1) { 
                        const charWidth = doc.getTextWidth("A");
                        const maxChars = Math.floor((cw - 1) / charWidth);
                        text = text.substring(0, maxChars) + "..";
                    }
                    
                    const txtWidth = doc.getTextWidth(text);
                    const xPos = align === 'left' ? x + 1 : 
                                 align === 'right' ?
                                 x + cw - 1 - txtWidth : 
                                 x + (cw / 2) - (txtWidth / 2);
                    let yPos = y + (ch / 2) + 1.2; 
                    if (vAlign === 'top') yPos = y + 2.5;
                    if (vAlign === 'middle') yPos = y + (ch / 2) + 1.2;
                    if (fontSize && fontSize < 6) yPos -= 0.1;

                    doc.text(text, xPos, yPos);
                }
            }
        };
        const drawHeader = (currY) => {
            let y = currY;
            const fullW = 201; 
            const xContent = mx + w.idx; 

            doc.setFontSize(6);
            cell("Lote:", xContent, y, 20, hHeaderSmall, {bold:true, border:false, align:'left'});
            cell("MINISTERIO DE SALUD", mx, y, fullW, hHeaderSmall, {bold:true, align:'center', fontSize:8, border:false});
            
            const grayColor = [180, 180, 180];
            cell("FIRMA Y SELLO", mx + 161, y, 40, hHeaderSmall, {
                align:'center', 
                border:false, 
                fontSize:5, 
                textColor: grayColor,
                keepCase: true 
             });
            y += hHeaderSmall;

            cell("Pag:", xContent, y, 20, hHeaderSmall, {bold:true, border:false, align:'left'});
            cell("OFICINA GENERAL DE ESTAD√çSTICA E INFORM√ÅTICA", mx, y, fullW, hHeaderSmall, {align:'center', fontSize:7, border:false});
            cell("DEL PERSONAL DE SALUD", mx + 161, y, 40, hHeaderSmall, {
                align:'center', 
                border:false, 
                fontSize:5, 
                textColor: grayColor
            });
            y += hHeaderSmall;

            cell("Reg:", xContent, y, 20, hHeaderSmall, {bold:true, border:false, align:'left'});
            cell("Registro Diario de Atenci√≥n y Otras Actividades de Salud", mx, y, fullW, hHeaderSmall, {align:'center', fontSize:7, border:false});
            
            doc.setDrawColor(180, 180, 180);
            doc.rect(mx + 161, y - (hHeaderSmall*2), 40, hHeaderSmall*4); 
            doc.setDrawColor(50, 50, 50); 
            
            y += hHeaderSmall + 1;
            const bgHead = [230, 230, 230]; 
            const hMeta = 6; 
            
            let cx = mx + w.idx;
            cell("A√ëO", cx, y, 10, hMeta, {fill:bgHead, bold:true, align:'center'}); cx+=10;
            cell("MES", cx, y, 20, hMeta, {fill:bgHead, bold:true, align:'center'}); cx+=20;
            cell("ESTABLECIMIENTO DE SALUD", cx, y, 45, hMeta, {fill:bgHead, bold:true, align:'center'}); cx+=45;
            cell("UNIDAD PRESTADORA (UPS)", cx, y, 35, hMeta, {fill:bgHead, bold:true, align:'center'}); cx+=35;
            cell("DNI RESP.", cx, y, 20, hMeta, {fill:bgHead, bold:true, align:'center'});
            cx+=20;
            cell("RESPONSABLE DE LAS ATENCIONES", cx, y, 45, hMeta, {fill:bgHead, bold:true, align:'center'}); cx+=45;
            cell("TURNO", cx, y, 20, hMeta, {fill:bgHead, bold:true, align:'center'}); 
            y += hMeta;

            cx = mx + w.idx;
            cell(adminData.anio, cx, y, 10, hMeta, {align:'center', bold:false, fontSize:7}); cx+=10;
            cell(adminData.mes, cx, y, 20, hMeta, {align:'center', bold:false, fontSize:7}); cx+=20;
            cell(adminData.establecimiento, cx, y, 45, hMeta, {align:'center', bold:false, fontSize:7}); cx+=45;
            cell(adminData.ups, cx, y, 35, hMeta, {align:'center', bold:false, fontSize:7}); cx+=35;
            cell(adminData.dniResp, cx, y, 20, hMeta, {align:'center', bold:false, fontSize:7}); cx+=20;
            cell(adminData.nombreResp, cx, y, 45, hMeta, {align:'center', bold:false, fontSize:7}); cx+=45;
            cell(adminData.turno, cx, y, 20, hMeta, {align:'center', bold:false, fontSize:7}); 
            y += hMeta + 2;

            const hTable = 12; 
            cx = mx;
            cell("", cx, y, w.idx, hTable, {border:false}); cx+=w.idx;
            cell("F.A", cx, y, w.dia, hTable, {fill:bgHead, bold:true, align:'center'}); cx+=w.dia;
            cell("D.N.I / H.C.", cx, y, w.dni, hTable, {fill:bgHead, bold:true, align:'center'}); cx+=w.dni;
            cell("FINANC.", cx, y, w.fin, hTable, {fill:bgHead, bold:true, rotate:true}); cx+=w.fin;
            cell("DISTRITO DE PROCEDENCIA", cx, y, w.dist, hTable, {fill:bgHead, bold:true, align:'center'}); cx+=w.dist;
            cell("EDAD", cx, y, w.edad, hTable, {fill:bgHead, bold:true, rotate:true}); cx+=w.edad;
            cell("SEXO", cx, y, w.sex, hTable, {fill:bgHead, bold:true, rotate:true}); cx+=w.sex;
            cell("ANTROPOMETR√çA", cx, y, (w.antL*2 + w.antV*2), hTable, {fill:bgHead, bold:true, align:'center'});
            cx+=(w.antL*2 + w.antV*2);
            cell("EST", cx, y, w.est, hTable, {fill:bgHead, bold:true, rotate:true}); cx+=w.est;
            cell("SERV", cx, y, w.serv, hTable, {fill:bgHead, bold:true, rotate:true});
            cx+=w.serv;
            cell("DIAGN√ìSTICO MOTIVO DE CONSULTA", cx, y, w.dx, hTable, {fill:bgHead, bold:true, align:'center'}); cx+=w.dx;
            cell("TIPO", cx, y, w.tipo, hTable, {fill:bgHead, bold:true, rotate:true}); cx+=w.tipo;
            cell("LAB", cx, y, w.lab * 3, hTable, {fill:bgHead, bold:true, align:'center'});
            cx+=(w.lab * 3);
            cell("C√ìDIGO", cx, y, w.cie, hTable, {fill:bgHead, bold:true, align:'center'}); 

            return y + hTable;
        };

        const BLOCKS_PER_PAGE = 11;
        const totalPages = Math.ceil(visualBlocks.length / BLOCKS_PER_PAGE) || 1;

        for (let page = 0; page < totalPages; page++) {
            if (page > 0) doc.addPage();
            let y = drawHeader(my);
            
            for (let i = 0; i < BLOCKS_PER_PAGE; i++) {
                const globalIdx = (page * BLOCKS_PER_PAGE) + i;
                const block = visualBlocks[globalIdx] || null;
                
                const p = block ? block.patient : {};
                const c = block ?
                block.clinical : {};
                const a = block ? block.age : {};
                const dxs = block ? block.diagnoses : [{},{},{}];
                const isFirst = block ? block.isFirstChunk : false;

                const d1 = dxs[0] || {};
                const d2 = dxs[1] || {};
                const d3 = dxs[2] || {};
                
                let cx = mx;
                
                const idxText = (block && isFirst) ? block.index : "";
                cell(idxText, cx, y, w.idx, hBlock, {align:'center', bold:true, vAlign:'middle', border:false, fontSize:8}); 
                cx += w.idx;
                if (isFirst) {
                    const wName = w.dia + w.dni + w.fin + w.dist;
                    cell(p.paciente, cx, y, wName, hRowName, {bold:true, align:'left', fontSize: 7.5, border: false}); cx += wName;
                    
                    const wFNLabel = w.edad + w.sex;
                    cell("F.N:", cx, y, wFNLabel, hRowName, {align:'right', bold:true, border: false, fontSize:6}); cx += wFNLabel;
                    
                    const wFNVal = w.antL + w.antV;
                    cell(p.fecNac, cx, y, wFNVal, hRowName, {align:'center', fill:[240,240,240], border:true, bold:true, fontSize:7}); cx += wFNVal;
                    const wCenter = w.antL + w.antV + w.est + w.serv + w.dx + w.tipo;
                    cell(c.dosaje ? `DOSAJE: ${c.dosaje}` : "", cx, y, wCenter, hRowName, {align:'center', fontSize:6, border: false}); cx += wCenter;
                    const wFURLabel = w.lab * 2;
                    cell("FUR:", cx, y, wFURLabel, hRowName, {align:'right', bold:true, border: false, fontSize:6}); cx += wFURLabel;
                    const wFURVal = w.lab + w.cie;
                    cell(p.fur, cx, y, wFURVal, hRowName, {align:'center', fill:[240,240,240], border:true, bold:true, fontSize:7});
                } else {
                    let cxEmpty = cx;
                    cell("", cxEmpty, y, w.dia + w.dni + w.fin + w.dist, hRowName, {border: true});
                    cxEmpty += (w.dia + w.dni + w.fin + w.dist);
                    cell("", cxEmpty, y, w.edad + w.sex, hRowName, {border: true});
                    cxEmpty += (w.edad + w.sex);
                    cell("", cxEmpty, y, w.antL + w.antV, hRowName, {fill:[240,240,240], border:true}); cxEmpty += (w.antL + w.antV);
                    cell("", cxEmpty, y, w.antL + w.antV + w.est + w.serv + w.dx + w.tipo, hRowName, {border: true});
                    cxEmpty += (w.antL + w.antV + w.est + w.serv + w.dx + w.tipo);
                    cell("", cxEmpty, y, w.lab * 2, hRowName, {border: true}); cxEmpty += (w.lab * 2);
                    cell("", cxEmpty, y, w.lab + w.cie, hRowName, {fill:[240,240,240], border:true});
                }
                
                const yData = y + hRowName;
                const hDataBlock = hRowData * 3; 

                cx = mx + w.idx;
                cell(p.fecAtencion ? p.fecAtencion.split('-')[2] : "", cx, yData, w.dia, hDataBlock, {align:'center', vAlign:'middle', fontSize:7, bold:false}); 
                cx += w.dia;
                cell(p.dni, cx, yData, w.dni, hRowData, {align:'center', fontSize:7, bold:true});
                cell(p.hc, cx, yData + hRowData, w.dni, hRowData, {align:'center', fontSize:7, bold:true});
                cell(p.condicion, cx, yData + (hRowData*2), w.dni, hRowData, {align:'center', fontSize:5.5, bold:false});
                cx += w.dni;
                const fRaw = (p.financiador || '').toString().trim().toUpperCase();

		// 1. Buscamos si el texto empieza con un n√∫mero (Regex: ^ significa inicio, \d+ significa d√≠gitos)
		const numeroEncontrado = fRaw.match(/^(\d+)/);

		let codigoFinanciador = '1'; // Valor por defecto (PAGANTE)

		if (numeroEncontrado) {
    		codigoFinanciador = numeroEncontrado[1]; // Usamos el n√∫mero encontrado (ej: "2", "3")
		} else if (fRaw === 'SIS') {
    		codigoFinanciador = '2'; // Respaldo por si escriben solo "SIS"
		}

		// Dibujamos solo el n√∫mero en el PDF
		cell(codigoFinanciador, cx, yData, w.fin, hDataBlock, {align:'center', vAlign:'middle', fontSize:7, bold:false});
                cx += w.fin;
                cell(p.distrito, cx, yData, w.dist, hRowData, {align:'left', fontSize:5, bold:false});
                let direccionTexto = p.direccion || "";
                if(p.centroPoblado) direccionTexto += " " + p.centroPoblado;
                
                cell(direccionTexto, cx, yData + hRowData, w.dist, hRowData * 2, {
                    align:'left', 
                    fontSize:5, 
                    vAlign:'top', 
                    bold:false, 
                    wrap: true 
                });
                cx += w.dist;

                cell(a.y ? a.y + " a√±os" : "", cx, yData, w.edad, hRowData, {align:'center', fontSize: 6, bold:true});
                cell(a.m ? a.m + " meses" : "", cx, yData + hRowData, w.edad, hRowData, {align:'center', fontSize: 6, bold:true});
                cell(a.d ? a.d + " d√≠as" : "", cx, yData + (hRowData*2), w.edad, hRowData, {align:'center', fontSize: 6, bold:true});
                cx += w.edad;

                cell(p.sexo, cx, yData, w.sex, hDataBlock, {align:'center', vAlign:'middle', fontSize:7, bold:false});
                cx += w.sex;

                let cxAntro = cx;
                cell("Talla", cxAntro, yData, w.antL, hRowData, {align:'center', fontSize:5, bold:true}); cxAntro+=w.antL;
                cell(isFirst ? c.talla : "", cxAntro, yData, w.antV, hRowData, {align:'center', bold:true, fontSize:7});
                cxAntro+=w.antV;
                cell("P.C.", cxAntro, yData, w.antL, hRowData, {align:'center', fontSize:5, bold:true}); cxAntro+=w.antL;
                cell(isFirst ? c.pCef : "", cxAntro, yData, w.antV, hRowData, {align:'center', bold:true, fontSize:7});
                
                cxAntro = cx;
                cell("Peso", cxAntro, yData+hRowData, w.antL, hRowData, {align:'center', fontSize:5, bold:true}); cxAntro+=w.antL;
                cell(isFirst ? c.peso : "", cxAntro, yData+hRowData, w.antV, hRowData, {align:'center', bold:true, fontSize:7});
                cxAntro+=w.antV;
                cell("P.Abd", cxAntro, yData+hRowData, w.antL, hRowData, {align:'center', fontSize:5, bold:true}); cxAntro+=w.antL;
                cell(isFirst ? c.pAbd : "", cxAntro, yData+hRowData, w.antV, hRowData, {align:'center', bold:true, fontSize:7});

                cxAntro = cx;
                cell("HB", cxAntro, yData+(hRowData*2), w.antL, hRowData, {align:'center', fontSize:5, bold:true}); cxAntro+=w.antL;
                cell(isFirst ? c.hb : "", cxAntro, yData+(hRowData*2), w.antV, hRowData, {align:'center', bold:true, fontSize:7});
                cxAntro+=w.antV;
                cell("P.Preg", cxAntro, yData+(hRowData*2), w.antL, hRowData, {align:'center', fontSize:5, bold:true}); cxAntro+=w.antL;
                cell(isFirst ? c.pPreGest : "", cxAntro, yData+(hRowData*2), w.antV, hRowData, {align:'center', bold:true, fontSize:7});
                
                cx += (w.antL*2 + w.antV*2);
                cell(p.condEst, cx, yData, w.est, hDataBlock, {align:'center', vAlign:'middle', bold:false, fontSize:7}); cx += w.est;
                cell(p.condServ, cx, yData, w.serv, hDataBlock, {align:'center', vAlign:'middle', bold:false, fontSize:7}); cx += w.serv;

                let cxDx = cx;
                cell(d1.desc, cxDx, yData, w.dx, hRowData, {align:'left', fontSize:5.5, bold:false}); cxDx+=w.dx;
                cell(d1.tipo, cxDx, yData, w.tipo, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.tipo;
                cell(d1.lab1, cxDx, yData, w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d1.lab2, cxDx, yData, w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d1.lab3, cxDx, yData, w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d1.codigo, cxDx, yData, w.cie, hRowData, {align:'center', bold:true, fontSize:7});

                cxDx = cx;
                cell(d2.desc, cxDx, yData+hRowData, w.dx, hRowData, {align:'left', fontSize:5.5, bold:false}); cxDx+=w.dx;
                cell(d2.tipo, cxDx, yData+hRowData, w.tipo, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.tipo;
                cell(d2.lab1, cxDx, yData+hRowData, w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d2.lab2, cxDx, yData+hRowData, w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d2.lab3, cxDx, yData+hRowData, w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d2.codigo, cxDx, yData+hRowData, w.cie, hRowData, {align:'center', bold:true, fontSize:7});

                cxDx = cx;
                cell(d3.desc, cxDx, yData+(hRowData*2), w.dx, hRowData, {align:'left', fontSize:5.5, bold:false}); cxDx+=w.dx;
                cell(d3.tipo, cxDx, yData+(hRowData*2), w.tipo, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.tipo;
                cell(d3.lab1, cxDx, yData+(hRowData*2), w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d3.lab2, cxDx, yData+(hRowData*2), w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d3.lab3, cxDx, yData+(hRowData*2), w.lab, hRowData, {align:'center', bold:false, fontSize:6}); cxDx+=w.lab;
                cell(d3.codigo, cxDx, yData+(hRowData*2), w.cie, hRowData, {align:'center', bold:true, fontSize:7});

                y += hBlock;
            }
        }

        doc.save(`HIS_${adminData.mes}_${allPatients.length}_PACIENTES_OFICIAL.pdf`);
        setSavedPatients([]);
        // Limpia la lista
        resetForm();                // Resetea el formulario
        setStep(1);                 // Vuelve al paso 1
        setIsBatchFinished(false);  // Reactiva botones de edici√≥n
        setIsCalendarOpen(true);
        // Abre calendario
    } catch(err) { 
        alert("Error al generar PDF: " + err.message);
        console.error(err);
    }
  };
  const generateExcel = () => {
    try {
        if (typeof global === 'undefined') window.global = window;
        if (savedPatients.length === 0 && !patientData.paciente) return alert("No hay datos para exportar.");
        const wb = XLSX.utils.book_new();
        const grayBorderColor = { rgb: "595959" }; const thinBorder = { top: { style: "thin", color: grayBorderColor }, bottom: { style: "thin", color: grayBorderColor }, left: { style: "thin", color: grayBorderColor }, right: { style: "thin", color: grayBorderColor } };
        const centerStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 10.5, name: "Arial" }, border: thinBorder };
        const leftStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 10.5, name: "Arial" }, border: thinBorder };
        const boxHeaderStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 10, bold: true }, border: thinBorder, fill: { fgColor: { rgb: "FFFFFF" } } };
        const smallTextStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 9, name: "Arial" }, border: thinBorder };
        const centerSmallStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 9, name: "Arial" }, border: thinBorder };
        const descStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 9.5, name: "Arial" }, border: thinBorder };
        const bahnschriftStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 11, name: "Bahnschrift SemiBold", bold: true }, border: thinBorder };
        const levenimStyle = { alignment: { horizontal: "left", vertical: "center", wrapText: true }, font: { sz: 9, name: "Levenim MT", bold: false }, border: thinBorder };
        const ageStyle = { alignment: { horizontal: "center", vertical: "center", wrapText: true }, font: { sz: 9, name: "Bahnschrift SemiBold", color: { rgb: "404040" }, bold: true }, border: thinBorder };
        const headerStyle = { alignment: { horizontal: "center", vertical: "center" }, font: { bold: true, sz: 10, name: "Arial" } };
        const labelHeaderStyle = { alignment: { horizontal: "right", vertical: "center" }, font: { bold: true, sz: 9, name: "Arial" }, border: thinBorder };
        const signatureStyle = { alignment: { horizontal: "center", vertical: "bottom", wrapText: true }, font: { sz: 8, name: "Arial", color: { rgb: "D9D9D9" }, bold: true }, border: thinBorder };
        const signatureText = "FIRMA Y SELLO\nDEL PERSONAL DE SALUD";
        const hRow1 = new Array(19).fill(""); hRow1[1]="Lote:"; hRow1[4]="MINISTERIO DE SALUD"; hRow1[14]=signatureText;
        const hRow2 = new Array(19).fill(""); hRow2[1]="Pag:"; hRow2[4]="OFICINA GENERAL DE ESTAD√çSTICA E INFORM√ÅTICA";
        const hRow3 = new Array(19).fill("");
        const hRow4 = new Array(19).fill(""); hRow4[1]="Reg:"; hRow4[4]="Registro Diario de Atenci√≥n y Otras Actividades de Salud";
        const hRow6 = ["", "A√ëO", "MES", "ESTABLECIMIENTO DE SALUD", "", "UNIDAD PRESTADORA (UPS)", "", "", "", "DNI DEL RESP.", "", "", "RESPONSABLE DE LAS ATENCIONES", "", "TURNO"];
        const hRow7 = ["", adminData.anio, adminData.mes, adminData.establecimiento, "", adminData.ups, "", "", "", adminData.dniResp, "", "", adminData.nombreResp, "", adminData.turno];
        const hRow9 = ["", "F.A", "D.N.I. / H.C.", "FINANC.", "DISTRITO DE PROCEDENCIA", "EDAD", "SEXO", "ANTROPOMETR√çA", "", "", "", "EST", "SERV", "DIAGN√ìSTICO MOTIVO DE CONSULTA", "TIPO", "LAB", "LAB", "LAB", "C√ìDIGO"];
        const fullHeaderBlock = [ hRow1, hRow2, hRow3, hRow4, [""], hRow6, hRow7, [""], hRow9 ];
        const headerMergesTemplate = [
            { s: {r:0, c:4}, e: {r:0, c:13} }, { s: {r:1, c:4}, e: {r:1, c:13} }, { s: {r:3, c:4}, e: {r:3, c:13} },
            { s: {r:0, c:2}, e: {r:0, c:3} }, { s: {r:1, c:2}, e: {r:1, c:3} }, { s: {r:2, c:1}, e: {r:2, c:3} }, { s: {r:3, c:2}, e: {r:3, c:3} },
            { s: {r:0, c:14}, e: {r:3, c:18} },
            { s: {r:5, c:3}, e: {r:5, c:4} }, { s: {r:6, c:3}, e: {r:6, c:4} }, { s: {r:5, c:5}, e: {r:5, c:8} }, { s: {r:6, c:5}, e: {r:6, c:8} },
            { s: {r:5, c:9}, e: {r:5, c:11} }, { s: {r:6, c:9}, e: {r:6, c:11} }, { s: {r:5, c:12}, e: {r:5, c:13} }, { s: {r:6, c:12}, e: {r:6, c:13} },
            { s: {r:5, c:14}, e: {r:5, c:18} }, { s: {r:6, c:14}, e: {r:6, c:18} },
            { s: {r:8, c:7}, e: {r:8, c:10} }, { s: {r:8, c:15}, e: {r:8, c:17} }
        ];
        const ws_data = []; const merges = [];
        const insertHeaderBlock = (startRowIndex) => {
            fullHeaderBlock.forEach(row => ws_data.push([...row]));
            headerMergesTemplate.forEach(m => { merges.push({ s: { r: m.s.r + startRowIndex, c: m.s.c }, e: { r: m.e.r + startRowIndex, c: m.e.c } }); });
        };
        insertHeaderBlock(0);
        
        const allPatients = [...savedPatients];
        if (patientData.paciente) { allPatients.push({ patient: patientData, clinical: clinicalData, diagnoses: diagnoses, ageObj: ageObj });
        }
        
        let currentRow = 9;
        let globalBlockIndex = 1; let blocksOnCurrentPage = 0; let patientHeaderIndices = []; let pageStartRows = [0]; const rowBreaks = [];
        const addBlockToSheet = (rec = null) => {
             const isEmpty = !rec;
             const p = rec ? rec.patient : {};
             const c = rec ? rec.clinical : {};
             const dxs = rec ? rec.diagnoses : [];
             const age = rec ? rec.ageObj : {};

             let chunks = [];
             if (!isEmpty) {
                 const totalDxs = Math.max(1, dxs.length);
                 for (let i = 0; i < totalDxs; i += 3) { chunks.push(dxs.slice(i, i + 3));
                 } 
                 if (chunks.length === 0) chunks.push([{},{},{}]);
             } else {
                 chunks.push([{},{},{}]);
             }

             for(let k = 0; k < chunks.length; k++) {
                const chunkDxs = chunks[k];
                while(chunkDxs.length < 3) chunkDxs.push({});

                if (blocksOnCurrentPage === 11) {
                    ws_data.push([""]);
                    merges.push({ s: {r:currentRow, c:0}, e: {r:currentRow, c:18} });
                    rowBreaks.push(currentRow); currentRow++; pageStartRows.push(currentRow);
                    insertHeaderBlock(currentRow); currentRow += 9; blocksOnCurrentPage = 0;
                }

                const patientRow = new Array(19).fill("");
                patientRow[0] = globalBlockIndex;
                if (k === 0) {
                    if (!isEmpty) {
                        patientRow[1] = p.paciente;
                        patientRow[8] = p.fecNac;
                        if (c.dosaje) patientRow[10] = `F.U.DOSAJE: ${c.dosaje}`; 
                        if (p.fur) patientRow[16] = p.fur;
                    }
                    patientRow[6] = "F.N:";
                    patientRow[14] = "FUR:";
                }
                ws_data.push(patientRow);
                patientHeaderIndices.push(currentRow);

                merges.push({ s: {r:currentRow, c:1}, e: {r:currentRow, c:5} }); 
                merges.push({ s: {r:currentRow, c:6}, e: {r:currentRow, c:7} });
                merges.push({ s: {r:currentRow, c:8}, e: {r:currentRow, c:9} }); 
                merges.push({ s: {r:currentRow, c:10}, e: {r:currentRow, c:13} });
                merges.push({ s: {r:currentRow, c:14}, e: {r:currentRow, c:15} }); 
                merges.push({ s: {r:currentRow, c:16}, e: {r:currentRow, c:18} });
                merges.push({ s: {r:currentRow, c:0}, e: {r:currentRow+3, c:0} }); 

                currentRow++;

                for(let i = 0; i < 3; i++) {
                    const d = chunkDxs[i] || {}; 
                    const row = new Array(19).fill(""); 
                    if (!isEmpty) {
                        row[13] = d.desc || ""; row[14] = d.tipo || ""; row[15] = d.lab1 || ""; row[16] = d.lab2 || ""; row[17] = d.lab3 || ""; row[18] = d.codigo || "";
                        if (i === 0) { row[1] = p.fecAtencion ? p.fecAtencion.split('-')[2] : "";
                        row[2] = p.dni; row[3] = p.financiador === 'SIS' ? '1' : '2'; row[4] = p.distrito;
                        row[5] = (age.y || age.y === 0) ? `${age.y} a√±os` : ''; row[6] = p.sexo; row[7] = "Talla";
                        row[8] = (k===0 ? parseFloat(c.talla)||'' : ''); row[9] = "P.C."; row[10] = (k===0 ? parseFloat(c.pCef)||'' : ''); row[11] = p.condEst;
                        row[12] = p.condServ; } 
                        else if (i === 1) { row[2] = p.hc;
                        row[4] = p.direccion; row[5] = (age.m || age.m === 0) ? `${age.m} meses` : ''; row[7] = "Peso";
                        row[8] = (k===0 ? parseFloat(c.peso)||'' : ''); row[9] = "P.Abd"; row[10] = (k===0 ? parseFloat(c.pAbd)||'' : '');
                        } 
                        else if (i === 2) { row[2] = p.condicion || "-"; row[4] = "CENTRO POBLADO"; row[5] = (age.d || age.d === 0) ? `${age.d} d√≠as` : ''; row[7] = "HB";
                        row[8] = (k===0 ? parseFloat(c.hb)||'' : ''); row[9] = "P.Preg";
                        }
                    } else {
                        if (i === 0) { row[7] = "Talla";
                        row[9] = "P.C."; }
                        else if (i === 1) { row[7] = "Peso";
                        row[9] = "P.Abd"; }
                        else if (i === 2) { row[7] = "HB";
                        row[9] = "P.Preg"; }
                    }
                    ws_data.push(row);
                }
                const start = currentRow;
                const end = currentRow + 2;
                merges.push( { s: {r:start, c:1}, e: {r:end, c:1} }, { s: {r:start, c:3}, e: {r:end, c:3} }, { s: {r:start+1, c:4}, e: {r:end, c:4} }, { s: {r:start, c:6}, e: {r:end, c:6} }, { s: {r:start, c:11}, e: {r:end, c:11} }, { s: {r:start, c:12}, e: {r:end, c:12} } );
                currentRow += 3; globalBlockIndex++; blocksOnCurrentPage++;
             }
        };

        allPatients.forEach(rec => addBlockToSheet(rec));
        while (blocksOnCurrentPage > 0 && blocksOnCurrentPage < 11) {
            addBlockToSheet(null);
        }
        
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [ { wch: 2.22 }, { wch: 4 }, { wch: 10 }, { wch: 2 }, { wch: 19.5 }, { wch: 5.44 }, { wch: 2 }, { wch: 4.5 }, { wch: 5.88 }, { wch: 5.1 }, { wch: 5.88 }, { wch: 1.78 }, { wch: 1.78 }, { wch: 42 }, { wch: 2.33 }, { wch: 3.56 }, { wch: 3.56 }, { wch: 3.56 }, { wch: 8.5 } ];
        ws['!merges'] = merges; ws['!pageSetup'] = { scale: 65, paperSize: 9, orientation: 'portrait' };
        ws['!margins'] = { left: 0.3, right: 0.3, top: 0.4, bottom: 0.4, header: 0.2, footer: 0.2 };
        ws['!rowBreaks'] = rowBreaks.map(r => ({id: r}));
        const rowHeights = [];
        for(let i=0; i<ws_data.length; i++) {
            let isHeader = false;
            for(let start of pageStartRows) { 
                if (i >= start && i < start + 9) { 
                    isHeader = true;
                    let rel = i - start; 
                    if (rel === 0 || rel === 1 || rel === 3) { rowHeights.push({ hpx: 25 });
                    }
                    else if(rel===2 || rel===4 || rel===7) rowHeights.push({ hpx: 4 });
                    else if (rel===8) rowHeights.push({ hpx: 40.8 }); 
                    else rowHeights.push({ hpx: 20 }); 
                    break;
                } 
            }
            if (!isHeader) { 
                if(patientHeaderIndices.includes(i)) { rowHeights.push({ hpx: 18 });
                } 
                else { rowHeights.push({ hpx: 24 });
                } 
            }
        }
        ws['!rows'] = rowHeights;
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_ref = XLSX.utils.encode_cell({c:C, r:R});
            if (!ws[cell_ref]) ws[cell_ref] = { t: 's', v: '' }; 
            let headerStart = -1;
            for(let start of pageStartRows) { if (R >= start && R < start + 9) { headerStart = start; break;
            } }
            const isHeaderBlock = (headerStart !== -1);
            const relativeR = isHeaderBlock ? (R - headerStart) : -1;
            if (isHeaderBlock) {
                if (relativeR === 0 && C === 4) { ws[cell_ref].s = { font: { name: "Arial Black", sz: 14, bold: true }, alignment: { horizontal: "center", vertical: "center" } };
                }
                else if (relativeR === 1 && C === 4) { ws[cell_ref].s = { font: { name: "Arial", sz: 12, bold: true}, alignment: { horizontal: "center", vertical: "center" } };
                }
                else if (relativeR <= 3) { if (C >= 1 && C <= 3) { ws[cell_ref].s = { border: thinBorder };
                if (C === 1) ws[cell_ref].s = labelHeaderStyle; } else if (C >= 14) { ws[cell_ref].s = { border: thinBorder };
                if (C === 14 && relativeR === 0) ws[cell_ref].s = signatureStyle;
                } else if (C >= 4 && C <= 13) { if (C === 4) ws[cell_ref].s = headerStyle;
                } }
                else if (relativeR >= 5 && relativeR <= 6 && C > 0) { ws[cell_ref].s = boxHeaderStyle;if (relativeR === 5 && C === 3) { 
        ws[cell_ref].s = { ...boxHeaderStyle, font: { sz: 9, bold: true } };
        }
 if (relativeR === 5 && C >= 5 && C <= 8) { ws[cell_ref].s = { ...boxHeaderStyle, font: { sz: 9, bold: true } };
 } } 
                else if (relativeR === 8) { ws[cell_ref].s = { ...centerStyle, font: { bold: true, sz: 8, name: "Arial" }, fill: { fgColor: { rgb: "CCCCCC" } } };
                if ([3, 5, 6, 11, 12, 14].includes(C)) { ws[cell_ref].s.alignment = { textRotation: 90, horizontal: "center", vertical: "center", wrapText: true };
                } if (C === 0) { ws[cell_ref].s.fill = { fgColor: { rgb: "FFFFFF" } }; ws[cell_ref].s.border = {};
                } }
                if (C === 0 && (relativeR === 5 || relativeR === 6)) { ws[cell_ref].s = { fill: { fgColor: { rgb: "FFFFFF" } } };
                }
            } else {
                ws[cell_ref].s = centerStyle;
                if (C === 0) { ws[cell_ref].s = { alignment: { horizontal: "center", vertical: "center" }, font: { bold: true, sz: 11, name: "Arial" }, border: {} };
                }
                if (C === 4) ws[cell_ref].s = leftStyle;
                if (C === 13) ws[cell_ref].s = levenimStyle; 
                if ([1, 8, 10, 11, 12, 14, 15, 16, 17, 18].includes(C)) { ws[cell_ref].s = bahnschriftStyle;
                }
                if (C === 2 && !patientHeaderIndices.includes(R)) { ws[cell_ref].s = bahnschriftStyle;
                }
                if (C === 5) { ws[cell_ref].s = ageStyle;
                }
                let currentPh = -1;
                for(let ph of patientHeaderIndices) { if (ph <= R) currentPh = ph; else break;
                }
                
                if (currentPh !== -1) { 
                    const offset = R - currentPh;
                    if (offset === 0) { 
                        ws[cell_ref].s = { alignment: { vertical: "center" } };
                        if (C === 1) { 
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Bahnschrift SemiBold", sz: 11, bold: true }, alignment: { horizontal: "left", vertical: "center" } };
                        } 
                        if (C === 6) { 
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 9, bold: true }, alignment: { horizontal: "right", vertical: "center" } };
                        }
                        if (C === 8) { 
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 10, bold: false }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "F2F2F2" } }, border: thinBorder };
                        }
                        if (C === 14) { 
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 9, bold: true }, alignment: { horizontal: "right", vertical: "center" } };
                        }
                        if (C === 16) { 
                             ws[cell_ref].s = { ...ws[cell_ref].s, font: { name: "Arial", sz: 10 }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "F2F2F2" } }, border: thinBorder };
                        }

                    } else if (offset === 1) { 
                        if (C === 4) ws[cell_ref].s = smallTextStyle;
                    } else if (offset === 2) { 
                        if (C === 4) ws[cell_ref].s = smallTextStyle;
                    } else if (offset === 3) { 
                        if (C === 2) ws[cell_ref].s = centerSmallStyle;
                    } 
                    if (offset >= 1 && offset <= 3) { 
                        if (C === 7 || C === 9) ws[cell_ref].s = centerSmallStyle;
                        if ([15, 16, 17].includes(C)) ws[cell_ref].s = centerSmallStyle; 
                    } 
                }
            }
            }
        }
        XLSX.utils.book_append_sheet(wb, ws, "HIS_Export");
        XLSX.writeFile(wb, `HIS_${adminData.mes}_${allPatients.length}_PACIENTES.xlsx`);
    
        // --- INICIO DEL CAMBIO: LIMPIEZA AUTOM√ÅTICA SIN PREGUNTAR ---
        setSavedPatients([]);
        // 1. Borra la lista de pacientes (Limpia el visor)
        resetForm();
        // 2. Resetea el formulario
        setStep(1);
        // 3. Vuelve al paso 1
        setIsBatchFinished(false);
        // 4. Reactiva los botones de edici√≥n
        setIsCalendarOpen(true);
        // 5. Abre el calendario para el siguiente lote
        
        // Opcional: Un mensaje simple que no requiere confirmaci√≥n
        // alert("‚úÖ Excel descargado. Lista limpiada autom√°ticamente.");
        // --- FIN DEL CAMBIO ---
    } catch(err) { alert("Error al exportar Excel: " + err.message);
    }  
  };

  // --- PANTALLA DE LOGIN REDISE√ëADA (MODERNA) ---
  // --- PANTALLA DE LOGIN REDISE√ëADA (CORREGIDA) ---
  if (!isAuthenticated) {
    return (
      // CONTENEDOR PRINCIPAL CON FONDO DEGRADADO OSCURO
      <div className="min-h-screen w-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black flex items-center justify-center p-4">
        
        {/* TARJETA DE LOGIN CON EFECTO GLASSMORPHISM */}
        <div className="bg-white/90 backdrop-blur-xl p-10 rounded-[40px] shadow-2xl shadow-black/20 w-full max-w-md border border-white/20 relative overflow-hidden">
          
          {/* Elemento decorativo de fondo (brillo superior) */}
          <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full h-32 bg-blue-500/10 blur-[60px] rounded-full pointer-events-none"></div>

          <div className="relative z-10">
            {/* LOGO Y T√çTULO */}
            <div className="text-center mb-10">
              {/* √çcono con brillo */}
              <div className="inline-block relative mb-4">
                 <div className="absolute inset-0 bg-blue-500 blur-xl opacity-30 rounded-2xl scale-110"></div>
                 <div className="bg-gradient-to-br from-blue-600 to-indigo-600 w-24 h-24 rounded-2xl flex items-center justify-center text-white relative shadow-lg transform rotate-3 hover:rotate-0 transition-all duration-500">
                   <Stethoscope size={44} strokeWidth={2} />
                 </div>
              </div>
              
              <h1 className="text-4xl font-black text-slate-800 tracking-tight mb-2">SMART HIS</h1>
              <p className="text-slate-500 font-medium text-sm uppercase tracking-widest">Acceso Personal de Salud</p>
            </div>

            {/* FORMULARIO */}
            <form onSubmit={handleLogin} className="space-y-6">
              
              {/* INPUT USUARIO (CON √çCONO INTEGRADO) */}
              <div className="space-y-2">
                <label className="text-xs font-bold text-slate-600 uppercase ml-1 tracking-wider">DNI Usuario</label>
                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors">
                      <User size={20} />
                  </div>
                  <input 
                    type="number" 
                    value={loginDni} // <--- CORREGIDO: Antes dec√≠a username
                    onChange={(e) => setLoginDni(e.target.value)} // <--- CORREGIDO: Antes dec√≠a setUsername
                    className="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 border-2 border-slate-100 outline-none text-lg font-bold text-slate-700 transition-all focus:border-blue-500 focus:bg-white focus:ring-4 focus:ring-blue-50/50 shadow-sm placeholder:text-slate-300"
                    placeholder="Ingrese su DNI..."
                    autoFocus
                  />
                </div>
              </div>

              {/* INPUT CONTRASE√ëA (CON √çCONOS INTEGRADOS) */}
              <div className="space-y-2">
                <label className="text-xs font-bold text-slate-600 uppercase ml-1 tracking-wider">Contrase√±a</label>
                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors">
                      <Lock size={20} />
                  </div>
                  <input 
                    type={showPassword ? "text" : "password"}
                    value={loginPass} // <--- CORREGIDO: Antes dec√≠a password
                    onChange={(e) => setLoginPass(e.target.value)} // <--- CORREGIDO: Antes dec√≠a setPassword
                    className="w-full pl-12 pr-12 py-4 rounded-2xl bg-slate-50 border-2 border-slate-100 outline-none text-lg font-bold text-slate-700 transition-all focus:border-blue-500 focus:bg-white focus:ring-4 focus:ring-blue-50/50 shadow-sm placeholder:text-slate-300 font-mono"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-blue-600 transition-colors focus:outline-none p-1"
                  >
                    {showPassword ? <EyeOff size={22}/> : <Eye size={22}/>}
                  </button>
                </div>
              </div>

              {loginError && (
                <div className="p-3 bg-red-50 text-red-600 text-xs font-bold rounded-lg text-center border border-red-100 flex items-center justify-center gap-2 animate-pulse">
                   <AlertTriangle size={14}/> {loginError}
                </div>
              )}

              {/* BOT√ìN DE INGRESO (CON DEGRADADO Y BRILLO) */}
              <button 
                type="submit"
                className="w-full bg-gradient-to-r from-blue-600 via-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white py-4 rounded-2xl font-black text-lg tracking-wide shadow-xl shadow-blue-500/30 hover:shadow-blue-500/50 transition-all transform hover:scale-[1.02] active:scale-[0.98] mt-4 relative overflow-hidden group"
              >
                <span className="relative z-10">INICIAR SESI√ìN</span>
                {/* Efecto de brillo al pasar el mouse */}
                <div className="absolute inset-0 h-full w-full scale-0 rounded-2xl transition-all duration-300 group-hover:scale-100 group-hover:bg-white/10"></div>
              </button>
            </form>
          </div>
          
          {/* FOOTER */}
          <p className="text-center text-slate-400 text-xs font-medium mt-8 opacity-80 relative z-10">
            Versi√≥n 1.0 | Smart HIS System
          </p>
        </div>
      </div>
    );
  }
    if (!adminData.isConfigured) {
    const cfgInputStyle = "w-full h-10 px-3 border-2 border-slate-200 rounded-xl bg-white text-slate-700 font-bold focus:border-slate-500 focus:ring-4 focus:ring-slate-100 outline-none transition-all shadow-sm text-sm hover:border-slate-300";
    const cfgLabelStyle = "block text-xs font-bold text-slate-400 uppercase ml-2 mb-1";
    return (
      <div className="min-h-screen w-full bg-[#f0f2f5] font-sans flex items-center justify-center p-4">
        <div className="w-full max-w-5xl bg-white shadow-2xl rounded-[30px] overflow-hidden border border-slate-100 animate-in fade-in zoom-in duration-300 mx-auto">
          <div className="bg-[#0F172A] px-10 py-6 flex justify-between items-end">
            <div><h1 className="text-2xl font-bold text-white tracking-wide">REGISTRO HIS</h1><p className="text-slate-400 text-xs mt-1">Configuraci√≥n de Sesi√≥n</p></div>
            <div className="flex gap-2">
              <div className="relative group"><input type="file" id="filePac" className="hidden" onChange={(e) => handleFileUpload(e, 'pacientes')} /><label htmlFor="filePac" className={`cursor-pointer px-5 py-2.5 rounded-xl border ${dbPacientes.length ? 'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700'} flex items-center gap-2 text-xs font-bold transition-all shadow-lg`}><Database size={16}/> {dbPacientes.length ?
                `BD OK (${dbPacientes.length})` : "Cargar Pacientes"}</label></div>
              <div className="relative group"><input type="file" id="fileCie" className="hidden" onChange={(e) => handleFileUpload(e, 'cie10')} /><label htmlFor="fileCie" className={`cursor-pointer px-5 py-2.5 rounded-xl border ${dbCie10.length ?
                'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700'} flex items-center gap-2 text-xs font-bold transition-all shadow-lg`}><FileSpreadsheet size={16}/> {dbCie10.length ?
                `BD OK (${dbCie10.length})` : "Cargar CIE-10"}</label></div>
              <div className="relative group"><input type="file" id="filePersonal" className="hidden" onChange={(e) => handleFileUpload(e, 'personal')} /><label htmlFor="filePersonal" className={`cursor-pointer px-5 py-2.5 rounded-xl border ${dbPersonal.length ?
                'bg-emerald-600 border-emerald-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-300 hover:bg-slate-700'} flex items-center gap-2 text-xs font-bold transition-all shadow-lg`}><Users size={16}/> {dbPersonal.length ?
                `Personal OK` : "Cargar Personal"}</label></div>
              
              {dbStatus === 'ready' && (
                  <button onClick={clearDatabase} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2.5 rounded-xl border border-red-400 flex items-center gap-2 text-xs font-bold transition-all shadow-lg ml-2" title="Borrar Base de Datos Local de Pacientes">
                      <Trash2 size={16}/> Borrar BD
                  </button>
              )}
            </div>
          </div>
          <div className="p-10 grid grid-cols-1 md:grid-cols-4 gap-6 bg-white">
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>A√±o</label><select name="anio" className={cfgInputStyle} value={adminData.anio} onChange={handleAdmin}><option>2025</option><option>2026</option></select></div>
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>Mes</label><select name="mes" className={cfgInputStyle} value={adminData.mes} onChange={handleAdmin}>{MESES.map(m=><option key={m}>{m}</option>)}</select></div>
            <div className="md:col-span-2 flex flex-col gap-1"><label className={cfgLabelStyle}>Establecimiento</label><select name="establecimiento" className={cfgInputStyle} value={adminData.establecimiento} onChange={handleAdmin}>{ESTABLECIMIENTOS.map(e=><option key={e}>{e}</option>)}</select></div>
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>Turno</label><select name="turno" className={cfgInputStyle} value={adminData.turno} onChange={handleAdmin}><option>MA√ëANA</option><option>TARDE</option><option>NOCHE</option></select></div>
            <div className="flex flex-col gap-1"><label className={cfgLabelStyle}>UPS</label><select name="ups" className={cfgInputStyle} value={adminData.ups} onChange={handleAdmin}>{UPS_LIST.map(u=><option key={u}>{u}</option>)}</select></div>
            
            <div className="flex flex-col gap-1">
                <label className={cfgLabelStyle}>DNI Responsable</label>
                <input 
                    name="dniResp" 
                    className={cfgInputStyle + " bg-slate-200 text-slate-600 cursor-not-allowed border-slate-300 shadow-inner"} 
                    value={adminData.dniResp} 
                    readOnly={true} 
                />
            </div>
            <div className="md:col-span-2 flex flex-col gap-1">
                <label className={cfgLabelStyle}>Nombre Responsable</label>
                <input 
                    name="nombreResp" 
                    className={cfgInputStyle + " uppercase bg-slate-200 text-slate-600 cursor-not-allowed border-slate-300 shadow-inner"} 
                    value={adminData.nombreResp} 
                    readOnly={true} 
                />
            </div>
          </div>
          <div className="bg-slate-50 px-10 py-6 flex justify-end border-t border-slate-100">
            <button onClick={() => setAdminData({...adminData, isConfigured: true})} className="bg-[#0F172A] hover:bg-slate-800 text-white px-8 py-3 rounded-xl shadow-xl font-bold flex items-center gap-3 transition-transform hover:scale-[1.02] text-sm">INGRESAR AL SISTEMA <ArrowRight size={18}/></button>
          </div>
        </div>
      </div>
    );
  }

  const consolidatedPatients = [...savedPatients];
  if (patientData.paciente) {
      consolidatedPatients.push({ patient: patientData, clinical: clinicalData, diagnoses: diagnoses, ageObj: ageObj });
  }
  const totalGridRows = consolidatedPatients.reduce((acc, p) => {
      const chunks = Math.ceil(Math.max(1, p.diagnoses.length) / 3);
      return acc + (chunks * 4); 
  }, 0);
  let visualBlockIndex = 1; 

  return (
    <div className="h-screen w-full bg-slate-100 font-sans flex flex-col overflow-hidden">
      {/* BARRA SUPERIOR AZUL OSCURO */}
      <div className="h-16 bg-[#0F172A] text-white flex justify-between items-center px-6 shadow-md z-20 shrink-0 border-b border-slate-800">
        <div className="flex items-center gap-4">
            <div className="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/50">
                <Activity size={20} className="text-white" />
            </div>
            <div>
                <h2 className="font-black text-sm tracking-widest text-white mb-0.5">REGISTRO HIS</h2>
                <div className="flex gap-3 text-[10px] font-bold text-slate-400 uppercase tracking-wide">
                    <span>ESTABLECIMIENTO: <span className="text-blue-300">{adminData.establecimiento}</span></span>
                    <span className="text-slate-700">|</span>
                    <span>TURNO: <span className="text-emerald-300">{adminData.turno}</span></span>
                </div>
            </div>
        </div>

        <div className="flex items-center gap-6">
            <div className="flex flex-col items-end">
                <span className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">USUARIO ACTIVO</span>
                <span className="uppercase text-white font-black tracking-wide text-sm md:text-base">
                    {adminData.nombreResp || "INVITADO"}
                </span>
            </div>
            <button 
                onClick={() => setAdminData({...adminData, isConfigured: false})} 
                className="bg-red-500/10 hover:bg-red-500/20 text-red-200 px-4 py-2 rounded-xl border border-red-500/30 flex gap-2 transition-all hover:border-red-400 font-bold text-xs items-center"
            >
                <LogOut size={16}/> SALIR A CONFIGURACI√ìN
            </button>
        </div>
      </div>

      {/* CONTENIDO PRINCIPAL */}
      <div className="flex-1 w-full relative bg-slate-100 overflow-hidden">
        {!isModalOpen ?
        (
          /* VISTA DASHBOARD (Botones de colores y PDF) */
          <div className="w-full h-full flex flex-col items-center overflow-y-auto py-6 gap-6 pb-40 px-4 animate-in fade-in zoom-in duration-300">
            
            {/* 1. PANELES DE SEGUIMIENTO */}
            <div className="w-full max-w-6xl bg-white p-4 rounded-2xl shadow-sm border border-slate-200 shrink-0 relative z-20">
                <p className="text-[10px] font-bold text-slate-400 uppercase mb-3 tracking-widest text-center">ACCESO R√ÅPIDO A SEGUIMIENTOS</p>
                <div className="flex flex-wrap gap-2 justify-center">
                    {[
                        { id: 'CRED', label: 'CRED', icon: <Baby size={16}/>, color: 'emerald' },
                        { id: 'GESTANTE', label: 'GESTANTES', icon: <UserPlus size={16}/>, color: 'pink' },
                        { id: 'ANEMIA', label: 'ANEMIA', icon: <Activity size={16}/>, color: 'red' },
                        { id: 'ANEMIA_GEST', label: 'ANEMIA GEST.', icon: <Activity size={16}/>, color: 'rose' },
                        { id: 'HIPER', label: 'HIPERTENSOS', icon: <Heart size={16}/>, color: 'orange' },
                        { id: 'DIABETES', label: 'DIABETES', icon: <Droplets size={16}/>, color: 'blue' },
                        { id: 'PSICOLOGIA', label: 'PSICOLOG√çA', icon: <Brain size={16}/>, color: 'indigo' },
                        { id: 'BUCAL', label: 'ODONTO', icon: <span className="text-base leading-none grayscale">ü¶∑</span>, color: 'cyan' },
                        { id: 'VACUNAS', label: 'VACUNAS', icon: <Syringe size={16}/>, color: 'purple' },
                    ].map((item) => (
                        <button 
                            key={item.id}
                            onClick={() => setActiveFollowUp(activeFollowUp === item.id ? null : item.id)} 
                            className={`flex items-center gap-2 px-3 py-2 rounded-lg font-bold text-[11px] whitespace-nowrap transition-all border shadow-sm
                                ${activeFollowUp === item.id 
                                    ? `bg-${item.color}-100 border-${item.color}-500 text-${item.color}-700 ring-2 ring-${item.color}-200` 
                                    : `bg-slate-50 border-slate-200 text-slate-600 hover:bg-white hover:border-${item.color}-300 hover:text-${item.color}-600`
                                }`}
                        >
                            {item.icon} {item.label}
                            {followUpData[item.id] && <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 ml-1"></span>}
                        </button>
                    ))}
                </div>
            </div>

            {/* 2. BIBLIOTECA DE NORMAS T√âCNICAS (PDFs) */}
            <div className="w-full max-w-6xl bg-white p-6 rounded-2xl shadow-sm border border-slate-200 shrink-0 relative z-20">
                <p className="text-[10px] font-bold text-slate-400 uppercase mb-4 tracking-widest text-center flex items-center justify-center gap-2">
                    <FileText size={14}/> BIBLIOTECA NORMATIVA (LECTURA R√ÅPIDA)
                </p>
                <div className="flex flex-wrap gap-4 justify-center">
                    {[
                        { titulo: 'NORMA T√âCNICA CRED', archivo: '/normas/cred.pdf' },
                        { titulo: 'GU√çA DE ANEMIA 2025', archivo: '/normas/anemia.pdf' },
                        { titulo: 'MANUAL GESTANTES', archivo: '/normas/gestante.pdf' },
                        { titulo: 'CALENDARIO VACUNAS', archivo: '/normas/vacunas.pdf' },
                    ].map((pdf, idx) => (
                        <a 
                            key={idx}
                            href={pdf.archivo} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="group flex flex-col items-center justify-center w-24 h-24 bg-slate-50 border-2 border-slate-100 rounded-2xl hover:bg-red-50 hover:border-red-200 transition-all cursor-pointer shadow-sm hover:shadow-md hover:-translate-y-1 text-center p-2 no-underline"
                            title="Clic para leer documento"
                        >
                            <div className="mb-2 text-slate-400 group-hover:text-red-500 transition-colors">
                                <FileText size={28} strokeWidth={1.5} />
                            </div>
                            <span className="text-[9px] font-bold text-slate-600 group-hover:text-red-700 uppercase leading-tight">
                                {pdf.titulo}
                            </span>
                        </a>
                    ))}
                </div>
            </div>

            {/* 3. VISOR DE TABLA DE SEGUIMIENTOS */}
	    {activeFollowUp && (
                <div className="w-full max-w-6xl animate-in slide-in-from-top-5 fade-in duration-300 z-10 shrink-0">
                    <InlineFollowUpViewer 
                        type={activeFollowUp} 
                        data={followUpData[activeFollowUp]} 
                        onClose={() => setActiveFollowUp(null)}
                        onFileUpload={handleFollowUpUpload}
                        externalFilter={""} 
                        
                        // L√ìGICA PARA EL BOT√ìN "VER DETALLE" (OJO)
                        onView={(row) => {
                            if (activeFollowUp === 'GESTANTE') {
                                // 1. Extraemos los controles del Excel plano a una lista
                                const controles = [];
                                for (let i = 1; i <= 15; i++) {
                                    if (row[`CPN_${i}`]) {
                                        controles.push({
                                            numero: i,
                                            fecha: row[`CPN_${i}`],
                                            peso: row[`PESO_${i}`],
                                            talla: row[`TALLA_${i}`],
                                            hb: row[`HB_${i}`],
                                            responsable: row[`ATENDIO_${i}`]
                                        });
                                    }
                                }
                                
                                // 2. Preparamos el objeto para el modal bonito
                                const pacienteFormateado = {
                                    nombre: row.Nombre_P,
                                    dni: row.N_DNI_HIS,
                                    hc: row.HC,
                                    edad: row.Edad,
                                    establecimiento: row.IPRESS_HIS,
                                    historialControles: controles,
                                    // Calculamos √∫ltima atenci√≥n para el footer
                                    ultimaAtencion: controles.length > 0 ? controles[controles.length - 1].fecha : "SIN DATOS"
                                };

                                // 3. Abrimos el modal
                                setSelectedGestanteForModal(pacienteFormateado);
                            } else {
                                alert("La vista gr√°fica solo est√° disponible para GESTANTES por ahora.");
                            }
                        }}
                    />
                </div>
            )}

            {/* 4. TARJETA PRINCIPAL (NUEVA ATENCI√ìN) */}
            <div className="bg-white rounded-[30px] shadow-xl border border-white p-8 text-center max-w-xl w-full relative z-0 shrink-0 mb-10">
              <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 shadow-inner">
                <Plus size={32}/>
              </div>
              <h3 className="text-xl font-extrabold text-slate-800 mb-2">Nueva Atenci√≥n</h3>
              <p className="text-slate-500 mb-6 text-xs font-medium">
                Estado de Base de datos: {dbPacientes.length > 0 ?
                <span className="text-emerald-600 font-bold bg-emerald-50 px-3 py-1 rounded-xl">Conectada ({dbPacientes.length})</span> : <span className="text-orange-500 font-bold bg-orange-50 px-3 py-1 rounded-xl">Sin datos</span>}
              </p>
              <button 
                onClick={() => {resetForm();
                setIsCalendarOpen(true); setIsModalOpen(true);}} 
                className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-xl shadow-blue-600/20 text-sm transition-all hover:-translate-y-1 active:scale-[0.98]"
              >
                REGISTRAR PACIENTE
              </button>
            </div>
          </div>
        ) : (
          /* VISTA FORMULARIO MODAL PRINCIPAL */
          <div className="bg-white rounded-[30px] shadow-2xl border border-slate-200 overflow-hidden flex flex-col w-full max-w-[95%] h-[90vh] animate-in zoom-in-95 duration-200 ring-1 ring-black/5 m-auto">
            {/* CABECERA DEL FORMULARIO */}
            <div className="flex border-b border-slate-100 bg-white px-6 shrink-0 justify-between items-center">
              <div className="flex-1 flex">
                  {['Paciente', 'Datos Cl√≠nicos', 'Diagn√≥sticos', 'Finalizar'].map((label, idx) => (
                      <div key={idx} 
                       //onClick={() => setStep(idx + 1)} // <--- ESTO PERMITE SALTAR AL HACER CLIC
                       className={`flex-1 text-center py-4 text-xs font-bold border-b-[3px] transition-colors ${step === idx + 1 ?
                      `border-${stepColors[idx]}-600 text-${stepColors[idx]}-700` : 'border-transparent text-slate-300'}`}>
                          <span className="mr-2 opacity-40">{idx + 1}.</span>{label}
                      </div>
                  ))}
              </div>
              <button onClick={() => { if(window.confirm("¬øEst√°s seguro de salir? Se perder√°n los datos no guardados.")) { setIsModalOpen(false); resetForm();
              } }} className="px-4 py-4 hover:bg-slate-50 text-slate-300 hover:text-red-500 transition-colors border-l border-slate-100 ml-4" title="Cerrar y volver al men√∫ principal"><X size={24}/></button>
            </div>
             {/* --- BARRA FIJA DE DATOS DEL PACIENTE (VISIBLE EN PASOS 1, 2, 3) --- */}
             {/* --- BARRA FIJA DE DATOS DEL PACIENTE (DISE√ëO LIMPIO) --- */}
             {/* --- BARRA FIJA DE DATOS DEL PACIENTE (DISE√ëO LIMPIO + √çCONO MODERNO) --- */}
             {/* --- CINTILLO FIJO DE DATOS (DIN√ÅMICO POR SEXO) --- */}
            {patientData.paciente && step < 4 && (
              <div className={`
                  border-b px-6 py-3 flex justify-between items-center shrink-0 animate-in slide-in-from-top-2 z-30 shadow-sm transition-colors duration-300
                  ${(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') 
                      ? 'bg-sky-100 border-sky-300'  // ESTILO MASCULINO (Celeste Intenso)
                      : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO')
                          ? 'bg-pink-100 border-pink-300' // ESTILO FEMENINO (Rosado Intenso)
                          : 'bg-slate-100 border-slate-200' // ESTILO NEUTRO
                  }
              `}>
                 <div className="flex items-center gap-4">
                    {/* √çCONO DIN√ÅMICO */}
                    <div className={`
                        p-2.5 rounded-xl shadow-sm border border-white/50
                        ${(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'bg-sky-200 text-sky-800' : 
                          (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'bg-pink-200 text-pink-800' : 'bg-slate-200 text-slate-600'}
                    `}>
                        <UserRound size={20} strokeWidth={2.5}/>
                    </div>

                    {/* DATOS DE TEXTO */}
                    <div>
                       <h3 className={`text-sm font-black leading-none tracking-wide mb-1.5 uppercase
                           ${(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'text-sky-900' : 
                             (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'text-pink-900' : 'text-slate-800'}
                       `}>
                           {patientData.paciente}
                       </h3>

                       <div className="flex items-center gap-3 text-[10px] font-bold uppercase tracking-wide opacity-80">
                           <span className={(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'text-sky-800' : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'text-pink-800' : 'text-slate-600'}>
                              DNI: <span className="font-black">{patientData.dni}</span>
                           </span>

                           <span className="opacity-40">|</span>

                           <span className={(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'text-sky-800' : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'text-pink-800' : 'text-slate-600'}>
                              EDAD: <span className="font-black">{ageObj.y} A√ëOS, {ageObj.m} MESES, {ageObj.d} D√çAS</span>
                           </span>

                           <span className="opacity-40">|</span>

                           <span className={(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'text-sky-800' : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'text-pink-800' : 'text-slate-600'}>
                              SEXO: <span className="font-black">{patientData.sexo}</span>
                           </span>
                       </div>
                    </div>
                 </div>

                 {/* INDICADOR H. CL√çNICA */}
                 <div className="text-right hidden sm:block">
                    <div className={`text-[9px] font-bold uppercase tracking-wider ${(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'text-sky-600' : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'text-pink-600' : 'text-slate-400'}`}>H. Cl√≠nica</div>
                    <div className={`text-lg font-black ${(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'text-sky-900' : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'text-pink-900' : 'text-slate-700'}`}>
                        {patientData.hc || "---"}
                    </div>
                 </div>
              </div>
            )}
            {/* CONTENIDO SCROLLABLE DEL FORMULARIO */}
            <div className="flex-grow overflow-y-auto p-6 bg-[#FAFAFA] no-scrollbar relative" ref={dxListRef}>
              
              {/* --- ALERTA DE VALIDACI√ìN FLOTANTE (FIXED) --- */}
{/* --- ALERTA DE VALIDACI√ìN FLOTANTE (FIXED) --- */}
{validationAlert.isOpen && (
  <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200">
    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setValidationAlert({ ...validationAlert, isOpen: false })}></div>

    {/* L√ìGICA DE COLORES SEG√öN TIPO */}
    <div className={`relative bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border-2 animate-in zoom-in duration-300 
        ${validationAlert.type === 'GESTANTE' ? 'border-pink-200' : validationAlert.type === 'TRANSFER' ? 'border-indigo-200' : 'border-orange-200'}`}>
      
      {/* CABECERA */}
      <div className={`px-8 py-6 border-b flex items-center gap-4 
          ${validationAlert.type === 'GESTANTE' ? 'bg-pink-50 border-pink-100' : validationAlert.type === 'TRANSFER' ? 'bg-indigo-50 border-indigo-100' : 'bg-orange-50 border-orange-100'}`}>
        
        <div className={`p-4 rounded-full shrink-0 shadow-sm 
            ${validationAlert.type === 'GESTANTE' ? 'bg-pink-200 text-pink-700' : validationAlert.type === 'TRANSFER' ? 'bg-indigo-200 text-indigo-700' : 'bg-orange-200 text-orange-700'}`}>
          {validationAlert.type === 'GESTANTE' ? <Baby size={40} strokeWidth={2} /> : validationAlert.type === 'TRANSFER' ? <RefreshCw size={40} strokeWidth={2}/> : <Activity size={40} strokeWidth={2} />}
        </div>
        
        <div>
          <h3 className={`text-2xl font-black 
              ${validationAlert.type === 'GESTANTE' ? 'text-pink-700' : validationAlert.type === 'TRANSFER' ? 'text-indigo-800' : 'text-orange-800'}`}>
              {validationAlert.title}
          </h3>
          <p className={`text-xs font-bold mt-1 uppercase 
              ${validationAlert.type === 'GESTANTE' ? 'text-pink-400' : validationAlert.type === 'TRANSFER' ? 'text-indigo-400' : 'text-orange-400'}`}>
              {validationAlert.type === 'TRANSFER' ? 'Acci√≥n Requerida: Asignar HC' : 'Correcci√≥n requerida'}
          </p>
        </div>
      </div>

      {/* CONTENIDO */}
      <div className="p-8 max-h-[60vh] overflow-y-auto">
        <p className="text-slate-700 font-bold text-lg mb-6 leading-snug">{validationAlert.message}</p>
        <div className={`p-5 rounded-2xl border flex items-start gap-4 shadow-sm 
            ${validationAlert.type === 'GESTANTE' ? 'bg-pink-50 border-pink-200' : validationAlert.type === 'TRANSFER' ? 'bg-indigo-50 border-indigo-200' : 'bg-orange-50 border-orange-200'}`}>
          <div className={`mt-1 
              ${validationAlert.type === 'GESTANTE' ? 'text-pink-500' : validationAlert.type === 'TRANSFER' ? 'text-indigo-500' : 'text-orange-500'}`}>
              <AlertTriangle size={24}/>
          </div>
          <div className="text-sm font-medium text-slate-600 whitespace-pre-line leading-relaxed">{validationAlert.details}</div>
        </div>
      </div>

      {/* BOT√ìN */}
      <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end">
        <button 
            onClick={() => { 
                setValidationAlert({ ...validationAlert, isOpen: false }); 
                // Si es falta de laboratorio, saltar al paso 2
                if (validationAlert.type === 'LAB_MISSING') { 
                    setStep(2); 
                    setShowHbError(true); 
                } 
                // Si es transferencia, enfocar la HC
                if (validationAlert.type === 'TRANSFER') {
                    setTimeout(() => {
                        const hcInput = document.querySelector('input[name="hc"]');
                        if (hcInput) { hcInput.focus(); hcInput.select(); }
                    }, 100);
                }
            }} 
            className={`px-8 py-3 rounded-xl font-black shadow-lg transition-transform active:scale-95 text-sm tracking-wide text-white 
                ${validationAlert.type === 'GESTANTE' ? 'bg-pink-500 hover:bg-pink-600' : validationAlert.type === 'TRANSFER' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-orange-500 hover:bg-orange-600'}`}
        >
            {validationAlert.type === 'TRANSFER' ? 'ENTENDIDO, INGRESAR√â HC' : 'ENTENDIDO, VOY A CORREGIR'}
        </button>
      </div>
    </div>
  </div>
)}

              {/* MODALES INTERNOS (Manual, Adolescente, Jurisdicci√≥n) */}
              {isManualModalOpen && (
                  <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 animate-in zoom-in duration-200">
                          <div className="flex justify-between items-center mb-6 border-b pb-2">
                              <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><UserPlus className="text-blue-600"/> Registrar Nuevo Paciente</h3>
                              <button onClick={() => setIsManualModalOpen(false)}><X className="text-slate-400 hover:text-red-500"/></button>
                          </div>
                          
                          <div className="grid grid-cols-2 gap-4">
                              {/* DNI y HC */}
                              <div><label className={getLabelStyle(1)}>DNI</label><input className={borderlessInputStyle + " border border-slate-200"} value={manualData.dni} onChange={(e) => setManualData({...manualData, dni: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>H. Cl√≠nica</label><input className={borderlessInputStyle + " border border-slate-200"} value={manualData.hc} onChange={(e) => setManualData({...manualData, hc: e.target.value})} /></div>
                              
                              {/* NOMBRES */}
                              <div className="col-span-2"><label className={getLabelStyle(1)}>Apellidos y Nombres</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.nombres} onChange={(e) => setManualData({...manualData, nombres: e.target.value})} /></div>
                              
                              {/* FECHA Y SEXO */}
                              <div><label className={getLabelStyle(1)}>Fecha Nac.</label><input type="date" className={borderlessInputStyle + " border border-slate-200"} value={manualData.fecNac} onChange={(e) => setManualData({...manualData, fecNac: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>Sexo</label><select className={borderlessInputStyle + " border border-slate-200"} value={manualData.sexo} onChange={(e) => setManualData({...manualData, sexo: e.target.value})}><option value="M">MASCULINO</option><option value="F">FEMENINO</option></select></div>
                              
                              {/* DIRECCION Y DISTRITO */}
                              <div className="col-span-2"><label className={getLabelStyle(1)}>Direcci√≥n</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.direccion} onChange={(e) => setManualData({...manualData, direccion: e.target.value})} /></div>
                              <div><label className={getLabelStyle(1)}>Distrito</label><input className={borderlessInputStyle + " border border-slate-200 uppercase"} value={manualData.distrito} onChange={(e) => setManualData({...manualData, distrito: e.target.value})} /></div>
                              
                              {/* COMBOBOX: ESTABLECIMIENTO ORIGEN */}
                              <div>
                                <label className={getLabelStyle(1)}>Establecimiento Origen</label>
                                <select 
                                    className={borderlessInputStyle + " border border-slate-200 uppercase cursor-pointer"} 
                                    value={manualData.estOrigen} 
                                    onChange={(e) => setManualData({...manualData, estOrigen: e.target.value})}
                                >
                                    <option value="">SELECCIONE...</option>
                                    <option value="I-4 PACAIPAMPA">I-4 PACAIPAMPA</option>
                                    <option value="I-2 EL PUERTO">I-2 EL PUERTO</option>
                                    <option value="I-1 LAGUNAS DE SAN PABLO">I-1 LAGUNAS DE SAN PABLO</option>
                                    <option value="I-1 CUMBICUS">I-1 CUMBICUS</option>
                                    <option value="I-1 CACHIACO">I-1 CACHIACO</option>
                                </select>
                              </div>
                          {/* COMBOBOX: FINANCIADOR */}
                          <div className="col-span-2 mt-4">
                            <label className={getLabelStyle(1)}>Financiador</label>
                            <select 
                                className={borderlessInputStyle + " border border-slate-200 uppercase cursor-pointer"} 
                                value={manualData.financiador} 
                                onChange={(e) => setManualData({...manualData, financiador: e.target.value})}
                            >
                                <option value="2-SIS">2-SIS</option>
                                <option value="1-PAGANTE">1-PAGANTE</option>
                                <option value="3-ESSALUD">3-ESSALUD</option>
                                <option value="10-OTROS">10-OTROS</option>
                            </select>
                          </div>
                        </div>
		      <div className="mt-6 flex justify-end">
                              <button onClick={handleSaveManualPatient} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg"><Save size={18}/> GUARDAR DATOS</button>
                     </div>
                   </div>
                 </div>
              )}
              {showAdolescentModal && (
                <div className="absolute inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in duration-300">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-amber-200 animate-in zoom-in duration-300">
                        <div className="bg-amber-50 px-8 py-6 border-b border-amber-200 flex items-center gap-4">
                            <div className="bg-amber-100 p-3 rounded-full shrink-0"><Siren size={32} className="text-amber-600" /></div>
                            <div><h3 className="text-xl font-extrabold text-amber-800">Alerta de Paciente Adolescente</h3><p className="text-xs text-amber-600 font-bold mt-1 uppercase">Verificaci√≥n de Indicadores FED</p></div>
                        </div>
                        <div className="p-8">
                            <p className="text-slate-700 font-bold text-lg mb-4 leading-tight">Estimado usuario, debe tener cuidado con el paciente que est√° registrando puesto que es <span className="text-amber-600 underline decoration-2">ADOLESCENTE ({ageObj.y} a√±os)</span>.</p>
                            <div className="bg-purple-50 border border-purple-200 p-6 rounded-2xl flex items-start gap-4 shadow-sm">
                                <Activity size={32} className="text-purple-600 mt-1 shrink-0"/>
                                <p className="text-sm text-purple-900 leading-relaxed font-medium">Debe registrar con mucho detalle la <b>condici√≥n al establecimiento</b>.<br/><br/>Recordarle que las <b>ADOLESCENTES MUJERES REINGRESANTES O NUEVAS</b> al establecimiento deben tener un <b>DOSAJE DE HEMOGLOBINA</b>, seg√∫n indicador FED.</p>
                            </div>
                        </div>
                        <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end"><button onClick={() => setShowAdolescentModal(false)} className="bg-amber-600 hover:bg-amber-700 text-white px-8 py-3 rounded-xl font-black shadow-lg transition-transform active:scale-95 text-sm tracking-wide">ENTENDIDO</button></div>
                    </div>
                </div>
              )}

              {showJurisdictionModal && (
                <div className="absolute inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 animate-in fade-in duration-300">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-red-100 animate-in zoom-in duration-300">
                        <div className="bg-red-50 px-8 py-6 border-b border-red-100 flex items-center gap-4">
                            <div className="bg-red-100 p-3 rounded-full shrink-0"><AlertTriangle size={32} className="text-red-600" /></div>
                            <div><h3 className="text-xl font-extrabold text-red-700">Advertencia de Jurisdicci√≥n</h3><p className="text-xs text-red-500 font-bold mt-1 uppercase">Conflicto de Establecimiento</p></div>
                        </div>
                        <div className="p-8">
                            <div className="text-slate-600 text-sm font-medium leading-relaxed whitespace-pre-line mb-6">{jurisdictionErrorMsg}</div>
                            <div className="bg-blue-50 border border-blue-100 p-4 rounded-xl flex items-start gap-3"><div className="bg-blue-100 p-1.5 rounded-full mt-0.5"><Plus size={16} className="text-blue-600"/></div><p className="text-xs text-blue-800 font-bold leading-relaxed">RECUERDE: Si no lo encuentra en el establecimiento que usted est√° buscando, debe ingresarlo como <span className="underline decoration-2 decoration-blue-400">PACIENTE NUEVO</span> usando el bot√≥n azul (+).<br/><br/>Al hacerlo, quedar√° activa autom√°ticamente la opci√≥n: <br/><span className="bg-white px-2 py-0.5 rounded border border-blue-200 text-blue-600 mt-1 inline-block">COND. EST: NUEVO</span> y <span className="bg-white px-2 py-0.5 rounded border border-blue-200 text-blue-600 inline-block">COND. SERV: NUEVO</span>.</p></div>
                        </div>
                        <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end"><button onClick={() => setShowJurisdictionModal(false)} className="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95 text-sm">Entendido, cerrar√© esta ventana</button></div>
                    </div>
                </div>
              )}

              {/* PASO 1: PACIENTE */}
              {/* PASO 1: PACIENTE - DISE√ëO MODERNO */}
              {/* PASO 1: PACIENTE - DISE√ëO MODERNO COMPACTO */}
              {/* PASO 1: PACIENTE - DISE√ëO MODERNO COMPACTO (CON ESTABLECIMIENTO EN BUSCADOR) */}
              {/* PASO 1: PACIENTE - DISE√ëO MODERNO COMPACTO (ALINEACI√ìN VERTICAL CORREGIDA) */}
              {/* PASO 1: PACIENTE - DISE√ëO MODERNO (CON CINTILLO DE SEXO DIN√ÅMICO) */}
              {step === 1 && (
        <div className="w-full max-w-6xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-300 pb-4">
            
            {/* 1. BARRA SUPERIOR: BUSCADOR + BOT√ìN + FECHA */}
            <div className="flex flex-col md:flex-row gap-3 mb-2 relative z-50">
                
                {/* A. BUSCADOR */}
                <div className="flex-1 bg-blue-50 rounded-xl p-1.5 shadow-sm border-2 border-blue-200 relative flex items-center gap-2">
                    <div className="flex-1 flex gap-2 items-center">
                        <div className="bg-blue-600 text-white p-2 rounded-lg shrink-0 shadow-md">
                            <Search size={18} strokeWidth={2.5}/>
                        </div>
                        <input 
                            className="flex-1 h-9 px-3 rounded-lg border-2 border-blue-200 bg-white text-sm font-black text-blue-900 placeholder-blue-300 outline-none uppercase transition-all focus:border-blue-500 focus:ring-2 focus:ring-blue-100 shadow-sm"
                            placeholder="BUSCAR PACIENTE (DNI O APELLIDOS)..."
                            autoFocus
                            value={searchTerm}
                            onChange={handleSearchInput}
                            onFocus={() => { if(suggestions.length > 0) setShowSuggestions(true); }}
                        />
                    </div>
                    <button 
                        onClick={() => setIsManualModalOpen(true)} 
                        className="bg-indigo-600 hover:bg-indigo-700 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md transition-transform active:scale-95 group mr-1 shrink-0 border border-indigo-400" 
                        title="Registrar Paciente Nuevo Manualmente"
                    >
                        <UserPlus size={18} className="group-hover:scale-110 transition-transform"/>
                    </button>
                    {/* LISTA DE SUGERENCIAS */}
                    {showSuggestions && suggestions.length > 0 && (
                        <div className="absolute top-full left-0 w-full mt-1 bg-white rounded-xl shadow-xl border-2 border-blue-100 max-h-[300px] overflow-y-auto p-1 z-[100]">
                            {suggestions.map((p) => {
                                const adminEst = adminData.establecimiento.trim().toUpperCase();
                                const patientEst = (p.estOrigen || "").trim().toUpperCase();
                                let keyword = "";
                                if (adminEst.includes("PACAIPAMPA")) keyword = "PACAIPAMPA";
                                else if (adminEst.includes("PUERTO")) keyword = "PUERTO";
                                else if (adminEst.includes("LAGUNAS")) keyword = "LAGUNAS";
                                else if (adminEst.includes("CUMBICUS")) keyword = "CUMBICUS";
                                else if (adminEst.includes("CACHIACO")) keyword = "CACHIACO";
                                else keyword = adminEst;
                                const isSameJurisdiction = patientEst.includes(keyword);

                                return (
                                    <div key={p.id} onMouseDown={() => selectPatient(p)} className="p-2 cursor-pointer rounded-lg group hover:bg-blue-50 transition-all border-b border-slate-100 last:border-0 flex items-start gap-3">
                                        <div className={`mt-1 p-1.5 rounded-full shrink-0 ${isSameJurisdiction ? 'bg-emerald-200 text-emerald-700' : 'bg-orange-200 text-orange-700'}`}>
                                            <Users size={16} />
                                        </div>
                                        <div className="flex-1">
                                            <div className={`font-black text-xs uppercase ${isSameJurisdiction ? 'text-blue-900' : 'text-slate-600'}`}>
                                                {getHighlightedText(p.nombre, searchTerm)}
                                            </div>
                                            <div className="flex flex-wrap gap-2 mt-1 text-[9px] font-bold uppercase">
                                                <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-200">
                                                    DNI: <span className="text-blue-900 font-black">{getHighlightedText(p.dni, searchTerm)}</span>
                                                </span>
                                                <span className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-200">
                                                    HC: {p.hc || "S/D"}
                                                </span>
                                                <span className={`px-1.5 py-0.5 rounded border flex items-center gap-1 ${isSameJurisdiction ? 'bg-emerald-100 text-emerald-800 border-emerald-200' : 'bg-orange-100 text-orange-800 border-orange-200'}`}>
                                                    {!isSameJurisdiction && <AlertTriangle size={8} />} EST: {p.estOrigen || "DESCONOCIDO"}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>

                {/* B. CALENDARIO */}
                <div className="bg-blue-50 rounded-xl p-1.5 shadow-sm border-2 border-blue-200 flex items-center gap-2 min-w-[200px]">
                    <div className="bg-blue-100 text-blue-700 p-2 rounded-lg shrink-0 border border-blue-200">
                        <Calendar size={18} strokeWidth={2.5}/>
                    </div>
                    <div className="flex flex-col justify-center w-full pr-2">
                        <label className="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5">FECHA ATENCI√ìN</label>
                        <input 
                            type="date"
                            name="fecAtencion"
                            value={patientData.fecAtencion}
                            onChange={handlePatient}
                            onClick={() => setIsCalendarOpen(true)}
                            className="w-full h-8 rounded-lg bg-white border-2 border-blue-100 px-2 font-black text-base text-center text-blue-900 outline-none focus:border-blue-400 cursor-pointer shadow-sm"
                        />
                    </div>
                </div>
            </div>

            {/* --- 2. √ÅREA DE DATOS DEL PACIENTE --- */}
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-3">
                
                {/* COLUMNA IZQUIERDA: ADMISI√ìN */}
                <div className="lg:col-span-3 space-y-2">
                    <div className="bg-violet-100/80 rounded-2xl p-3 border-2 border-violet-300 h-full shadow-md flex flex-col justify-center relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-16 h-16 bg-violet-200 rounded-bl-full opacity-70 pointer-events-none"></div>

                        <div className="space-y-2.5 relative z-10">
                            <div>
                                <label className="text-[9px] font-extrabold text-violet-700 uppercase ml-1 mb-0.5 block">Cond. Estab.</label>
                                <select name="condEst" value={patientData.condEst} onChange={handlePatient} className="w-full h-8 px-2 rounded-lg border-2 border-violet-200 bg-white font-bold text-xs text-violet-900 outline-none focus:border-violet-500 transition-all cursor-pointer shadow-sm">
                                    <option value="">SELECCIONAR...</option><option value="N">NUEVO</option><option value="C">CONTINUADOR</option><option value="R">REINGRESANTE</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-[9px] font-extrabold text-violet-700 uppercase ml-1 mb-0.5 block">Cond. Serv.</label>
                                <select name="condServ" value={patientData.condServ} onChange={handlePatient} className="w-full h-8 px-2 rounded-lg border-2 border-violet-200 bg-white font-bold text-xs text-violet-900 outline-none focus:border-violet-500 transition-all cursor-pointer shadow-sm">
                                    <option value="">SELECCIONAR...</option><option value="N">NUEVO</option><option value="C">CONTINUADOR</option><option value="R">REINGRESANTE</option>
                                </select>
                            </div>
                            
                            {/* FINANCIADOR REINTEGRADO */}
                            <div>
                                <label className="text-[9px] font-extrabold text-violet-700 uppercase ml-1 mb-0.5 block">Financiador</label>
                                <select name="financiador" value={patientData.financiador} onChange={handlePatient} className="w-full h-8 px-2 rounded-lg border-2 border-violet-200 bg-white font-bold text-xs text-violet-900 outline-none focus:border-violet-500 transition-all cursor-pointer shadow-sm">
                                    <option value="">SELECCIONAR...</option>
                                    <option value="1-PAGANTE">1-PAGANTE</option>
                                    <option value="2-SIS">2-SIS</option>
                                    <option value="3-ESSALUD">3-ESSALUD</option>
                                    <option value="10-OTROS">10-OTROS</option>
                                </select>
                            </div>

                            <div className="pt-2 border-t-2 border-violet-200/50 mt-1">
                                <label className="text-[9px] font-extrabold text-rose-600 uppercase ml-1 block mb-0.5">Condici√≥n</label>
                                <select name="condicion" value={patientData.condicion} onChange={handlePatient} className="w-full h-8 px-2 rounded-lg border-2 border-rose-200 bg-white font-bold text-xs text-rose-700 outline-none focus:border-rose-500 transition-all cursor-pointer shadow-sm bg-rose-50/50">
                                    <option value="">NINGUNA</option>
                                    <option value="GESTANTE" disabled={patientData.sexo === 'M' || patientData.sexo === 'MASCULINO'}>GESTANTE</option>
                                    <option value="PUERPERA" disabled={patientData.sexo === 'M' || patientData.sexo === 'MASCULINO'}>PUERPERA</option>
                                </select>
                            </div>

                            <div className="relative">
                                 <label className="text-[9px] font-extrabold text-violet-600 uppercase ml-1 flex justify-between mb-0.5">
                                    <span>FUR</span>
                                    {patientData.condicion === 'GESTANTE' && <span className="text-rose-600 font-black animate-pulse bg-rose-100 px-1 rounded">REQUERIDO</span>}
                                 </label>
                                 <input 
                                    type="date" 
                                    name="fur"
                                    value={patientData.fur} 
                                    onChange={handlePatient}
                                    disabled={patientData.condicion !== 'GESTANTE'}
                                    className={`w-full h-8 px-2 rounded-lg border-2 outline-none font-bold text-xs text-center transition-all relative z-10 shadow-sm
                                        ${patientData.condicion === 'GESTANTE' 
                                            ? (!patientData.fur ? 'border-red-500 bg-red-50 text-red-700 animate-pulse' : 'border-rose-300 bg-white text-rose-800') 
                                            : 'bg-violet-50/50 border-violet-200 text-violet-300 cursor-not-allowed'}`}
                                />
                            </div>
                        </div>
                    </div>
                </div>

                {/* COLUMNA CENTRAL: IDENTIFICACI√ìN */}
                <div className="lg:col-span-9 space-y-3">
                    
                    {/* TARJETA DE IDENTIDAD */}
                    <div className="bg-blue-50 rounded-2xl p-3 shadow-md border-2 border-blue-200 relative overflow-hidden group">
                        
                        <div className="flex flex-col md:flex-row gap-4 items-center md:items-start mt-1">
                            {/* AVATAR DIN√ÅMICO */}
                            <div className="shrink-0 flex flex-col items-center">
                                <div className={`w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg border-4 border-white ring-2 ring-blue-100
                                    ${(patientData.sexo === 'M' || patientData.sexo === 'MASCULINO') ? 'bg-blue-200 text-blue-600' : (patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? 'bg-pink-200 text-pink-600' : 'bg-slate-200 text-slate-500'}`}>
                                    {(patientData.sexo === 'F' || patientData.sexo === 'FEMENINO') ? <UserRound size={32}/> : <User size={32}/>}
                                </div>
                            </div>

                            <div className="flex-1 w-full space-y-3">
                                {/* NOMBRE */}
                                <div>
                                    <label className="text-[9px] font-extrabold text-blue-500 uppercase tracking-wider ml-1">Apellidos y Nombres</label>
                                    <input 
                                        name="paciente" 
                                        value={patientData.paciente} 
                                        readOnly={isPatientDataLocked}
                                        className="w-full h-11 px-4 rounded-xl border-2 border-blue-200 bg-white font-black text-xl text-blue-900 outline-none shadow-sm focus:border-blue-600 focus:ring-4 focus:ring-blue-100 transition-all uppercase placeholder-blue-200"
                                        placeholder="NOMBRE DEL PACIENTE..."
                                    />
                                </div>

                                {/* GRID DNI / HC / EDAD / F.NAC */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <div className="relative group">
                                        <label className="text-[9px] font-extrabold text-blue-500 uppercase block mb-0.5 ml-1">DNI</label>
                                        <input value={patientData.dni} readOnly className="w-full bg-white h-9 rounded-lg border-2 border-blue-200 px-2 font-black text-blue-800 outline-none text-base shadow-sm focus:border-blue-500 transition-all"/>
                                    </div>
                                    
                                    <div className="relative group">
                                        <label className={`text-[9px] font-extrabold uppercase block mb-0.5 ml-1 ${!patientData.hc ? 'text-red-600' : 'text-blue-600'}`}>H. Cl√≠nica</label>
                                        <input 
                                            name="hc"
                                            value={patientData.hc} 
                                            onChange={handlePatient}
                                            readOnly={isPatientDataLocked}
                                            className={`w-full h-9 rounded-lg border-2 px-2 font-black text-base outline-none bg-white shadow-sm transition-all
                                                ${!patientData.hc ? 'text-red-600 placeholder-red-300 border-red-300 focus:border-red-500 bg-red-50 animate-pulse' : 'text-blue-800 border-blue-200 focus:border-blue-500'}`}
                                            placeholder="FALTA HC"
                                        />
                                    </div>

                                    {/* EDAD EN SU PROPIO INPUT */}
                                    <div className="relative group">
                                        <label className="text-[9px] font-extrabold text-blue-500 uppercase block mb-0.5 ml-1">Edad Actual</label>
                                        <input 
                                            value={ageString} 
                                            readOnly 
                                            className="w-full bg-white h-9 rounded-lg border-2 border-blue-200 px-2 font-bold text-blue-900 outline-none text-[10px] shadow-sm truncate"
                                            title={ageString}
                                        />
                                    </div>

                                    <div className="relative group">
                                        <label className="text-[9px] font-extrabold text-blue-500 uppercase block mb-0.5 ml-1">F. Nacimiento</label>
                                        <input type="date" value={patientData.fecNac} readOnly className="w-full bg-white h-9 rounded-lg border-2 border-blue-200 px-2 font-bold text-blue-700 outline-none text-xs shadow-sm"/>
                                    </div>
                                </div>

                                {/* GRID 2: SEXO | DISTRITO (4 Columnas) */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                     <div className="relative group md:col-span-1">
                                        <label className="text-[9px] font-extrabold text-blue-500 uppercase block mb-0.5 ml-1">Sexo</label>
                                        <input 
                                            name="sexo" 
                                            value={patientData.sexo || "S/D"} 
                                            readOnly 
                                            className="w-full bg-white h-9 rounded-lg border-2 border-blue-200 px-2 font-bold text-center text-blue-800 outline-none text-xs shadow-sm"
                                        />
                                    </div>
                                    <div className="relative group md:col-span-3">
                                        <label className="text-[9px] font-extrabold text-blue-500 uppercase block mb-0.5 ml-1">Distrito Procedencia</label>
                                        <input 
                                            name="distrito" 
                                            value={patientData.distrito} 
                                            readOnly={isPatientDataLocked}
                                            className="w-full bg-white h-9 rounded-lg border-2 border-blue-200 px-2 font-bold text-blue-800 outline-none text-xs shadow-sm focus:border-blue-500 transition-all uppercase"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* SECCI√ìN UBICACI√ìN (ESMERALDA FUERTE) Y ORIGEN (√çNDIGO FUERTE) */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="bg-emerald-100/80 rounded-2xl p-3 border-2 border-emerald-300 shadow-md relative overflow-hidden">
                             <div className="absolute top-0 right-0 w-16 h-16 bg-emerald-200 rounded-bl-full opacity-60 pointer-events-none"></div>
                            <label className="text-[10px] font-extrabold text-emerald-800 uppercase ml-1 mb-1.5 flex gap-2 items-center relative z-10"><Database size={12}/> Ubicaci√≥n Actual</label>
                            
                            <div className="space-y-2 relative z-10">
                                {/* L√ìGICA DE COLOR CORREGIDA: Si hay longitud > 0, es VERDE. Si no, ROJO. */}
                                <input 
                                    name="direccion"
                                    value={patientData.direccion} 
                                    onChange={handlePatient}
                                    readOnly={isPatientDataLocked}
                                    placeholder="DIRECCI√ìN..."
                                    className={`w-full h-8 px-3 rounded-lg bg-white border-2 font-bold text-xs outline-none transition-all uppercase shadow-sm
                                        ${(patientData.direccion && patientData.direccion.length > 0) 
                                            ? 'border-emerald-500 text-emerald-900 focus:border-emerald-600 focus:ring-4 focus:ring-emerald-100' 
                                            : 'border-red-500 text-red-800 placeholder-red-400 bg-red-50 animate-pulse' 
                                        }`}
                                />
                                <select 
                                    className="w-full h-8 px-2 rounded-lg bg-white border-2 border-emerald-200 font-bold text-xs outline-none cursor-pointer text-emerald-700 hover:border-emerald-400 transition-all shadow-sm"
                                    value={listaCaserios.includes(patientData.direccion) ? patientData.direccion : ""}
                                    onChange={(e) => {
                                        const newVal = e.target.value;
                                        if(newVal && newVal !== "") {
                                            setPatientData(prev => ({...prev, direccion: newVal}));
                                            
                                            // Activar bloqueo autom√°tico si HC ya existe
                                            if (patientData.hc && patientData.hc.trim() !== "") {
                                                 setTimeout(() => setIsPatientDataLocked(true), 100);
                                            }
                                        }
                                    }}
                                >
                                     <option value="">‚ñº SELECCIONAR CASER√çO</option>
                                     {listaCaserios.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="bg-indigo-100/80 rounded-2xl p-3 border-2 border-indigo-300 shadow-md relative overflow-hidden">
                             <div className="absolute top-0 right-0 w-16 h-16 bg-indigo-200 rounded-bl-full opacity-60 pointer-events-none"></div>
                            <label className="text-[10px] font-extrabold text-indigo-800 uppercase ml-1 mb-1.5 flex gap-2 items-center relative z-10"><ArrowRight size={12}/> Procedencia</label>
                            <div className="space-y-2 relative z-10">
                                 <select 
                                    name="estOrigen"
                                    value={patientData.estOrigen} 
                                    onChange={handlePatient}
                                    className="w-full h-8 px-2 rounded-lg bg-white border-2 border-indigo-200 font-bold text-xs text-indigo-900 outline-none cursor-pointer hover:border-indigo-400 transition-all shadow-sm"
                                >
                                    <option value="">SELECCIONE ORIGEN...</option>
                                    <option value="E.S I-4 PACAIPAMPA">E.S I-4 PACAIPAMPA</option>
                                    <option value="P.S I-2 EL PUERTO">P.S I-2 EL PUERTO</option>
			            <option value="P.S I-1 LAGUNAS DE SAN PABLO">P.S I-1 LAGUNAS DE SAN PABLO</option>
				    <option value="P.S I-1 CUMBICUS">P.S I-1 CUMBICUS</option>
				    <option value="P.S I-1 CACHIACO">P.S I-1 CACHIACO</option>
                                    {/* ... resto de opciones ... */}
                                </select>
                                 <div className="flex justify-between items-center px-1 pt-1">
                                     <span className="text-[8px] font-bold text-slate-400">¬øDatos incorrectos?</span>
                                     <button onClick={() => setIsPatientDataLocked(!isPatientDataLocked)} className="text-[9px] font-black text-indigo-800 hover:text-indigo-600 hover:underline bg-indigo-200/50 px-2 py-0.5 rounded transition-colors">
                                         {isPatientDataLocked ? 'DESBLOQUEAR EDICI√ìN' : 'BLOQUEAR DATOS'}
                                     </button>
                                 </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
      )}
              {/* PASO 2: DATOS CL√çNICOS */}
	      {/* PASO 2: DATOS CL√çNICOS - DISE√ëO DASHBOARD MODERNO */}
              {/* PASO 2: DATOS CL√çNICOS - DISE√ëO COMPACTO Y EFICIENTE */}
              {/* PASO 2: DATOS CL√çNICOS - DISE√ëO ULTRA REDONDEADO (SOFT UI) */}
              {/* PASO 2: DATOS CL√çNICOS - DISE√ëO 'BURBUJA' (FULL ROUNDED) */}
              {/* PASO 2: DATOS CL√çNICOS - INPUTS INTERNOS REDONDEADOS */}
              {/* PASO 2: DATOS CL√çNICOS - CON CLASIFICACI√ìN DE P. ABDOMINAL */}
              {/* PASO 2: DATOS CL√çNICOS - REORGANIZADO Y COMPACTO */}
              {step === 2 && (
                <div className="w-full max-w-6xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-300 pb-2">
                  
                  <div className="grid grid-cols-1 lg:grid-cols-12 gap-5">
                      
                      {/* ================= COLUMNA IZQUIERDA (INPUTS) ================= */}
                      {/* (Esta parte no ha cambiado, mantiene la l√≥gica de P. Abd) */}
                      <div className="lg:col-span-8">
                          <div className="bg-white p-5 rounded-[2.5rem] shadow-sm border border-slate-200">
                              <h3 className="font-bold text-sm text-slate-700 mb-5 flex items-center gap-2 border-b border-slate-100 pb-3 ml-2">
                                  <Activity size={20} className="text-teal-600"/> ANTROPOMETR√çA Y FUNCIONES VITALES
                              </h3>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {[
                                    { label: "Talla", name: "talla", unit: "cm", icon: <ArrowRight className="rotate-[-45deg]" size={20}/>, min: 30, max: 200, hist: lastClinicalData.talla, color: 'blue' },
                                    { label: "Peso", name: "peso", unit: "Kg", icon: <span className="text-lg font-black leading-none">‚öñÔ∏è</span>, min: 0.5, max: 180, hist: lastClinicalData.peso, color: 'indigo' },
                                    { label: "P. Abdominal", name: "pAbd", unit: "cm", icon: <RefreshCw size={18}/>, min: 10, max: 200, hist: lastClinicalData.pAbd, checkAge: ageObj.y >= 12, specialBtn: true, color: 'emerald' },
                                    { label: "P. Cef√°lico", name: "pCef", unit: "cm", icon: <Smile size={18}/>, min: 20, max: 60, hist: lastClinicalData.pCef, checkAge: ageObj.y <= 5, specialBtn: true, color: 'orange' },
                                    { label: "Hemoglobina", name: "hb", unit: "g/dl", icon: <Droplets size={18}/>, min: 0, max: 24, hist: lastClinicalData.hb, isHb: true, color: 'rose' },
                                    { label: "P. Pre-Gest.", name: "pPreGest", unit: "Kg", icon: <Baby size={18}/>, min: 30, max: 150, hist: lastClinicalData.pPreg, checkCond: patientData.condicion === 'GESTANTE', specialBtn: true, color: 'pink' }
                                ].map((item, idx) => {
                                    if (item.checkAge === false) return null;
                                    const isLocked = item.checkCond === false || (item.name === 'pAbd' && ageObj.y < 12) || (item.name === 'pCef' && ageObj.y > 5);
                                    const hasHist = item.hist && item.hist.val;
                                    
                                    // L√≥gica P. Abdominal
                                    let pAbdStatus = { text: "", color: `border-${item.color}-200`, bg: "bg-slate-50", textCol: "text-slate-700" };
                                    if (item.name === 'pAbd' && clinicalData.pAbd && !isLocked) {
                                        const val = parseFloat(clinicalData.pAbd); const sex = patientData.sexo;
                                        if (sex === 'M' || sex === 'MASCULINO') {
                                            if (val >= 102) pAbdStatus = { text: "RIESGO MUY ALTO", color: "border-red-500", bg: "bg-red-50", textCol: "text-red-700" };
                                            else if (val >= 94) pAbdStatus = { text: "RIESGO ALTO", color: "border-orange-400", bg: "bg-orange-50", textCol: "text-orange-700" };
                                            else pAbdStatus = { text: "NORMAL", color: "border-emerald-400", bg: "bg-emerald-50", textCol: "text-emerald-700" };
                                        } else {
                                            if (val >= 88) pAbdStatus = { text: "RIESGO MUY ALTO", color: "border-red-500", bg: "bg-red-50", textCol: "text-red-700" };
                                            else if (val >= 80) pAbdStatus = { text: "RIESGO ALTO", color: "border-orange-400", bg: "bg-orange-50", textCol: "text-orange-700" };
                                            else pAbdStatus = { text: "NORMAL", color: "border-emerald-400", bg: "bg-emerald-50", textCol: "text-emerald-700" };
                                        }
                                    }
                                    const isHbAlert = (item.isHb && showHbError && !clinicalData.hb);

                                    return (
                                        <div key={idx} className={`relative group transition-all ${isLocked ? 'opacity-60 grayscale' : ''}`}>
                                            <div className="flex items-center gap-3 p-2 rounded-[2rem] border border-slate-100 bg-white shadow-sm hover:shadow-md transition-all h-[5.5rem]">
                                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center shrink-0 ml-1 ${isLocked ? 'bg-slate-200 text-slate-400' : `bg-${item.color}-100 text-${item.color}-600`}`}>
                                                    {item.icon}
                                                </div>
                                                <div className="flex-1 min-w-0 flex flex-col justify-center gap-1">
                                                    <div className="flex justify-between items-center px-1">
                                                        <label className="text-[9px] font-bold text-slate-500 uppercase truncate">{item.label}</label>
                                                        {item.specialBtn && !clinicalData[item.name] && !isLocked && ( <button onClick={() => { if(item.name==='pAbd') setIgnorePAbdValidation(true); if(item.name==='pCef') setIgnorePCefValidation(true); if(item.name==='pPreGest') setIgnorePreGestValidation(true); }} className="text-[8px] bg-slate-100 text-slate-400 hover:bg-red-100 hover:text-red-500 px-2 py-0.5 rounded-full font-bold transition-colors">OMITIR</button> )}
                                                        {pAbdStatus.text && ( <span className={`text-[8px] font-black px-2 py-0.5 rounded-lg ${pAbdStatus.bg} ${pAbdStatus.textCol} animate-in fade-in zoom-in`}>{pAbdStatus.text}</span> )}
                                                    </div>
                                                    <div className="relative">
                                                        <input name={item.name} disabled={isLocked} value={clinicalData[item.name] || ''} onChange={(e) => handleNumericInput(e, item.min, item.max)} placeholder="0.0" className={`w-full h-10 border-2 rounded-2xl px-3 text-xl font-black outline-none transition-all placeholder-slate-300 disabled:cursor-not-allowed ${isHbAlert ? 'border-red-300 bg-red-50 text-red-500 placeholder-red-300' : ''} ${item.name === 'pAbd' && !isLocked ? `${pAbdStatus.bg} ${pAbdStatus.color} ${pAbdStatus.textCol}` : `bg-slate-50 border-slate-200 text-slate-700 focus:border-${item.color}-400 focus:bg-white focus:ring-4 focus:ring-${item.color}-50`}`}/>
                                                        <span className={`absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold uppercase pointer-events-none ${item.name === 'pAbd' && !isLocked && clinicalData.pAbd ? pAbdStatus.textCol : 'text-slate-400'}`}>{item.unit}</span>
                                                    </div>
                                                </div>
                                                <div className="w-20 flex flex-col items-end justify-center border-l border-slate-200 pl-2 h-14 mr-1">
                                                    {hasHist ? ( <><span className="text-[8px] text-slate-400 leading-none mb-1.5">{item.hist.date}</span><div className="text-sm font-black text-teal-700 bg-teal-100 px-2 py-1.5 rounded-2xl border border-teal-200 text-center w-full shadow-sm flex items-center justify-center">{item.hist.val}</div></>) : ( <span className="text-[8px] font-bold text-slate-300 bg-slate-100 px-3 py-1.5 rounded-2xl block text-center w-full">---</span> )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                              </div>
                          </div>
                      </div>

                      {/* ================= COLUMNA DERECHA (WIDGETS REORGANIZADOS) ================= */}
                      <div className="lg:col-span-4 space-y-5">
                          
                          {/* --- BLOQUE 1: ESTADO NUTRICIONAL (SOLO) --- */}
                          <div className="bg-white rounded-[2.5rem] p-5 shadow-sm border border-slate-200">
                              <h4 className="text-slate-700 font-bold text-xs mb-4 flex items-center gap-2 ml-1">
                                  <Heart size={16} className="text-rose-500"/> Estado Nutricional
                              </h4>
                              {/* Solo IMC y Diagn√≥stico */}
                              <div className="flex gap-3">
                                  <div className="w-20 bg-slate-50 rounded-2xl p-2 border border-slate-100 text-center flex flex-col justify-center">
                                      <span className="text-[8px] font-bold text-slate-400 block mb-0.5">IMC</span>
                                      <div className="text-base font-black text-slate-700">{clinicalData.imc || '--'}</div>
                                  </div>
                                  <div className="flex-1">
                                      <input name="riesgo" value={clinicalData.riesgo} onChange={handleClinical} className={`w-full h-full border-2 rounded-2xl px-3 text-[10px] font-bold outline-none uppercase text-center transition-all duration-300 ${clinicalData.riesgo === 'NORMAL' ? 'bg-emerald-100 border-emerald-300 text-emerald-800 shadow-inner' : (clinicalData.riesgo && clinicalData.riesgo.includes('TABLA')) ? 'bg-amber-100 border-amber-300 text-amber-800' : clinicalData.riesgo ? 'bg-red-100 border-red-300 text-red-800 animate-pulse' : 'bg-slate-50 border-slate-200 text-slate-700 placeholder-slate-300 focus:border-teal-500'}`} placeholder="DIAGN√ìSTICO..." />
                                  </div>
                              </div>
                          </div>

                          {/* --- BLOQUE 2: CALCULADORAS CL√çNICAS (AGRUPADAS) --- */}
                          <div className="bg-slate-50/80 rounded-[2.5rem] p-4 shadow-inner border border-slate-100 space-y-3">
                              <h4 className="text-slate-500 font-bold text-[10px] uppercase tracking-widest mb-3 ml-2 flex items-center gap-2">
                                  <Calculator size={14}/> Herramientas
                              </h4>

                              {/* BOT√ìN 1: CALCULADORA ANEMIA (Color Violeta) */}
                              <button onClick={() => setShowAnemiaModal(true)} className="w-full group bg-gradient-to-r from-violet-600 to-indigo-600 text-white p-3.5 rounded-2xl shadow-md hover:shadow-lg hover:scale-[1.02] transition-all text-left flex justify-between items-center relative overflow-hidden">
                                  <div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                                  <div className="pl-1">
                                      <div className="text-[9px] font-bold opacity-80 mb-0.5 flex items-center gap-1">
                                          <Droplets size={10}/> Calculadora Anemia
                                      </div>
                                      {/* Muestra el resultado actual de forma compacta */}
                                      <div className="text-sm font-black truncate leading-tight">
                                        {anemiaResult && anemiaResult !== "---" ? anemiaResult : "EVALUAR"}
                                      </div>
                                  </div>
                                  <div className="bg-white/20 p-2 rounded-xl backdrop-blur-sm shrink-0">
                                      <ArrowRight size={16} />
                                  </div>
                              </button>

                              {/* BOT√ìN 2: TABLA Z-SCORE (Color Esmeralda, mismo tama√±o) */}
                              <button onClick={() => setShowNutriModal(true)} className="w-full group bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-3.5 rounded-2xl shadow-md hover:shadow-lg hover:scale-[1.02] transition-all text-left flex justify-between items-center relative overflow-hidden">
                                  <div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-20 transition-opacity"></div>
                                  <div className="pl-1">
                                      <div className="text-[9px] font-bold opacity-80 mb-0.5 flex items-center gap-1">
                                          <FileText size={10}/> Tabla Z-Score (OMS)
                                      </div>
                                      <div className="text-sm font-black truncate leading-tight">VER GR√ÅFICAS</div>
                                  </div>
                                  <div className="bg-white/20 p-2 rounded-xl backdrop-blur-sm shrink-0">
                                      <ArrowRight size={16} />
                                  </div>
                              </button>
                          </div>

                      </div>
                  </div>
                </div>
              )}
              {/* PASO 3: DIAGN√ìSTICOS */}
              {step === 3 && (
                <div className="animate-in fade-in slide-in-from-right-8 duration-300 w-full max-w-[95%] mx-auto">
                   <div className={`flex justify-between items-end mb-6 p-5 rounded-2xl border ${getTheme(3).bgLight} ${getTheme(3).border}`}>
                      <div><h3 className="font-extrabold text-slate-700 text-lg">Diagn√≥sticos CIE-10</h3><p className={`text-xs mt-1 font-medium ${getTheme(3).labelText}`}>Haga clic en las filas para buscar y editar</p></div>
                  </div>
                  <div className="space-y-3">
                      <div className={`grid grid-cols-12 gap-3 text-[10px] font-bold uppercase px-3 items-center ${getTheme(3).labelText}`}><div className="col-span-1 text-center">Opci√≥n</div><div className="col-span-6">Diagn√≥stico Seleccionado</div><div className="col-span-1 text-center">Tipo</div><div className="col-span-2 text-center">Lab</div><div className="col-span-2 text-center">CIE-10</div></div>
                    {diagnoses.map((dx, idx) => {
                      const hasError = dxErrors[idx];
                      const errorBorder = hasError ? "border-red-500 ring-2 ring-red-100" : "border-slate-200"; const showAddButton = (idx === diagnoses.length - 1);
                      return (
                      <div key={idx} className={`grid grid-cols-12 gap-3 items-center bg-white p-3 rounded-xl border ${errorBorder} hover:shadow-lg transition-all group relative`}>
                        <div className="col-span-1 flex justify-center"><button onClick={() => openDxSearch(idx)} className={`w-10 h-10 rounded-xl bg-${stepColors[2]}-50 text-${stepColors[2]}-600 flex items-center justify-center border border-${stepColors[2]}-200 hover:bg-${stepColors[2]}-600 hover:text-white transition-colors`}><Search size={18}/></button></div>
                        <div className="col-span-6 relative" onClick={() => openDxSearch(idx)}><div className={`w-full h-10 px-3 border-2 rounded-xl flex items-center bg-slate-50 cursor-pointer hover:bg-white hover:border-${stepColors[2]}-300 transition-colors`}>{dx.desc ? <span className="text-xs font-bold text-slate-700 truncate uppercase">{dx.desc}</span> : <span className="text-xs text-slate-400 italic">Clic para buscar diagn√≥stico...</span>}</div></div>
                        <div className="col-span-1 flex justify-center"><div className={`w-12 h-12 rounded-xl flex items-center justify-center font-black text-base text-white shadow-sm ${dx.tipo === 'P' ?
                        'bg-amber-500' : dx.tipo === 'D' ? 'bg-blue-600' : dx.tipo === 'R' ? 'bg-emerald-500' : 'bg-slate-300'}`}>{dx.tipo}</div></div>
                        <div className="col-span-2 flex gap-2 justify-center">{[dx.lab1, dx.lab2, dx.lab3].map((l, i) => ( <div key={i} className="w-12 h-12 bg-slate-50 border-2 border-slate-200 rounded-xl flex items-center justify-center text-sm font-bold text-slate-700">{l || '-'}</div> ))}</div>
                        <div className="col-span-2 flex justify-center items-center gap-2 relative">
                            <div className="font-black text-slate-800 text-sm bg-slate-100 px-3 py-2 rounded-lg min-w-[60px] text-center">{dx.codigo || '---'}</div>
                            {showAddButton && ( <button onClick={addDx} title="Agregar siguiente fila" className="w-8 h-8 bg-blue-100 text-blue-600 hover:bg-blue-600 hover:text-white rounded-full flex items-center justify-center transition-colors shadow-sm animate-in zoom-in"><Plus size={16} strokeWidth={3} /></button> )}
                            <button onClick={(e) => { e.stopPropagation();
                            removeDx(idx); }} className="absolute -right-2 top-2 text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={16}/></button>
                          </div>
                       </div>
                    )})}
                    <div ref={dxBottomRef} className="h-24 w-full bg-transparent"></div>
                  </div>
                </div>
              )}

              {/* PASO 4: EXCEL PREVIEW */}
              {step === 4 && (
                <div className="w-full h-full bg-white flex flex-col animate-in fade-in zoom-in duration-300 font-sans">
                  {/* BARRA SUPERIOR VERDE EXCEL */}
                  <div className="h-10 bg-[#107C41] flex items-center px-4 justify-between shrink-0 shadow-md z-10">
                    <div className="flex items-center gap-4 text-white text-xs font-bold">
                        <FileSpreadsheet size={18} />
                      <span>VISTA PREVIA DEL HIS (OFICIAL)</span>
                      <span className="opacity-50">|</span>
                      <span>{adminData.establecimiento} - {adminData.mes}</span>
                  </div>
                  </div>

                  {/* BARRA DE HERRAMIENTAS GRIS */}
                  <div className="h-10 bg-[#F3F3F3] border-b border-[#E1E1E1] flex items-center px-4 gap-4 shrink-0 text-xs text-slate-600">
                      <div className="flex items-center gap-2"><Grid size={14}/> <span>Vista de Dise√±o</span></div>
                      <div className="h-4 w-[1px] bg-slate-300"></div>
                      <span className="font-mono text-[11px] text-slate-500 font-bold">fx: {patientData.paciente || "SIN_DATOS"}</span>
                  </div>

                  {/* CONTENEDOR DE LA TABLA (SCROLL) */}
                  <div className="flex-1 overflow-auto bg-[#E6E6E6] p-4">
                    <div className="bg-white shadow-xl mx-auto min-w-[1400px] max-w-[1600px] border border-slate-300">
                      
                      {/* --- ENCABEZADOS DE COLUMNA (A, B, C...) --- */}
                      <div className="flex border-b border-slate-300 bg-[#F8F9FA]">
                        <div className="w-9 border-r border-slate-300 bg-slate-100"></div> {/* Nro Fila */}
                        {['D√çA','DNI','FIN','DISTRITO','EDAD','SEX','TALLA','PESO','O.ANT','HB','EST','SER','DIAGN√ìSTICO','TIPO','LAB','LAB','LAB','CIE'].map((h, i) => (
                            <div key={i} className={`flex items-center justify-center font-bold text-[10px] text-slate-700 py-1.5 border-r border-slate-300 ${i===3 || i===12 ? 'flex-1' : 'w-12'} ${i===12 ? 'min-w-[200px]' : ''}`}>
                             {h}
                            </div>
                        ))}
                      </div>

                      {/* --- CUERPO DE LA TABLA --- */}
                      <div className="flex flex-col">
                        {consolidatedPatients.length === 0 ?
                        (
                            <div className="p-10 text-center text-slate-400 font-bold">NO HAY DATOS PARA MOSTRAR</div>
                        ) : (
                            consolidatedPatients.map((rec, idx) => {
                                const p = rec.patient; 
                                const c = rec.clinical; 
                                const dxs = rec.diagnoses; 
                                const a = rec.ageObj;
                                const totalDxs = Math.max(1, dxs.length); 
                                const chunks = []; 
                                for (let i = 0; i < totalDxs; i += 3) { chunks.push(dxs.slice(i, i + 3)); }
                                if (chunks.length === 0) chunks.push([{},{},{}]);

                                return chunks.map((chunk, chunkIdx) => {
                                    while(chunk.length < 3) chunk.push({}); 
                                    const isFirst = chunkIdx === 0; 

                                    return (
                                            <div key={`${idx}-${chunkIdx}`} className="flex border-b border-slate-300 hover:bg-blue-50 transition-colors group">
                                            
                                                {/* COLUMNA: N√öMERO DE FILA */}
                                                <div className="w-9 bg-[#F8F9FA] border-r border-slate-300 flex items-center justify-center text-[11px] font-bold text-slate-600">
                                                    {visualBlockIndex++}
                                                </div>

                                                {/* COLUMNA 1: D√çA */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[11px] text-slate-800">
                                                    {isFirst ?
                                                    (p.fecAtencion || "").split('-')[2] : ""}
                                                </div>

                                                {/* COLUMNA 2: DNI */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[10px] font-bold truncate px-1 text-slate-900">
                                                    {isFirst ? p.dni : ""}
                                                </div>

                                                {/* COLUMNA 3: FINANCIADOR */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[11px] text-slate-800">
                                                    {isFirst ?
                                                    (p.financiador === 'SIS' ? '2' : '1') : ""}
                                                </div>

                                                {/* COLUMNA 4: DISTRITO */}
                                                <div className="flex-1 border-r border-slate-300 flex items-center px-1 text-[10px] truncate text-slate-700">
                                                    {isFirst ? p.distrito : ""}
                                                </div>

                                                {/* COLUMNA 5: EDAD */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[11px] font-bold text-slate-800">
                                                    {isFirst ?
                                                    (a.y > 0 ? a.y : a.m > 0 ? a.m + 'm' : a.d + 'd') : ""}
                                                </div>

                                                {/* COLUMNA 6: SEXO */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[11px] text-slate-800">
                                                    {isFirst ? p.sexo : ""}
                                                </div>

                                                {/* COLUMNAS 7-10: DATOS CL√çNICOS (VERTICAL) - AUMENTADO A 10PX */}
                                                <div className="w-12 border-r border-slate-300 flex flex-col justify-center text-[10px] text-center gap-1 py-1 text-slate-600">
                                                    {isFirst && c.talla && <div>T:{c.talla}</div>}
                                                </div>
                                                <div className="w-12 border-r border-slate-300 flex flex-col justify-center text-[10px] text-center gap-1 py-1 text-slate-600">
                                                    {isFirst && c.peso && <div>P:{c.peso}</div>}
                                                </div>
                                                <div className="w-12 border-r border-slate-300 flex flex-col justify-center text-[10px] text-center gap-1 py-1 text-slate-600">
                                                    {isFirst && c.pCef && <div>PC:{c.pCef}</div>}
                                                    {isFirst && c.pAbd && <div>PA:{c.pAbd}</div>}
                                                </div>
                                                <div className="w-12 border-r border-slate-300 flex flex-col justify-center text-[10px] text-center gap-1 py-1 bg-slate-50 text-slate-800">
 {isFirst && c.hb && <div className="font-bold">Hb:{c.hb}</div>}
                                                </div>

                                                {/* COLUMNA 11: EST */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[11px] text-slate-800">
                                                    {isFirst ? p.condEst : ""}
                                                </div>

                                                {/* COLUMNA 12: SERV */}
                                                <div className="w-12 border-r border-slate-300 flex items-center justify-center text-[11px] text-slate-800">
                                                    {isFirst ? p.condServ : ""}
                                                </div>

                                                {/* --- ZONA DE DIAGN√ìSTICOS (3 FILAS INTERNAS) --- */}
                                                <div className="flex-[3] flex flex-col min-w-[300px]">
                                                    {chunk.map((d, i) => (
                                                        <div key={i} className="flex h-7 border-b border-slate-200 last:border-0 items-center">
                                                            {/* Descripci√≥n */}
                                                            <div className="flex-1 border-r border-slate-200 px-2 text-[10px] truncate font-bold text-slate-700 uppercase" title={d.desc}>
                                                                {d.desc}
                                                            </div>
                                                            {/* Tipo */}
                                                            <div className="w-12 border-r border-slate-200 text-center text-[10px] text-slate-600">
                                                                {d.tipo}
                                                            </div>
                                                            {/* Labs */}
                                                            <div className="w-12 border-r border-slate-200 text-center text-[10px] text-slate-600 font-medium">{d.lab1}</div>
                                                            <div className="w-12 border-r border-slate-200 text-center text-[10px] text-slate-600 font-medium">{d.lab2}</div>
                                                            <div className="w-12 border-r border-slate-200 text-center text-[10px] text-slate-600 font-medium">{d.lab3}</div>
                                                            {/* CIE */}
                                                            <div className="w-12 text-center text-[10px] font-black text-slate-900 bg-slate-50">
                                                                {d.codigo}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                          </div>
                                    );
                                });
                            })
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}
           </div>

            {/* PIE DE P√ÅGINA (FOOTER) */}
            {/* PIE DE P√ÅGINA (FOOTER) */}
      <div className="bg-white p-6 border-t border-slate-100 flex justify-between items-center shrink-0">
        
        {/* BOT√ìN IZQUIERDO (ATR√ÅS / SALIR) */}
        {step > 1 ? (
          <button 
            onClick={handleBack} 
            className="px-6 py-2 rounded-xl hover:bg-slate-50 text-slate-500 font-bold flex gap-2 transition-all hover:text-slate-800 text-xs h-10 items-center"
          >
            <ArrowLeft size={18} /> Atr√°s
          </button>
        ) : (
          <button 
            onClick={() => { 
              if (window.confirm("¬øEst√° seguro de volver al men√∫ principal? Se perder√°n los datos actuales.")) { 
                setIsModalOpen(false); 
                resetForm(); 
              } 
            }} 
            className="px-6 py-2 rounded-xl hover:bg-red-50 text-slate-400 hover:text-red-600 font-bold flex gap-2 transition-all text-xs h-10 items-center border border-transparent hover:border-red-100"
          >
            <LogOut size={18} /> IR A SEGUIMIENTO
          </button>
        )}

        {/* BOTONES DERECHOS (ACCIONES PRINCIPALES) */}
        <div className="flex gap-3">
          {/* L√ìGICA DEL PASO 4: FLUJO DE CIERRE DE LOTE */}
          {step === 4 && (
            <>
              {/* CASO A: A√öN NO SE HA TERMINADO EL LOTE (isBatchFinished = false) */}
              {!isBatchFinished ? (
                <>
                  <button
                    onClick={() => { setStep(1); resetForm(); setTimeout(() => setIsCalendarOpen(true), 100); }}
                    className="px-6 py-2 rounded-xl font-bold shadow-lg flex gap-2 items-center transition-all text-xs h-10 bg-slate-100 hover:bg-slate-200 text-slate-700"
                  >
                    <UserPlus size={18} /> NUEVO PACIENTE
                  </button>

                  <button
                    onClick={() => setShowSaveConfirm(true)}
                    className="px-6 py-2 rounded-xl font-bold shadow-lg flex gap-2 items-center transition-all text-xs h-10 bg-blue-600 hover:bg-blue-700 text-white"
                  >
                    <SaveIcon size={18} /> GUARDAR PACIENTE
                  </button>

                  {/* BOT√ìN "TERMINAR": SOLO APARECE SI YA HAY AL MENOS 1 PACIENTE GUARDADO */}
                  {savedPatients.length > 0 && (
                    <button
                      onClick={() => setIsBatchFinished(true)}
                      className="px-6 py-2 rounded-xl font-bold shadow-lg flex gap-2 items-center transition-all text-xs h-10 bg-amber-500 hover:bg-amber-600 text-white animate-in fade-in slide-in-from-right-4"
                    >
                      <CheckCircle size={18} /> TERMINAR DIGITACI√ìN
                    </button>
                  )}
                </>
              ) : (
                /* CASO B: LOTE FINALIZADO (isBatchFinished = true) - MOSTRAR EXPORTACIONES */
                <>
                  <button
                    onClick={() => setIsBatchFinished(false)}
                    className="px-4 py-2 rounded-xl font-bold border-2 border-slate-200 text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all text-xs h-10 mr-2"
                    title="Volver a agregar m√°s pacientes"
                  >
                    ‚Ü© SEGUIR EDITANDO
                  </button>

                  {/* BOT√ìN EXPORTAR EXCEL - (Aqu√≠ estaba tu error principal, faltaba la etiqueta de apertura) */}
                  <button
                    onClick={generateExcel}
                    className="px-10 py-2 rounded-xl font-bold shadow-xl flex gap-2 items-center transition-all text-xs h-10 bg-emerald-600 hover:bg-emerald-700 text-white hover:-translate-y-1 animate-in zoom-in"
                  >
                    <Download size={20} /> EXPORTAR EXCEL ({savedPatients.filter(p => p.patient.paciente).length})
                  </button>

                  {/* BOT√ìN EXPORTAR PDF */}
                  <button
                    onClick={generatePDF}
                    className="px-6 py-2 rounded-xl font-bold shadow-xl flex gap-2 items-center transition-all text-xs h-10 bg-red-600 hover:bg-red-700 text-white hover:-translate-y-1 ml-2 animate-in zoom-in"
                  >
                    <FileText size={20} /> EXPORTAR PDF ({savedPatients.filter(p => p.patient.paciente).length})
                  </button>
                </>
              )}
            </>
          )}

          {/* BOT√ìN SIGUIENTE (VISUALIZAR EN PASOS 1, 2 Y 3) */}
          {step < 4 && (
            <button 
              onClick={handleNextStep} 
              className="bg-[#0F172A] hover:bg-slate-800 text-white px-8 py-2 rounded-xl font-bold shadow-xl flex gap-2 items-center transition-all hover:translate-x-1 hover:shadow-2xl text-xs h-10"
            >
              Siguiente <ArrowRight size={18} />
            </button>
          )}
        </div>
      </div>
          </div>
        )}
      </div>

      {/* --- MODAL DE DIAGN√ìSTICOS (CIE-10) --- */}
      {isDxModalOpen && (
        <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-7xl overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
                <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 shrink-0">
                    <div><h3 className="text-xl font-extrabold text-slate-800">Buscar Diagn√≥stico</h3><p className="text-xs text-slate-400 font-bold uppercase mt-1">Editando Fila {currentDxRow + 1} de {diagnoses.length}</p></div>
                    <button onClick={() => setIsDxModalOpen(false)} className="bg-white p-2 rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 transition-all shadow-sm border border-slate-100"><X size={24}/></button>
                </div>
                <div className="p-8 space-y-6 overflow-y-auto flex-1">
                    <div className="flex flex-col gap-4">
                        <div className="flex gap-4 items-center">
                            <div className="flex gap-2 shrink-0">
                                {['P', 'D', 'R'].map(type => (
                                    <button key={type} onClick={() => setTempDx({...tempDx, tipo: type})} className={`w-12 h-12 rounded-2xl font-black text-lg shadow-sm border-2 transition-all ${tempDx.tipo === type ? (type === 'P' ? 'bg-amber-100 border-amber-500 text-amber-600' : type === 'D' ? 'bg-blue-100 border-blue-600 text-blue-700' : 'bg-emerald-100 border-emerald-500 text-emerald-700') : 'bg-white border-slate-200 text-slate-300 hover:border-slate-300'}`}>{type}</button>
                                ))}
                            </div>
                            <div className="flex-1 relative">
                                <input autoFocus value={modalSearchTerm} onChange={(e) => handleModalSearch(e.target.value)} placeholder="Escribe c√≥digo o descripci√≥n..." className="w-full h-12 pl-4 pr-4 rounded-xl border-2 border-slate-300 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none font-bold text-slate-700 uppercase transition-all" />
                                {modalSuggestions.length > 0 && (
                                    <div className="absolute top-14 left-0 w-full bg-white rounded-2xl shadow-2xl border border-slate-200 max-h-64 overflow-y-auto z-50 p-2 no-scrollbar">
                                        {modalSuggestions.map((item, i) => ( <div key={i} onClick={() => selectModalDx(item)} className="p-3 hover:bg-blue-50 rounded-xl cursor-pointer flex flex-col group border-b border-slate-50 last:border-0"> <div className="font-black text-blue-600 text-sm">{item.CODIGO}</div> <div className="text-xs font-bold text-slate-600 group-hover:text-blue-800">{item.DESCRIPCION}</div> </div> ))}
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-2 shrink-0">
                                {[1, 2, 3].map(n => (
                                    <input key={n} maxLength={3} placeholder="LAB" value={tempDx[`lab${n}`]} onChange={(e) => setTempDx({...tempDx, [`lab${n}`]: e.target.value.toUpperCase()})} className="w-24 h-16 rounded-xl border-2 border-slate-200 text-center font-bold text-slate-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none uppercase text-xl placeholder-slate-300 transition-all" />
                                ))}
                            </div>
                        </div>
                        <div className="bg-blue-50/50 rounded-2xl p-4 border border-blue-100 flex items-center justify-between">
                             <div className="flex items-center gap-4"> <div className="bg-white px-4 py-2 rounded-lg shadow-sm border border-blue-100 font-black text-blue-600 text-xl">{tempDx.codigo || '---'}</div> <div className="flex flex-col"> <span className="text-[10px] text-blue-400 font-bold uppercase tracking-wider">Diagn√≥stico Seleccionado</span> <span className="font-bold text-slate-700 text-sm line-clamp-1">{tempDx.desc || 'Ninguno seleccionado'}</span> </div> </div>
                             <div className="text-right"> <span className="block text-[10px] text-slate-400 font-bold uppercase">Tipo</span> <span className={`font-black text-lg ${tempDx.tipo === 'P' ? 'text-amber-500' : tempDx.tipo === 'D' ? 'text-blue-600' : 'text-emerald-500'}`}>{tempDx.tipo === 'P' ? 'PRESUNTIVO' : tempDx.tipo === 'D' ? 'DEFINITIVO' : 'REPETIDO'}</span> </div>
                        </div>
                    </div>
                </div>
                <div className="px-8 py-5 bg-slate-50 border-t border-slate-100 flex justify-end gap-3 shrink-0">
                    <button onClick={() => setIsDxModalOpen(false)} className="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors text-sm">Cerrar</button>
                    <button onClick={saveModalSelection} className="px-8 py-3 rounded-xl font-bold bg-emerald-500 hover:bg-emerald-600 text-white shadow-lg shadow-emerald-200 hover:translate-y-[-2px] transition-all text-sm flex items-center gap-2"><Save size={18}/> GUARDAR SELECCI√ìN</button>
                </div>
            </div>
        </div>
      )}

      {/* --- CALENDARIO FLOTANTE (FIXED) --- */}
      {isCalendarOpen && (
        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={() => setIsCalendarOpen(false)}>
            <div ref={calendarRef} onClick={(e) => e.stopPropagation()}>
                <SimpleCalendar selectedDate={patientData.fecAtencion} onSelectDate={handleDateSelect} onClose={() => setIsCalendarOpen(false)} themeColor="blue" />
            </div>
        </div>
      )}

      {/* --- ALERTA DE CONFIRMACI√ìN DE GUARDADO --- */}
      {showSaveConfirm && (
        <div className="fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md border-2 border-orange-300 overflow-hidden animate-in zoom-in duration-300">
                <div className="bg-orange-50 p-6 border-b border-orange-100 flex flex-col items-center text-center gap-3">
                    <div className="bg-orange-100 p-3 rounded-full text-orange-600 mb-1"> <AlertTriangle size={32} strokeWidth={2.5}/> </div>
                    <h3 className="text-xl font-black text-orange-900 uppercase leading-tight">Antes de Guardar</h3>
                    <p className="text-sm font-bold text-orange-700">POR FAVOR VERIFIQUE LA INFORMACI√ìN</p>
                </div>
                <div className="p-6 bg-white space-y-3">
                    <button onClick={handleReviewInfo} className="w-full py-3.5 rounded-xl border-2 border-slate-200 text-slate-600 font-extrabold hover:bg-slate-50 hover:text-slate-800 hover:border-slate-300 transition-all flex items-center justify-center gap-2 text-sm"> <Eye size={18}/> REVISAR LA INFORMACI√ìN </button>
                    <button onClick={confirmSavePatient} className="w-full py-3.5 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 text-sm transform hover:scale-[1.02]"> <SaveIcon size={18}/> S√ç, DESEO GUARDAR </button>
                </div>
                <div className="bg-slate-50 p-3 text-center"> <button onClick={() => setShowSaveConfirm(false)} className="text-[10px] font-bold text-slate-400 hover:text-slate-600 underline">Cancelar operaci√≥n</button> </div>
            </div>
        </div>
      )}

      {/* --- OTROS MODALES --- */}
      <AnemiaCalculatorModal isOpen={showAnemiaModal} onClose={() => setShowAnemiaModal(false)} initialData={{ fecNac: patientData.fecNac, fecAtencion: patientData.fecAtencion }} />
      <NutritionalStatusModal isOpen={showNutriModal} onClose={() => setShowNutriModal(false)} />
      <CredFollowUpModal isOpen={showCredModal} onClose={() => setShowCredModal(false)} />
      {/* MODAL DE SEGUIMIENTO INDIVIDUAL */}
{selectedGestanteForModal && (
    <SeguimientoIndividualModal 
       paciente={selectedGestanteForModal} 
       onClose={() => setSelectedGestanteForModal(null)} 
    />
)}
      <style>{` .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; } input[type="date"]::-webkit-calendar-picker-indicator { opacity: 1; display: block; width: 1em; height: 1em; position: absolute; top: 50%; right: 12px; transform: translateY(-50%); color: #475569; cursor: pointer; } input[type="date"] { text-align: center; padding-left: 0.5rem; padding-right: 2.5rem; } `}</style>
    </div>
  );
}